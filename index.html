<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<link rel="icon" type="image/svg+xml" href="win12-icon.svg">
<script src="https://unpkg.com/dom-to-image-more@3.4.3/dist/dom-to-image-more.min.js"></script>
<title>Win12 Simulator – Browser OS</title>
<!-- Primary Metadata -->
<meta name="description" content="A fully interactive Advanced WebOS simulation built by Alaric Holt. Experience windows, apps, widgets, themes, and system tools in a single-file operating system.">
<meta name="author" content="Alaric Holt">
<meta name="keywords" content="Win12 Simulator, WebOS, Alaric Holt, Windows Simulator, Online OS, Browser OS, Win12, Operating System Simulation">

<!-- Canonical Identity -->
<link rel="canonical" href="https://alaricholt677.github.io/">

<!-- OpenGraph (Social + Bing Preview) -->
<meta property="og:title" content="Win12 Simulator — WebOS by Alaric Holt">
<meta property="og:description" content="A subsystem-complete WebOS simulation running entirely in your browser. Built as a single-file OS with apps, widgets, themes, and system tools.">
<meta property="og:url" content="https://alaricholt677.github.io/">
<meta property="og:type" content="website">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Win12 Simulator — WebOS by Alaric Holt">
<meta name="twitter:description" content="A fully interactive WebOS simulation built as a single-file operating system.">

<!-- Robots -->
<meta name="robots" content="index, follow">
<meta name="googlebot" content="index, follow">
<meta name="bingbot" content="index, follow">
  
<!-- Manifest -->
<link rel="manifest" href="/manifest.json">

<!-- Viewport + Charset -->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- JSON-LD Structured Data (Bing LOVES this) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "Win12 Simulator",
  "operatingSystem": "Web",
  "applicationCategory": "BrowserApplication",
  "creator": {
    "@type": "Person",
    "name": "Alaric Holt"
  },
  "description": "A subsystem-complete WebOS simulation built as a single-file operating system with apps, widgets, themes, and system tools.",
  "url": "https://alaricholt677.github.io/",
  "softwareVersion": "1.0"
}
</script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style id="base-style">
    :root {
      --accent: #4c8dff;
      --accent-soft: rgba(76, 141, 255, 0.22);
      --accent-strong: rgba(76, 141, 255, 0.94);
      --bg-main: radial-gradient(circle at 0% 0%, #16245a 0, #050813 45%, #02020a 100%);
      --glass-dark: rgba(8, 12, 28, 0.9);
      --border-glass: rgba(255, 255, 255, 0.1);
      --text-main: #f5f7ff;
      --text-soft: #c5cae6;
      --text-dim: #9ca3c7;
      --taskbar-height: 52px;
      --transition-fast: 140ms ease-out;
      --transition-med: 220ms ease-out;
      --font-ui: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    * { box-sizing: border-box; user-select: none; }
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      overflow: hidden;
      background: var(--bg-main);
      color: var(--text-main);
      font-family: var(--font-ui);
    }
    #theme-style {}

    .button-small{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.24);
      background:rgba(6,10,24,0.98);
      color:var(--text-main);
      font-size:11px;
      cursor:pointer;
      white-space:nowrap;
    }
    .button-small:hover{
      background:rgba(30,40,76,0.98);
      border-color:rgba(255,255,255,0.4);
    }

    /* login */
    #login-overlay {
      position: fixed; inset: 0;
      background:
        radial-gradient(circle at 10% 0%, rgba(76, 141, 255, 0.4), transparent 60%),
        radial-gradient(circle at 90% 100%, rgba(192, 96, 255, 0.35), transparent 60%),
        #050813;
      display: flex; align-items: center; justify-content: center;
      z-index: 2000;
      transition: opacity var(--transition-med), transform var(--transition-med);
    }
    #login-overlay.hidden { opacity:0;pointer-events:none;transform:scale(1.02); }
    .login-panel {
      width:min(420px,92vw);border-radius:22px;
      background:rgba(6,8,22,0.94);
      border:1px solid rgba(255,255,255,0.18);
      box-shadow:0 24px 60px rgba(0,0,0,0.9),0 0 0 1px rgba(76,141,255,0.4);
      padding:16px 18px 14px;
      backdrop-filter:blur(26px);-webkit-backdrop-filter:blur(26px);
    }
    .login-title{text-align:center;margin-bottom:8px;}
    .login-title h1{margin:0;font-size:20px;letter-spacing:0.16em;text-transform:uppercase;color:var(--text-soft);}
    .login-title h2{margin:2px 0 0;font-size:12px;color:var(--text-dim);letter-spacing:0.14em;text-transform:uppercase;}
    #user-list{
      margin-top:10px;border-radius:14px;
      background:rgba(12,16,40,0.98);
      border:1px solid rgba(255,255,255,0.12);
      padding:6px 6px 4px;max-height:200px;overflow:auto;
    }
    .user-row{
      display:flex;align-items:center;justify-content:space-between;
      padding:6px 8px;border-radius:10px;
      cursor:pointer;margin-bottom:4px;
      transition:background var(--transition-fast),transform var(--transition-fast),box-shadow var(--transition-fast);
    }
    .user-row:hover{
      background:rgba(30,40,70,0.95);
      box-shadow:0 10px 24px rgba(0,0,0,0.8);
      transform:translateY(-1px);
    }
    .user-info{display:flex;align-items:center;gap:8px;}
    .user-avatar{
      width:30px;height:30px;border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#fff,var(--accent));
      box-shadow:0 6px 14px rgba(0,0,0,0.8);position:relative;
    }
    .user-avatar::after{
      content:"";position:absolute;inset:5px;border-radius:inherit;
      border:1px solid rgba(148,103,255,0.7);box-shadow:0 0 12px rgba(148,103,255,0.9);
    }
    .user-name{font-size:13px;}
    .user-meta{font-size:10px;color:var(--text-dim);}
    .user-actions{display:flex;align-items:center;gap:6px;}
    .pill-small{
      padding:2px 6px;border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      font-size:10px;color:var(--text-dim);
      background:rgba(5,8,22,0.98);
    }
    .pill-small.danger{border-color:rgba(255,77,106,0.8);color:#ffb3c1;}
    .login-form{margin-top:10px;display:flex;gap:6px;}
    .login-input{
      flex:1;padding:6px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(5,8,22,0.98);
      color:var(--text-main);font-size:12px;outline:none;
    }
    .login-button{
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--accent-strong);
      background:linear-gradient(to right,var(--accent),#9d72ff);
      color:#fff;font-size:12px;cursor:pointer;
      box-shadow:0 8px 20px rgba(0,0,0,0.9);
      transition:transform var(--transition-fast),box-shadow var(--transition-fast);
    }
    .login-button:hover{
      transform:translateY(-1px);
      box-shadow:0 0 16px rgba(76,141,255,0.8),0 12px 30px rgba(0,0,0,0.95);
    }
    .login-footer{
      margin-top:8px;font-size:10px;color:var(--text-dim);
      display:flex;justify-content:space-between;align-items:center;
    }

    /* desktop */
    #desktop{position:absolute;inset:0;padding-bottom:var(--taskbar-height);overflow:hidden;}
    .desktop-orbit{
      position:absolute;top:14%;left:50%;transform:translateX(-50%);
      width:380px;height:380px;border-radius:50%;
      border:1px solid rgba(255,255,255,0.12);opacity:0.3;
      box-shadow:0 0 30px rgba(76,141,255,0.6),0 0 80px rgba(106,63,181,0.7);
      backdrop-filter:blur(36px);-webkit-backdrop-filter:blur(36px);
    }
    .desktop-orbit::after{
      content:"";position:absolute;inset:30%;border-radius:inherit;
      border:1px dashed rgba(255,255,255,0.3);
      animation:orbitSpin 40s linear infinite;
    }
    @keyframes orbitSpin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
    .desktop-center{
      position:absolute;top:19%;left:50%;transform:translateX(-50%);
      text-align:center;text-shadow:0 12px 30px rgba(0,0,0,0.8);
    }
    .desktop-title{font-size:34px;font-weight:650;letter-spacing:0.12em;text-transform:uppercase;}
    .desktop-title span{color:var(--accent);}
    .desktop-sub{font-size:12px;letter-spacing:0.18em;text-transform:uppercase;color:var(--text-soft);margin-top:4px;}
    .desktop-desc{margin-top:10px;font-size:13px;color:var(--text-soft);}
    .desktop-aim-chip{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;margin-top:10px;border-radius:999px;
      background:radial-gradient(circle at 0 0,rgba(255,255,255,0.24),transparent 55%),rgba(7,10,30,0.95);
      border:1px solid rgba(255,255,255,0.2);
      font-size:10px;letter-spacing:0.14em;text-transform:uppercase;color:rgba(220,223,255,0.96);
    }
    .aim-dot{width:8px;height:8px;border-radius:999px;background:#61ffb4;box-shadow:0 0 12px #61ffb4;}
    #desktop-icons{position:absolute;top:18px;left:20px;display:flex;flex-direction:column;gap:4px;z-index:2;}
    .desktop-icon{
      width:180px;padding:4px 6px;border-radius:10px;
      display:flex;align-items:center;gap:8px;cursor:default;
      transition:background var(--transition-fast),transform var(--transition-fast),box-shadow var(--transition-fast);
    }
    .desktop-icon:hover{
      background:rgba(22,30,70,0.9);box-shadow:0 10px 24px rgba(0,0,0,0.7);transform:translateY(-1px);
    }
    .desktop-icon-thumb{
      width:30px;height:30px;border-radius:8px;
      background:radial-gradient(circle at 25% 20%,#fff,#4c8dff);
      box-shadow:0 8px 16px rgba(0,0,0,0.7);
    }
    .desktop-icon-label{font-size:11px;color:var(--text-main);text-shadow:0 1px 4px rgba(0,0,0,0.9);}
    .desktop-bottom-left{
      position:absolute;left:24px;bottom:calc(var(--taskbar-height)+16px);
      font-size:12px;color:var(--text-soft);
    }
    .desktop-bottom-left strong{color:var(--text-main);font-weight:600;}

    /* taskbar */
    #taskbar{
      position:absolute;left:0;right:0;bottom:0;height:var(--taskbar-height);
      background:linear-gradient(to top,rgba(4,6,18,0.98),rgba(4,6,18,0.9));
      border-top:1px solid rgba(255,255,255,0.08);
      display:flex;align-items:center;justify-content:space-between;
      padding:0 12px;box-shadow:0 -2px 10px rgba(0,0,0,0.8);
      backdrop-filter:blur(22px);-webkit-backdrop-filter:blur(22px);
      z-index:1000;
    }
    .taskbar-left,.taskbar-center,.taskbar-right{display:flex;align-items:center;gap:8px;}
    .taskbar-center{position:absolute;left:50%;transform:translateX(-50%);}
    .taskbar-button{
      width:36px;height:36px;border-radius:999px;
      border:1px solid transparent;background:transparent;
      display:flex;align-items:center;justify-content:center;
      color:var(--text-main);cursor:pointer;
      transition:background var(--transition-fast),border-color var(--transition-fast),transform var(--transition-fast),box-shadow var(--transition-fast);
    }
    .taskbar-button svg{width:18px;height:18px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.7));}
    .taskbar-button:hover{
      background:rgba(30,38,76,0.98);
      border-color:rgba(255,255,255,0.2);
      box-shadow:0 0 12px rgba(76,141,255,0.9);
      transform:translateY(-1px);
    }
    .taskbar-start-label{font-size:11px;letter-spacing:0.18em;text-transform:uppercase;color:var(--text-soft);margin-left:4px;}
    .taskbar-app-strip{
      display:inline-flex;align-items:center;gap:5px;
      background:rgba(10,12,32,0.98);
      border-radius:999px;padding:4px 10px;
      border:1px solid rgba(255,255,255,0.06);
      box-shadow:0 10px 26px rgba(0,0,0,0.9);
    }
    .taskbar-app{
      width:28px;height:28px;border-radius:10px;
      background:radial-gradient(circle at 25% 20%,#fff,#4c8dff);
      box-shadow:0 8px 18px rgba(0,0,0,0.9);
      border:1px solid rgba(255,255,255,0.4);
      cursor:pointer;
      transition:transform var(--transition-fast),box-shadow var(--transition-fast),border-color var(--transition-fast),opacity var(--transition-fast);
      opacity:0.9;
    }
    .taskbar-app:hover{transform:translateY(-1px) scale(1.03);box-shadow:0 10px 26px rgba(0,0,0,1);opacity:1;}
    .taskbar-right{display:flex;align-items:center;gap:8px;}
    .taskbar-import{
      padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,0.24);
      background:rgba(10,12,32,0.96);
      font-size:10px;color:var(--text-soft);
      cursor:pointer;display:flex;align-items:center;gap:4px;
    }
    .taskbar-user-pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      background:rgba(10,12,32,0.95);
      border:1px solid rgba(255,255,255,0.12);
      cursor:pointer;font-size:11px;color:var(--text-soft);
    }
    .user-avatar-small{
      width:18px;height:18px;border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#fff,#4c8dff);
      box-shadow:0 2px 6px rgba(0,0,0,0.9);
    }
    .taskbar-clock{
      position:relative;
      display:flex;flex-direction:column;align-items:flex-end;font-size:11px;color:var(--text-soft);min-width:76px;
      cursor:pointer;
    }
    .taskbar-clock-time{font-size:13px;color:var(--text-main);}
    .taskbar-notify{
      width:24px;height:24px;border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(4,6,18,0.96);
      box-shadow:0 4px 12px rgba(0,0,0,0.9);
      position:relative;
    }
    .taskbar-notify::after{
      content:"";position:absolute;top:4px;right:4px;
      width:6px;height:6px;border-radius:999px;
      background:var(--accent);box-shadow:0 0 12px var(--accent);
    }

    /* time flyout */
    #time-flyout {
      position:absolute;
      right:0;
      bottom:var(--taskbar-height);
      margin-right:8px;
      margin-bottom:8px;
      width:220px;
      background:rgba(8,10,26,0.98);
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.18);
      box-shadow:0 16px 40px rgba(0,0,0,0.9);
      padding:8px 10px;
      font-size:12px;
      display:none;
      z-index:1200;
      backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);
    }
    #time-flyout-time {
      font-size:20px;
      margin-bottom:4px;
    }
    #time-flyout-date {
      font-size:11px;
      color:var(--text-soft);
      margin-bottom:4px;
    }
    #time-flyout-greeting {
      font-size:11px;
      color:var(--text-dim);
    }

    /* start menu */
    #start-backdrop{
      position:absolute;inset:0;background:transparent;opacity:0;pointer-events:none;
      transition:opacity var(--transition-med);z-index:900;
    }
    #start-backdrop.visible{opacity:1;pointer-events:auto;}
    #start-menu{
      position:absolute;left:50%;bottom:var(--taskbar-height);
      transform:translateX(-50%) translateY(12px);
      width:min(780px,96vw);
      background:radial-gradient(circle at 0 0,rgba(255,255,255,0.16),transparent 55%),rgba(9,12,30,0.98);
      border-radius:22px;
      border:1px solid rgba(255,255,255,0.12);
      box-shadow:0 24px 60px rgba(0,0,0,0.95),0 0 0 1px rgba(255,255,255,0.16);
      padding:12px 16px 10px;
      opacity:0;pointer-events:none;
      display:flex;flex-direction:column;gap:8px;
      backdrop-filter:blur(30px);-webkit-backdrop-filter:blur(30px);
      z-index:950;
      transition:opacity var(--transition-med),transform var(--transition-med);
    }
    #start-menu.visible{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(-6px);}
    .start-header{display:flex;align-items:center;justify-content:space-between;}
    .start-header-left{display:flex;align-items:center;gap:10px;}
    .start-avatar{
      width:24px;height:24px;border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#fff,#4c8dff);
      box-shadow:0 4px 8px rgba(0,0,0,0.8);position:relative;
    }
    .start-avatar::after{
      content:"";position:absolute;inset:4px;border-radius:inherit;
      border:1px solid rgba(148,103,255,0.7);box-shadow:0 0 10px rgba(148,103,255,0.8);
    }
    .start-title-main{font-size:11px;letter-spacing:0.2em;text-transform:uppercase;color:var(--text-soft);}
    .start-title-sub{font-size:12px;color:var(--text-main);}
    .start-header-right{display:flex;align-items:center;gap:8px;font-size:10px;color:var(--text-soft);}
    .start-user-name{font-size:11px;color:var(--text-main);}
    .start-search{position:relative;margin-top:6px;}
    .start-search input{
      width:100%;padding:7px 9px 7px 30px;
      border-radius:999px;border:1px solid rgba(255,255,255,0.16);
      background:rgba(4,6,18,0.98);
      color:var(--text-main);font-size:12px;outline:none;
      box-shadow:0 8px 20px rgba(0,0,0,0.9);
    }
    .start-search-icon{
      position:absolute;left:10px;top:50%;transform:translateY(-50%);
      font-size:12px;color:var(--text-soft);
    }
    .start-main-grid{display:grid;grid-template-columns:1.4fr 1.1fr;gap:12px;margin-top:8px;}
    .start-section-title{font-size:11px;text-transform:uppercase;letter-spacing:0.16em;color:var(--text-soft);margin-bottom:5px;}
    .start-pinned-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:6px;}
    .start-app{
      padding:6px 6px 5px;border-radius:12px;
      background:rgba(11,14,32,0.96);
      border:1px solid rgba(255,255,255,0.06);
      box-shadow:0 8px 20px rgba(0,0,0,0.8);
      display:flex;flex-direction:column;align-items:center;gap:4px;
      cursor:pointer;font-size:11px;
      transition:transform var(--transition-fast),box-shadow var(--transition-fast),border-color var(--transition-fast),background var(--transition-fast);
    }
    .start-app:hover{
      background:radial-gradient(circle at 0 0,rgba(76,141,255,0.2),rgba(8,10,30,0.98));
      border-color:rgba(76,141,255,0.9);
      box-shadow:0 0 14px rgba(76,141,255,1),0 14px 30px rgba(0,0,0,1);
      transform:translateY(-2px);
    }
    .start-app-icon{
      width:26px;height:26px;border-radius:10px;
      background:radial-gradient(circle at 30% 20%,#fff,#4c8dff);
      box-shadow:0 6px 14px rgba(0,0,0,0.8);
    }
    .start-app-sub{font-size:9px;color:var(--text-soft);text-align:center;}
    .start-right-panel{
      border-radius:16px;background:rgba(8,10,30,0.98);
      border:1px solid rgba(255,255,255,0.08);
      box-shadow:0 10px 26px rgba(0,0,0,0.95);
      padding:8px 8px;display:flex;flex-direction:column;gap:6px;font-size:11px;
    }
    #rec-section{position:relative;}
    #rec-dropdown-toggle{
      padding:3px 6px;border-radius:999px;
      border:1px solid rgba(255,255,255,0.2);
      background:rgba(6,10,24,0.96);
      font-size:10px;color:var(--text-soft);
      cursor:pointer;display:inline-flex;align-items:center;gap:4px;
      margin-bottom:4px;
    }
    #rec-dropdown-menu{
      position:absolute;right:8px;top:24px;
      background:rgba(8,10,26,0.98);
      border-radius:8px;border:1px solid rgba(255,255,255,0.2);
      box-shadow:0 12px 26px rgba(0,0,0,0.95);
      padding:4px 0;display:none;z-index:960;
    }
    .rec-dropdown-item{padding:4px 8px;font-size:11px;cursor:pointer;color:var(--text-soft);}
    .rec-dropdown-item:hover{background:rgba(30,34,70,0.98);}
    .start-footer{
      margin-top:6px;padding-top:6px;
      border-top:1px solid rgba(255,255,255,0.08);
      display:flex;align-items:center;justify-content:space-between;
      font-size:10px;color:var(--text-soft);
    }
    .start-footer-aim{text-transform:uppercase;letter-spacing:0.18em;color:rgba(225,228,255,0.92);}

    /* window shell */
    .window{
      position:absolute;min-width:360px;max-width:900px;
      min-height:220px;max-height:540px;
      background:var(--glass-dark);
      border-radius:16px;border:1px solid var(--border-glass);
      box-shadow:0 22px 60px rgba(0,0,0,0.75);
      backdrop-filter:blur(26px);-webkit-backdrop-filter:blur(26px);
      display:flex;flex-direction:column;overflow:hidden;
      z-index:1100;opacity:0;transform:translateY(20px) scale(0.96);pointer-events:none;
      transition:opacity var(--transition-med),transform var(--transition-med);
    }
    .window.visible{opacity:1;transform:translateY(0) scale(1);pointer-events:auto;}
    .window.fullscreen{
      left:0 !important;
      top:0 !important;
      width:100% !important;
      height:calc(100% - var(--taskbar-height)) !important;
      border-radius:0 !important;
    }

    .window-header{
      height:34px;display:flex;align-items:center;justify-content:space-between;
      padding:0 10px;
      background:linear-gradient(to right,rgba(6,9,26,0.98),rgba(10,12,30,0.98));
      border-bottom:1px solid rgba(255,255,255,0.08);
      cursor:move;position:relative;
    }
    .window-title{display:flex;align-items:center;gap:7px;font-size:12px;}
    .window-title-icon{
      width:16px;height:16px;border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#fff,#4c8dff);
      box-shadow:0 3px 8px rgba(0,0,0,0.9);
    }
    .window-title-text{display:flex;flex-direction:column;gap:1px;}
    .window-title-main{font-size:12px;}
    .window-title-sub{font-size:10px;color:var(--text-soft);}
    .window-fullscreen-toggle{
      width:20px;height:16px;border-radius:4px;
      border:1px solid rgba(255,255,255,0.4);
      font-size:10px;
      display:flex;align-items:center;justify-content:center;
      margin-left:6px;
      cursor:pointer;
      color:var(--text-soft);
      background:rgba(4,6,18,0.96);
      transition:background var(--transition-fast),transform var(--transition-fast),box-shadow var(--transition-fast);
    }
    .window-fullscreen-toggle:hover{
      background:rgba(76,141,255,0.4);
      box-shadow:0 0 8px rgba(76,141,255,0.9);
      transform:translateY(-1px);
    }
    .window-info-icon{
      width:16px;height:16px;border-radius:999px;
      border:1px solid rgba(255,255,255,0.4);
      color:var(--text-soft);
      display:flex;align-items:center;justify-content:center;
      font-size:11px;cursor:pointer;margin-left:6px;
    }
    .window-info-tooltip{
      position:absolute;left:10px;top:-6px;transform:translateY(-100%);
      background:rgba(8,10,26,0.98);
      border-radius:8px;border:1px solid rgba(255,255,255,0.18);
      padding:6px 8px;font-size:11px;color:var(--text-soft);
      box-shadow:0 10px 24px rgba(0,0,0,0.9);
      display:none;max-width:280px;
    }
    .window-controls{display:flex;align-items:center;gap:4px;}
    .window-btn{
      width:20px;height:20px;border-radius:999px;
      border:1px solid rgba(255,255,255,0.24);
      background:rgba(4,6,18,0.96);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      transition:background var(--transition-fast),transform var(--transition-fast),box-shadow var(--transition-fast),border-color var(--transition-fast);
    }
    .window-btn:hover{transform:translateY(-1px);box-shadow:0 0 10px rgba(255,255,255,0.4);}
    .window-btn.close:hover{border-color:#ff5573;background:rgba(80,16,30,0.96);box-shadow:0 0 12px rgba(255,85,115,1);}
    .window-btn-icon{width:10px;height:10px;position:relative;}
    .window-btn.minimize .window-btn-icon::before{
      content:"";position:absolute;left:2px;right:2px;bottom:2px;height:2px;border-radius:2px;background:#f5f7ff;
    }
    .window-btn.close .window-btn-icon::before,
    .window-btn.close .window-btn-icon::after{
      content:"";position:absolute;left:2px;right:2px;top:50%;height:2px;border-radius:2px;background:#f5f7ff;transform-origin:center;
    }
    .window-btn.close .window-btn-icon::before{transform:translateY(-50%) rotate(45deg);}
    .window-btn.close .window-btn-icon::after{transform:translateY(-50%) rotate(-45deg);}
    .window-body{
      flex:1;padding:10px 12px 10px;
      background:
        radial-gradient(circle at 0 0,rgba(255,255,255,0.08),transparent 60%),
        radial-gradient(circle at 100% 100%,rgba(76,141,255,0.1),transparent 60%),
        rgba(6,9,26,0.98);
      overflow:auto;font-size:13px;color:var(--text-main);
    }
    .window-body::-webkit-scrollbar{width:7px;}
    .window-body::-webkit-scrollbar-thumb{background:rgba(76,141,255,0.9);border-radius:999px;}

    .notes-area{
      width:100%;min-height:180px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(4,6,20,0.98);
      color:var(--text-main);
      font-family:var(--font-ui);
      font-size:13px;padding:8px;resize:vertical;outline:none;
    }
    .notes-footer{margin-top:6px;font-size:11px;color:var(--text-dim);display:flex;justify-content:space-between;}

    .fs-list{
      margin-top:4px;border-radius:10px;
      background:rgba(8,10,26,0.98);
      border:1px solid rgba(255,255,255,0.12);
      padding:6px;font-size:12px;
    }
    .fs-row{
      display:flex;justify-content:space-between;
      padding:4px 4px;border-radius:6px;color:var(--text-soft);
    }
    .fs-row:nth-child(odd){background:rgba(14,18,40,0.98);}
    .fs-row-name{font-family:"Cascadia Code",monospace;font-size:11px;}
    .fs-row-meta{font-size:10px;color:var(--text-dim);}

    .ai-log{
      border-radius:10px;background:rgba(4,6,20,0.98);
      border:1px solid rgba(255,255,255,0.18);
      padding:8px;max-height:220px;overflow:auto;font-size:12px;
    }
    .ai-message{margin-bottom:6px;}
    .ai-message-role{font-size:10px;text-transform:uppercase;letter-spacing:0.16em;color:var(--text-dim);margin-bottom:2px;}
    .ai-message-user{color:#ffd18a;}
    .ai-message-aim{color:#c4f0ff;}
    .ai-input-row{margin-top:6px;display:flex;gap:6px;}
    .ai-input{
      flex:1;padding:5px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(2,4,14,0.98);
      color:var(--text-main);font-size:12px;outline:none;
    }

    .ctx-menu{
      position:fixed;min-width:210px;
      background:rgba(8,10,26,0.98);
      border-radius:10px;border:1px solid rgba(255,255,255,0.16);
      box-shadow:0 14px 32px rgba(0,0,0,0.9);
      padding:4px 0;font-size:12px;color:var(--text-main);
      z-index:1600;display:none;
    }
    .ctx-item{
      padding:5px 10px;display:flex;align-items:center;justify-content:space-between;
      cursor:pointer;transition:background var(--transition-fast),color var(--transition-fast);
    }
    .ctx-item.disabled{opacity:0.4;pointer-events:none;}
    .ctx-item:hover{background:rgba(30,36,70,0.98);}
    .ctx-separator{border-top:1px solid rgba(255,255,255,0.12);margin:4px 0;}

    #admin-popup-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,0.65);
      display:none;align-items:center;justify-content:center;
      z-index:1700;
      backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
    }
    #admin-popup{
      width:min(320px,92vw);border-radius:16px;
      background:rgba(8,10,26,0.98);
      border:1px solid rgba(255,255,255,0.18);
      box-shadow:0 20px 50px rgba(0,0,0,0.95);
      padding:10px 12px;font-size:12px;
    }
    #admin-popup-title{font-size:13px;margin-bottom:4px;font-weight:600;}
    #admin-popup-buttons{margin-top:8px;display:flex;justify-content:flex-end;gap:6px;}
    .admin-btn{
      padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,0.24);
      background:rgba(6,10,24,0.98);
      color:var(--text-main);font-size:11px;cursor:pointer;
    }
    .admin-btn.primary{
      border-color:var(--accent-strong);
      background:linear-gradient(to right,var(--accent),#8f6bff);
    }

   #camera-popup-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,0.65);
      display:none;align-items:center;justify-content:center;
      z-index:1700;
      backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
    }
    #camera-popup{
      width:min(320px,92vw);border-radius:16px;
      background:rgba(8,10,26,0.98);
      border:1px solid rgba(255,255,255,0.18);
      box-shadow:0 20px 50px rgba(0,0,0,0.95);
      padding:10px 12px;font-size:12px;
    }
    #camera-popup-title{font-size:13px;margin-bottom:4px;font-weight:600;}
    #camera-popup-buttons{margin-top:8px;display:flex;justify-content:flex-end;gap:6px;}
    .dev-banner{
      position:fixed;top:8px;right:12px;
      padding:4px 8px;background:rgba(0,0,0,0.82);
      color:#55ffb4;font-family:"Cascadia Code",monospace;
      font-size:11px;border-radius:999px;
      border:1px solid rgba(85,255,180,0.6);
      box-shadow:0 0 14px rgba(0,0,0,0.8);
      opacity:0;transform:translateY(-10px);pointer-events:none;
      transition:opacity 160ms ease-out,transform 160ms ease-out;
      z-index:1500;
    }
    .dev-banner.visible{opacity:1;transform:translateY(0);pointer-events:auto;}

    @media(max-width:800px){
      .desktop-center,.desktop-orbit{display:none;}
      .window{min-width:92vw;}
      .start-main-grid{grid-template-columns:1fr;}
    }
    @media(max-width:540px){
      #desktop-icons{transform:scale(0.9);transform-origin:top left;}
    }

    /* Paint canvas and toolbar */
    .paint-toolbar{
      display:flex;gap:6px;align-items:center;
      margin-bottom:6px;font-size:11px;color:var(--text-soft);
    }
    .paint-toolbar input[type="color"]{
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(4,6,18,0.98);
      width:32px;height:20px;padding:0;
    }
    .paint-canvas-wrap{
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(4,6,20,0.98);
      overflow:hidden;
    }
    .paint-canvas-wrap canvas{
      display:block;
      background:#0b1020;
      cursor:crosshair;
    }

    /* Media player */
    .media-controls{
      display:flex;gap:6px;align-items:center;
      margin-bottom:6px;font-size:11px;color:var(--text-soft);
    }
    .media-surface{
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(4,6,20,0.98);
      min-height:220px;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .media-surface video,
    .media-surface audio,
    .media-surface img{
      max-width:100%;
      max-height:100%;
    }
    /* === OVERLAY === */
#widgets-editor-overlay {
  position: fixed;
  inset: 0;
  backdrop-filter: blur(12px);
  background: rgba(0,0,0,0.25);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 5000;
}

#widgets-editor-overlay.hidden {
  display: none;
}

/* === PANEL === */
.widgets-editor-panel {
  width: 600px;
  height: 420px;
  background: var(--win12-surface);
  border: 1px solid var(--win12-border);
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* === HEADER === */
.widgets-editor-header {
  padding: 10px 14px;
  background: var(--win12-surface-2);
  border-bottom: 1px solid var(--win12-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
}

/* === CONTROLS === */
.widgets-editor-controls {
  padding: 10px 14px;
  background: var(--win12-surface);
  border-bottom: 1px solid var(--win12-border);
  display: flex;
  gap: 10px;
  align-items: center;
}

.widgets-editor-controls select,
.widgets-editor-controls button {
  padding: 6px 10px;
  border-radius: 4px;
  border: 1px solid var(--win12-border);
  background: var(--win12-surface-2);
  cursor: pointer;
}

/* === CANVAS (widgets inside editor) === */
#widgets-editor-canvas {
  flex: 1;
  position: relative;
  background: var(--win12-surface-1);
  overflow: hidden;
}

#desktop-widgets-layer {
  position: absolute;
  inset: 0;
  pointer-events: none; /* widgets handle their own events */
}

/* === WIDGET CONTAINER === */
.desktop-widget {
  position: absolute;
  width: 180px;
  background: var(--win12-surface);
  border: 1px solid var(--win12-border);
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  pointer-events: auto;
  overflow: hidden;
}

/* === HEADER === */
.desktop-widget-header {
  background: var(--win12-surface-2);
  padding: 6px 10px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--win12-border);
}

/* === CONTROLS === */
.desktop-widget-controls button {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0 4px;
  font-size: 14px;
  color: var(--win12-text);
}

.desktop-widget-controls button:hover {
  color: var(--win12-accent);
}

/* === BODY === */
.desktop-widget-body {
  padding: 10px;
  font-size: 14px;
  color: var(--win12-text);
}

/* === MINIMIZED STATE === */
.desktop-widget.minimized .desktop-widget-body {
  display: none;
}

    .desktop-widget,
.editor-widget {
  transition: box-shadow 0.2s, transform 0.2s;
}

.desktop-widget:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}

#ls-viewer {
  width: 100%;
  height: 100%;
  background: var(--win12-surface);
  border: 1px solid var(--win12-border);
  padding: 10px;
  overflow: auto;
  font-family: Consolas, monospace;
  font-size: 14px;
}

.ls-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  font-weight: bold;
}

.ls-node {
  margin-left: 20px;
  padding: 4px 0;
}

.ls-field {
  display: flex;
  gap: 6px;
  align-items: center;
}

.ls-field input {
  padding: 2px 4px;
  border: 1px solid var(--win12-border);
  background: var(--win12-surface-2);
  border-radius: 4px;
  font-family: inherit;
  font-size: 14px;
  width: 150px;
}

.ls-value {
  width: 200px !important;
}


.window {
  position: absolute;
  resize: none; /* We'll handle resizing manually */
  overflow: hidden;
}
.window-resize-handle {
  position: absolute;
  background: transparent;
  z-index: 10;
}
.resize-top, .resize-bottom {
  height: 6px;
  width: 100%;
  cursor: ns-resize;
}
.resize-left, .resize-right {
  width: 6px;
  height: 100%;
  cursor: ew-resize;
}
.resize-top { top: 0; left: 0; }
.resize-bottom { bottom: 0; left: 0; }
.resize-left { top: 0; left: 0; }
.resize-right { top: 0; right: 0; }
.resize-corner {
  width: 10px;
  height: 10px;
  position: absolute;
  background: transparent;
}
.resize-tl { top: 0; left: 0; cursor: nwse-resize; }
.resize-tr { top: 0; right: 0; cursor: nesw-resize; }
.resize-bl { bottom: 0; left: 0; cursor: nesw-resize; }
.resize-br { bottom: 0; right: 0; cursor: nwse-resize; }

.taskbar-network svg {
  stroke: var(--text-main);
}
.taskbar-network:hover svg {
  stroke: var(--accent);
}

    
#search-panel {
  position: fixed;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  width: 360px;
  background: rgba(8,11,30,0.98);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.2);
  display: none;
  flex-direction: column;
  z-index: 1500;
}
#search-panel.visible {
  display: flex;
}
#search-results div:hover {
  background: rgba(255,255,255,0.08);
  border-radius: 6px;
}

    
#app-previews {
  position: fixed;
  bottom: 56px;         /* just above the taskbar */
  left: 12px;
  right: 12px;
  display: flex;
  gap: 10px;
  align-items: stretch;
  padding: 8px;
  background: rgba(8,11,30,0.72);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 12px;
  backdrop-filter: blur(10px);
  z-index: 1600;
}

.app-preview {
  z-index: 1; /* lower value = back */
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 220px;           /* tile size */
  height: 140px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(4,6,20,0.98);
  overflow: hidden;
  cursor: pointer;
}

.app-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: saturate(1.1) contrast(1.03);
}

/* Top-right "X" — turns red on hover; no click action */
.app-preview .preview-close {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 22px;
  height: 22px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(255,255,255,0.2);
  color: #fff;
  font-size: 14px;
  line-height: 20px;
  text-align: center;
  cursor: default; /* not interactive */
  user-select: none;
}
.app-preview .preview-close:hover {
  background: #d83b01; /* red on hover */
  border-color: #d83b01;
}

/* Entry button */
.ts-entry-btn {
  position: fixed;
  bottom: 16px;
  right: 16px;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: none;
  background: radial-gradient(circle at 30% 30%, #ff66ff, #8a2be2);
  color: #fff;
  font-size: 20px;
  cursor: pointer;
  box-shadow: 0 0 18px rgba(255, 0, 204, 0.6);
  z-index: 9000;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.ts-entry-btn:hover {
  transform: scale(1.08);
  box-shadow: 0 0 26px rgba(255, 0, 204, 0.9);
}

/* Overlay */
.ts-overlay {
  position: fixed;
  inset: 0;
  display: none;
  z-index: 9990;
  overflow: hidden;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

/* Backdrop dim */
.ts-backdrop {
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at top, rgba(255, 0, 204, 0.25), transparent),
              radial-gradient(circle at bottom, rgba(138, 43, 226, 0.35), #050011);
  opacity: 0;
  transition: opacity 0.4s ease;
}

/* Scroll panels */
.ts-scroll-panel {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #8a2be2, #ff00cc, #ff66ff);
  box-shadow: 0 0 40px rgba(255, 0, 204, 0.6);
  border-radius: 18px;
  opacity: 0;
}
.ts-scroll-top {
  top: -40%;
  width: 80%;
  height: 40%;
}
.ts-scroll-middle {
  top: 30%;
  width: 0;
  height: 40%;
}

/* Main UI */
.ts-ui {
  position: absolute;
  inset: 32px;
  border-radius: 24px;
  background: rgba(10, 0, 30, 0.8);
  backdrop-filter: blur(24px);
  border: 1px solid rgba(255, 255, 255, 0.08);
  box-shadow: 0 0 40px rgba(0, 0, 0, 0.7);
  opacity: 0;
  transform: scale(0.96);
  display: flex;
  flex-direction: column;
  color: #fdf5ff;
  overflow: hidden;
  transition: opacity 0.35s ease, transform 0.35s ease;
}

/* Header */
.ts-header {
  display: flex;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  gap: 12px;
}
.ts-title {
  font-size: 20px;
  font-weight: 600;
}
.ts-subtitle {
  font-size: 12px;
  opacity: 0.8;
}
.ts-close-btn {
  margin-left: auto;
  border: none;
  background: transparent;
  color: #fdf5ff;
  font-size: 18px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 999px;
  transition: background 0.2s ease;
}
.ts-close-btn:hover {
  background: rgba(255, 255, 255, 0.08);
}

/* Body layout */
.ts-body {
  flex: 1;
  display: flex;
  min-height: 0;
}

/* Sidebar */
.ts-sidebar {
  width: 210px;
  padding: 12px;
  border-right: 1px solid rgba(255, 255, 255, 0.06);
  display: flex;
  flex-direction: column;
  gap: 8px;
  transform: translateX(-40px);
  opacity: 0;
}
.ts-side-item {
  display: flex;
  align-items: center;
  gap: 8px;
  border-radius: 999px;
  border: none;
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.04);
  color: #fdf5ff;
  cursor: pointer;
  font-size: 13px;
  transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
}
.ts-side-item:hover {
  background: rgba(255, 255, 255, 0.08);
  transform: translateX(4px);
  box-shadow: 0 0 12px rgba(255, 0, 204, 0.4);
}
.ts-icon {
  width: 20px;
  text-align: center;
}

/* Main area */
.ts-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 16px 18px;
  gap: 12px;
}

/* Search */
.ts-search-wrap {
  display: flex;
  justify-content: flex-start;
}
.ts-search {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  border-radius: 999px;
  background: radial-gradient(circle at top left, rgba(255, 0, 204, 0.35), rgba(20, 0, 50, 0.9));
  border: 1px solid rgba(255, 255, 255, 0.12);
  box-shadow: 0 0 18px rgba(255, 0, 204, 0.5);
  transform: translateY(20px) scale(0.9);
  opacity: 0;
}
.ts-search-icon {
  font-size: 14px;
}
.ts-search input {
  background: transparent;
  border: none;
  outline: none;
  color: #fdf5ff;
  font-size: 13px;
  width: 260px;
}
.ts-search input::placeholder {
  color: rgba(255, 230, 255, 0.7);
}

/* Content */
.ts-content {
  flex: 1;
  margin-top: 8px;
  padding: 12px 14px;
  border-radius: 16px;
  background: radial-gradient(circle at top, rgba(255, 0, 204, 0.18), rgba(10, 0, 30, 0.95));
  border: 1px solid rgba(255, 255, 255, 0.06);
  overflow-y: auto;
  font-size: 13px;
  line-height: 1.5;
}

/* Active overlay state (triggered via JS) */
.ts-overlay.ts-active .ts-backdrop {
  opacity: 1;
}
.ts-overlay.ts-active .ts-ui {
  opacity: 1;
  transform: scale(1);
}
.ts-overlay.ts-active .ts-sidebar {
  opacity: 1;
  transform: translateX(0);
  transition: opacity 0.35s ease 0.25s, transform 0.35s ease 0.25s;
}
.ts-overlay.ts-active .ts-search {
  opacity: 1;
  transform: translateY(0) scale(1);
  transition: opacity 0.35s ease 0.35s, transform 0.35s ease 0.35s;
}

/* Scroll animation keyframes */
@keyframes tsScrollTopIn {
  0% { top: -40%; opacity: 0; }
  100% { top: 0; opacity: 1; }
}
@keyframes tsScrollMiddleIn {
  0% { width: 0; opacity: 0; }
  100% { width: 80%; opacity: 1; }
}

.taskmgr-performance-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}
.taskmgr-performance-card {
  background: rgba(10,0,30,0.9);
  border-radius: 12px;
  padding: 8px;
  display: flex;
  flex-direction: column;
}
.taskmgr-performance-title {
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 6px;
  color: #fff;
}
.taskmgr-performance-card canvas {
  width: 100%;
  height: 100px;
  background: rgba(255,255,255,0.06);
  border-radius: 8px;
}

.weather-box {
  width: 240px;
  padding: 10px;
  border-radius: 12px;
  backdrop-filter: blur(14px);
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.25);
  color: white;
  font-family: Segoe UI, sans-serif;
  font-size: 12px;
}

.weather-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.weather-header select {
  background:#0002;
  color:white;
  border:1px solid #fff3;
  border-radius:6px;
}

.weather-tabs {
  display:flex;
  gap:4px;
  margin-top:6px;
}

.weather-tab {
  padding:3px 6px;
  border-radius:6px;
  background:#111;
  cursor:pointer;
}

.weather-tab.active {
  background:#2b5cff;
}

.weather-panel {
  margin-top:6px;
  max-height:140px;
  overflow:auto;
  background:#050818;
  border-radius:6px;
  padding:6px;
}

.weather-row {
  display:flex;
  justify-content:space-between;
  padding:3px 0;
  border-bottom:1px solid rgba(255,255,255,0.08);
}

.weather-icon-big {
  font-size:32px;
  animation: wxpulse 2s infinite ease-in-out;
}

@keyframes wxpulse {
  0%,100% { transform:scale(1); opacity:1; }
  50% { transform:scale(1.1); opacity:.8; }
}

.weather-alert {
  background:#5b1a1a;
  padding:4px;
  border-radius:6px;
  margin-bottom:4px;
}

.weather-map {
  width:100%;
  height:130px;
  border:none;
  border-radius:6px;
}

.weather-texas-map {
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:3px;
  margin-top:6px;
}

.weather-texas-map button {
  font-size:10px;
  padding:3px;
}
.hidden { display: none !important; }

.taskbar-btn {
  background: none;
  border: none;
  padding: 6px 10px;
  cursor: pointer;
  color: #c5cae6;
}

/* ===== NEWS PANEL ===== */
#news-panel {
  position: absolute;
  bottom: 48px;
  left: 0;
  width: 460px;
  height: 520px;
  backdrop-filter: blur(20px);
  background: rgba(10,14,28,0.85);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.08);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  color: #f5f7ff;
}

.news-topbar,
.article-topbar,
.weather-topbar {
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 12px;
  background: rgba(255,255,255,0.05);
}

.news-toolbar {
  display: flex;
  justify-content: space-between;
  padding: 8px;
  background: rgba(255,255,255,0.03);
}

.news-search {
  display: flex;
  gap: 6px;
}

#news-content {
  flex: 1;
  display: flex;
}

.news-list {
  width: 45%;
  overflow-y: auto;
  padding: 6px;
}

.news-preview {
  width: 55%;
  overflow-y: auto;
  padding: 10px;
}

.news-card {
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  padding: 8px;
  margin-bottom: 8px;
  cursor: pointer;
}

.news-card-img-wrap img {
  width: 100%;
  border-radius: 6px;
}

.news-preview-img {
  width: 100%;
  border-radius: 8px;
}

.news-preview-inner h1 {
  margin: 8px 0;
  font-size: 18px;
}

/* ===== BOOTLOADER ===== */
.news-bootloader {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
}

.boot-logo {
  font-size: 18px;
  opacity: 0.8;
}

.boot-spinner {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 3px solid rgba(255,255,255,0.2);
  border-top-color: #4c8dff;
  animation: spin 1s linear infinite;
}

.boot-text {
  font-size: 13px;
  opacity: 0.7;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* ===== ARTICLE OVERLAY ===== */
#news-article-overlay {
  position: absolute;
  bottom: 48px;
  left: 0;
  width: 520px;
  height: 520px;
  backdrop-filter: blur(20px);
  background: rgba(10,14,28,0.9);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.08);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  color: #f5f7ff;
}

.article-layout {
  flex: 1;
  display: flex;
}

.article-sidebar {
  width: 40%;
  padding: 10px;
  border-right: 1px solid rgba(255,255,255,0.08);
}

.article-sidebar-img-wrap img {
  width: 100%;
  border-radius: 8px;
}

.article-sidebar-name {
  margin-top: 8px;
  font-weight: 600;
}

.article-content {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  font-size: 14px;
  line-height: 1.4;
}

/* ===== WEATHER PANEL ===== */
#weather-panel {
  position: absolute;
  bottom: 48px;
  left: 480px;
  width: 360px;
  height: 360px;
  backdrop-filter: blur(20px);
  background: rgba(10,14,28,0.85);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.08);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  color: #f5f7ff;
}

.weather-toolbar {
  display: flex;
  justify-content: space-between;
  padding: 8px;
}

.weather-body {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

.weather-daily-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.weather-day-card {
  background: rgba(255,255,255,0.05);
  padding: 8px;
  border-radius: 8px;
  font-size: 13px;
}

.weather-hourly-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.weather-hour-row {
  display: flex;
  justify-content: space-between;
  padding: 4px 6px;
  background: rgba(255,255,255,0.03);
  border-radius: 6px;
  font-size: 13px;
}

.weather-day-hourly-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 6px;
}

/* ===== GENERIC BUTTONS ===== */
.btn-primary {
  background: #4c8dff;
  border: none;
  border-radius: 6px;
  padding: 4px 10px;
  color: #f5f7ff;
  font-size: 13px;
  cursor: pointer;
}

.btn-ghost {
  background: transparent;
  border: none;
  color: #c5cae6;
  padding: 4px 8px;
  cursor: pointer;
  font-size: 13px;
}

  </style>
  <style id="theme-style"></style>
</head>
<body>

  <!-- login -->
  <div id="login-overlay">
    <div class="login-panel">
      <div class="login-title">
        <h1>Win12 Preview</h1>
        <h2>Multi-user · AIM · Host.exe Ritual</h2>
      </div>
      <div id="user-list"></div>
      <div class="login-form">
        <input id="new-user-name" class="login-input" placeholder="Create new user (name)" maxlength="24" />
        <button class="login-button" id="create-user">Create</button>
      </div>
      <div class="login-footer">
        <span>All user data is local to this browser.</span>
        <span>Channel: 12.AIM.FS.EXE</span>
      </div>
    </div>
  </div>

  <!-- desktop -->
  <div id="desktop">
    <div class="desktop-orbit"></div>
    <div class="desktop-center">
      <div class="desktop-title">Windows <span>12</span></div>
      <div class="desktop-sub">Preview simulator · AIM · Multi-user</div>
      <div class="desktop-desc">
        Desktop icons = /desktop. Explorer, Notepad, Browser, Host.exe, Regedit, Settings, AIM OS, Paint, and Media Player all live in this HTML.<br/>
        .exe files run as base64 HTML payloads inside the Windows Host Application. MIT © 2026 Alaric Holt
      </div>
      <div class="desktop-aim-chip">
        <div class="aim-dot"></div>
        <span>AIM · Agency · Intent · Myth</span>
      </div>
    </div>
    <div id="desktop-icons"></div>
    <div class="desktop-bottom-left">
      <div><strong>Win12 Preview Simulator AIM</strong></div>
      <div>Nothing touches real files, only export and import sessions. All FS, content, exe payloads, and associations live in localStorage. MIT © 2026 Alaric Holt</div>
    </div>
<!-- DESKTOP WIDGETS LAYER (widgets appear here in normal mode) -->
<div id="desktop-widgets-layer"></div>

<!-- WIDGET EDITOR OVERLAY -->
<div id="widgets-editor-overlay" class="hidden">
  <div class="widgets-editor-panel">

    <!-- HEADER -->
    <div class="widgets-editor-header">
      <span>Desktop Widget Editor</span>
      <button id="widgets-editor-close-btn" class="win12-btn">Close</button>
    </div>

    <!-- CONTROLS -->
    <div class="widgets-editor-controls">
      <label>
        Widget type:
        <select id="widgets-editor-widget-type">
          <option value="clock">Clock</option>
          <option value="notes">Notes</option>
          <option value="weather">Weather</option>
          <option value="custom">Custom</option>
        </select>
      </label>

      <button id="widgets-editor-add-btn" class="win12-btn">
        Add Widget
      </button>
    </div>

    <!-- CANVAS (widgets appear here in editor mode) -->
    <div id="widgets-editor-canvas"></div>

  </div>
</div>

  </div>


<!-- App hover preview strip -->
<div id="app-previews"></div>

  <!-- taskbar -->
  <div id="taskbar">
    <div class="taskbar-left">
      <button class="taskbar-button" id="start-button">
      <img src="win12-icon.svg" alt="Win12 Icon" width="24" height="24">
      </button>
      <div class="taskbar-start-label">Start</div>
      <!-- Search Button -->
      <button class="taskbar-button" id="search-button">
        <img src="search.svg" alt="Search Icon" width="24" height="24">
      </button>

    </div>
    <div class="taskbar-center">
      <div class="taskbar-app-strip">
        <div class="taskbar-app" data-app="explorer" title="Explorer"></div>
        <div class="taskbar-app" data-app="notepad" title="Notepad"></div>
        <div class="taskbar-app" data-app="browser" title="Browser"></div>
        <div class="taskbar-app" data-app="host" title="Windows Host Application"></div>
        <div class="taskbar-app" data-app="assistant" title="AIM OS"></div>
        <div class="taskbar-app" data-app="regedit" title="Regedit"></div>
        <div class="taskbar-app" data-app="settings" title="Settings"></div>
        <div class="taskbar-app" data-app="notes" title="Notes"></div>
        <div class="taskbar-app" data-app="paint" title="Paint"></div>
        <div class="taskbar-app" data-app="media" title="Media Player"></div>
      </div>
    </div>
    <div class="taskbar-right">
      <div class="taskbar-import" id="taskbar-import">
        <span>⬆</span><span>Import files</span>
      </div>
      <input type="file" id="file-input" multiple style="display:none;" />
      <div class="taskbar-user-pill" id="user-chip">
        <div class="user-avatar-small"></div>
        <span id="user-chip-name">User</span>
      </div>
      <div class="taskbar-network" id="taskbar-network" style="cursor:pointer;">
        <svg id="network-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M2 20h20M6 16h12M10 12h4M12 8h0" />
        </svg>
      </div>
      <div class="taskbar-clock" id="taskbar-clock">
        <div class="taskbar-clock-time" id="clock-time">--:--</div>
        <div id="clock-label">Win12 AIM</div>
      </div>
      <div class="taskbar-notify"></div>
    </div>
  </div>

  <!-- time flyout -->
  <div id="time-flyout">
    <div id="time-flyout-time">--:--</div>
    <div id="time-flyout-date">---</div>
    <div id="time-flyout-greeting">Hello.</div>
      <!-- Troubleshooter Entry Button (you can move this into taskbar/start) -->
    <button id="troubleshooterEntryBtn" class="ts-entry-btn" onclick="openTroubleshooter()">
      ?
    </button>

  </div>


<!-- Network Panel -->
<div id="network-panel" style="display:none; position:absolute; bottom:40px; right:10px; background:rgba(8,11,30,0.98); border:1px solid rgba(255,255,255,0.2); border-radius:8px; padding:10px; width:220px; font-size:12px;">
  <div style="font-weight:bold; margin-bottom:6px;">Network Status</div>
  <input type="range" id="ping-slider" min="1" max="100" value="0" style="width:100%;">
  <div id="ping-text" style="margin-top:6px; color:var(--text-main);">Ping: -- ms</div>
</div>

  <!-- start -->
  <div id="start-backdrop"></div>
  <div id="start-menu">
    <div class="start-header">
      <img src="win12-icon.svg" alt="Win12 Simulator Icon" width="64" height="64">
      <div class="start-header-left">
        <div class="start-avatar"></div>
        <div>
          <div class="start-title-main">Win12 Preview</div>
          <div class="start-title-sub">Simulator · AIM · Multi-user</div>
        </div>
      </div>
      <div class="start-header-right">
        <div class="start-user-name" id="start-user-name">User</div>
        <div>Local only · Client-side</div>
      </div>
    </div>
    <div class="start-search">
      <span class="start-search-icon">🔍</span>
      <input id="start-search-input" placeholder="Search apps and files (simulated)..." />
    </div>
    <div class="start-main-grid">
      <div>
        <div class="start-section-title">Pinned</div>
        <div class="start-pinned-grid" id="start-pinned-grid">
          <div class="start-app" data-app="explorer" data-app-name="explorer">
            <div class="start-app-icon"></div>
            <div>Explorer</div>
            <div class="start-app-sub">FS + ctx menus</div>
          </div>
          <div class="start-app" data-app="news" data-app-name="news">
            <div class="start-app-icon"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <!-- Outer rounded rectangle (newspaper body) -->
            <rect x="3" y="4" width="18" height="16" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="1.6"/>

             <!-- Left title block -->
            <rect x="5.2" y="6.2" width="6.2" height="3.6" rx="0.8" ry="0.8" fill="none" stroke="currentColor" stroke-width="1.3"/>

            <!-- Left text lines -->
            <line x1="5.4" y1="11" x2="11.2" y2="11" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
            <line x1="5.4" y1="13.4" x2="11.2" y2="13.4" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
            <line x1="5.4" y1="15.8" x2="9.8"  y2="15.8" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>

            <!-- Right image block -->
            <rect x="12.8" y="6.2" width="5.8" height="5.8" rx="1" ry="1" fill="none" stroke="currentColor" stroke-width="1.3"/>

            <!-- Right text lines under image -->
            <line x1="12.8" y1="13.8" x2="18.6" y2="13.8" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
            line x1="12.8" y1="16.2" x2="17.2" y2="16.2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
            </svg>
            </div>
            <div>News</div>
            <div class="start-app-sub">History + user content</div>
          </div>
          <div class="start-app" data-app="notepad" data-app-name="notepad">
            <div class="start-app-icon" style="background:linear-gradient(135deg,#ffcc66,#ff9966);"></div>
            <div>Notepad</div>
            <div class="start-app-sub">View + edit text</div>
          </div>
          <div class="start-app" data-app="camera" data-app-name="camera">
            <div class="start-app-icon" style="background:linear-gradient(135deg,#ffcc66,#ff9966);"></div>
            <div>Camera</div>
            <div class="start-app-sub">Snap + Record</div>
          </div>
          <div class="start-app" data-app="browser" data-app-name="browser">
            <div class="start-app-icon" style="background:linear-gradient(135deg,#4c8dff,#94a3ff);"></div>
            <div>Browser</div>
            <div class="start-app-sub">Tabs + file:/// view</div>
          </div>
          <div class="start-app" data-app="host" data-app-name="host">
            <div class="start-app-icon" style="background:linear-gradient(135deg,#6ee7b7,#22c55e);"></div>
            <div>Host.exe</div>
            <div class="start-app-sub">Run .exe HTML payload</div>
          </div>
          <div class="start-app" data-app="assistant" data-app-name="assistant">
            <div class="start-app-icon" style="background:conic-gradient(from 220deg,#4c8dff,#9467ff,#4ce0b3,#4c8dff);"></div>
            <div>AIM OS</div>
            <div class="start-app-sub">Local assistant</div>
          </div>
          <div class="start-app" data-app="regedit" data-app-name="regedit">
            <div class="start-app-icon" style="background:linear-gradient(135deg,#4c8dff,#94a3ff);"></div>
            <div>Regedit</div>
            <div class="start-app-sub">Associations</div>
          </div>
          <div class="start-app" data-app="settings" data-app-name="settings">
            <div class="start-app-icon" style="background:radial-gradient(circle at 30% 20%,#fff,#a0b4ff);"></div>
            <div>Settings</div>
            <div class="start-app-sub">Theme.css & more</div>
          </div>
          <div class="start-app" data-app="notes" data-app-name="notes">
            <div class="start-app-icon" style="background:linear-gradient(135deg,#f97316,#facc15);"></div>
            <div>Notes</div>
            <div class="start-app-sub">Per-user shrine memo</div>
          </div>
          <div class="start-app" data-app="paint" data-app-name="paint">
            <div class="start-app-icon" style="background:linear-gradient(135deg,#22c55e,#3b82f6);"></div>
            <div>Paint</div>
            <div class="start-app-sub">Win11-style canvas</div>
          </div>
          <div class="start-app" data-app="media" data-app-name="media">
            <div class="start-app-icon" style="background:linear-gradient(135deg,#8b5cf6,#ec4899);"></div>
            <div>Media Player</div>
            <div class="start-app-sub">Open any media</div>
          </div>
          <div class="start-app" data-app="taskmgr" data-app-name="taskmgr">
            <div class="start-app-icon" style="background:linear-gradient(135deg,#ff7ad9,#b400ff);"></div>
            <div>Task Manager</div>
            <div class="start-app-sub">Monitor apps & performance</div>
          </div>
        </div>
      </div>
      <div class="start-right-panel">

        <div class="start-rec-item">
          <h1>Power Options</h1>
          <button onclick="runActionUI('Shutting down', () => window.close())" style="display:block; width:100%; padding:10px; margin:6px 0; background:#d9534f; color:white; border:none; border-radius:6px; cursor:pointer;"> Shutdown </button>
          <button onclick="runActionUI('Restarting', () => location.reload())" style="display:block; width:100%; padding:10px; margin:6px 0; background:#0275d8; color:white; border:none; border-radius:6px; cursor:pointer;"> Restart </button>
         </div>
        <div class="start-section-title">Recommended</div>
        <div class="start-rec-item" id="rec-section">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div id="rec-title" style="font-size:11px;color:var(--text-main);">Recommended files</div>
            <div id="rec-dropdown-toggle">
              <span id="rec-mode-label">Recommended</span>
              <span>▼</span>
            </div>
            <div id="rec-dropdown-menu">
              <div class="rec-dropdown-item" data-mode="recommended">Recommended</div>
              <div class="rec-dropdown-item" data-mode="imported">Imported</div>
            </div>
          </div>
          <div id="rec-sub" style="font-size:10px;color:var(--text-soft);">From /recommended-files in your FS.</div>
          <div id="rec-files" style="margin-top:4px;font-size:11px;color:var(--text-soft);"></div>
        </div>
        <div class="start-rec-item" data-app="assistant">
          <div style="font-size:11px;color:var(--text-main);">Ask AIM about your FS</div>
          <div style="font-size:10px;color:var(--text-soft);">“Where is my data?” · “What is AIM?”</div>
        </div>
      </div>
    </div>
    <div class="start-footer">
      <span>Static HTML · CSS · JS · localStorage. No backend.</span>
      <span class="start-footer-aim">AIM · Agency · Intent · Myth</span>
    </div>
  </div>


  <!-- Search Panel -->
  <div id="search-panel" class="start-menu">
    <div class="start-header">
      <img src="search.svg" alt="Search Icon" width="64" height="64">
      <div class="start-header-left">
        <div class="start-title-main">Search</div>
        <div class="start-title-sub">Find apps quickly</div>
      </div>
    </div>
    <div class="start-search">
      <span class="start-search-icon">🔍</span>
      <input id="search-input" placeholder="Search apps..." />
    </div>
    <div id="search-results" style="padding:8px;font-size:12px;color:var(--text-main);"></div>
  </div>

  <!-- Explorer -->
  <div class="window" id="window-explorer" data-app="explorer" data-app-desc="[Explorer] Browse per-user FS, right-click files/folders/background to open, duplicate, copy, paste, rename, or view properties.">
    <div class="window-header" data-drag-handle>
      <div class="window-title">
        <div class="window-title-icon"></div>
        <div class="window-title-text">
          <div class="window-title-main">[Explorer]</div>
          <div class="window-title-sub">Tabbed sidebar · context menus · handlers</div>
        </div>
        <div class="window-fullscreen-toggle" title="Toggle fullscreen">[ ]</div>
        <div class="window-info-icon">(i)</div>
        <div class="window-info-tooltip"></div>
      </div>
      <div class="window-controls">
        <div class="window-btn minimize"><div class="window-btn-icon"></div></div>
        <div class="window-btn close"><div class="window-btn-icon"></div></div>
      </div>
    </div>
    <div class="window-body">
      <div style="display:grid;grid-template-columns:1.1fr 2.1fr;gap:8px;font-size:12px;height:100%;">
        <div style="border-radius:10px;background:rgba(8,11,30,0.98);border:1px solid rgba(255,255,255,0.1);padding:6px;" id="explorer-sidebar">
          <div class="explorer-tab" data-path="/" style="padding:6px 7px;border-radius:8px;margin-bottom:4px;cursor:pointer;">This Win12</div>
          <div class="explorer-tab" data-path="/desktop" style="padding:6px 7px;border-radius:8px;background:rgba(26,32,70,0.98);margin-bottom:4px;cursor:pointer;">Desktop</div>
          <div class="explorer-tab" data-path="/documents" style="padding:6px 7px;border-radius:8px;margin-bottom:4px;cursor:pointer;">Documents</div>
          <div class="explorer-tab" data-path="/recommended-files" style="padding:6px 7px;border-radius:8px;margin-bottom:4px;cursor:pointer;">Recommended</div>
          <div class="explorer-tab" data-path="/imported" style="padding:6px 7px;border-radius:8px;margin-bottom:4px;cursor:pointer;">Imported</div>
        </div>
        <div id="explorer-main" style="border-radius:10px;background:rgba(8,11,30,0.98);border:1px solid rgba(255,255,255,0.1);padding:6px;position:relative;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
            <div id="explorer-path" style="font-size:11px;color:var(--text-soft);">/desktop</div>
            <div style="display:flex;gap:4px;">
              <div class="button-small" id="explorer-new-file">New file</div>
              <div class="button-small" id="explorer-up">Up</div>
              <div class="button-small" id="explorer-refresh">Refresh</div>
            </div>
          </div>
          <div id="explorer-items" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:6px;font-size:11px;height:calc(100% - 24px);overflow:auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notepad -->
  <div class="window" id="window-notepad" data-app="notepad" data-app-desc="[Notepad] Simple text editor for viewing and editing file content. Right-click a file and choose 'Open in Notepad' to edit its text.">
    <div class="window-header" data-drag-handle>
      <div class="window-title">
        <div class="window-title-icon" style="background:linear-gradient(135deg,#ffcc66,#ff9966);"></div>
        <div class="window-title-text">
          <div class="window-title-main">[Notepad]</div>
          <div class="window-title-sub" id="notepad-title-sub">No file open</div>
        </div>
        <div class="window-fullscreen-toggle" title="Toggle fullscreen">[ ]</div>
        <div class="window-info-icon">(i)</div>
        <div class="window-info-tooltip"></div>
      </div>
      <div class="window-controls">
        <div class="window-btn minimize"><div class="window-btn-icon"></div></div>
        <div class="window-btn close"><div class="window-btn-icon"></div></div>
      </div>
    </div>
    <div class="window-body">
      <textarea id="notepad-area" class="notes-area" spellcheck="false" placeholder="File content will appear here..."></textarea>
      <div class="notes-footer">
        <span id="notepad-status">No file selected.</span>
        <button class="button-small" id="notepad-save">Save to FS</button>
      </div>
    </div>
  </div>

  <!-- Browser -->
  <div class="window" id="window-browser" data-app="browser" data-app-desc="[Browser] Multi-tab browser. For http/https it uses an iframe. For file:/// it shows FS content: lists folders or displays file content inline.">
    <div class="window-header" data-drag-handle>
      <div class="window-title">
        <div class="window-title-icon" style="background:linear-gradient(135deg,#4c8dff,#94a3ff);"></div>
        <div class="window-title-text">
          <div class="window-title-main">[Browser]</div>
          <div class="window-title-sub">Tabs · http/https iframe · file:/// FS view</div>
        </div>
        <div class="window-fullscreen-toggle" title="Toggle fullscreen">[ ]</div>
        <div class="window-info-icon">(i)</div>
        <div class="window-info-tooltip"></div>
      </div>
      <div class="window-controls">
        <div class="window-btn minimize"><div class="window-btn-icon"></div></div>
        <div class="window-btn close"><div class="window-btn-icon"></div></div>
      </div>
    </div>
    <div class="window-body">
      <div id="browser-tabs" style="display:flex;gap:4px;margin-bottom:6px;font-size:11px;"></div>
      <div style="display:flex;gap:4px;margin-bottom:4px;font-size:11px;">
        <input id="browser-address" style="flex:1;padding:4px 6px;border-radius:999px;border:1px solid rgba(255,255,255,0.24);background:rgba(4,6,18,0.98);color:var(--text-main);outline:none;font-size:11px;" placeholder="Enter URL (http/https) or file:///desktop / file:///desktop/Welcome.txt ..." />
        <button class="button-small" id="browser-go">Go</button>
      </div>
      <div id="browser-view" style="border-radius:10px;border:1px solid rgba(255,255,255,0.18);background:rgba(4,6,20,0.98);height:280px;overflow:auto;"></div>
      <div style="margin-top:4px;font-size:10px;color:var(--text-dim);">
        Examples: <code>https://example.com</code>, <code>file:///desktop</code>, <code>file:///desktop/Welcome.txt</code>.
      </div>
    </div>
  </div>

  <!-- Host.exe -->
  <div class="window" id="window-host" data-app="host" data-app-desc="[Windows Host Application] Runs .exe files from this relic. Each .exe carries base64 HTML payload that is decoded and rendered here.">
    <div class="window-header" data-drag-handle>
      <div class="window-title">
        <div class="window-title-icon" style="background:linear-gradient(135deg,#6ee7b7,#22c55e);"></div>
        <div class="window-title-text">
          <div class="window-title-main">[Windows Host Application]</div>
          <div class="window-title-sub" id="host-title-sub">Idle · No .exe running</div>
        </div>
        <div class="window-fullscreen-toggle" title="Toggle fullscreen">[ ]</div>
        <div class="window-info-icon">(i)</div>
        <div class="window-info-tooltip"></div>
      </div>
      <div class="window-controls">
        <div class="window-btn minimize"><div class="window-btn-icon"></div></div>
        <div class="window-btn close"><div class="window-btn-icon"></div></div>
      </div>
    </div>
    <div class="window-body">
      <div id="host-output" style="border-radius:10px;border:1px solid rgba(255,255,255,0.18);background:rgba(4,6,20,0.98);min-height:220px;overflow:auto;padding:6px;font-size:12px;">
        Use SampleApp.exe on the desktop or any other .exe in FS. Host decodes base64 HTML payloads (exePayloadBase64) and renders them here via iframe srcdoc.
      </div>
    </div>
  </div>

  <!-- AIM OS -->
  <div class="window" id="window-assistant" data-app="assistant" data-app-desc="[AIM OS] Local assistant that knows about this relic: FS, users, .exe payloads, and how everything works.">
    <div class="window-header" data-drag-handle>
      <div class="window-title">
        <div class="window-title-icon" style="background:conic-gradient(from 220deg,#4c8dff,#9467ff,#4ce0b3,#4c8dff);"></div>
        <div class="window-title-text">
          <div class="window-title-main">[AIM OS]</div>
          <div class="window-title-sub">Local, rule-based, OS-aware</div>
        </div>
        <div class="window-fullscreen-toggle" title="Toggle fullscreen">[ ]</div>
        <div class="window-info-icon">(i)</div>
        <div class="window-info-tooltip"></div>
      </div>
      <div class="window-controls">
        <div class="window-btn minimize"><div class="window-btn-icon"></div></div>
        <div class="window-btn close"><div class="window-btn-icon"></div></div>
      </div>
    </div>
    <div class="window-body">
      <div class="ai-log" id="ai-log"></div>
      <div class="ai-input-row">
        <input id="ai-input" class="ai-input" placeholder="Ask about files, users, .exe, Host, AIM, Paint, or Media Player..." />
        <button class="button-small" id="ai-send">Send</button>
      </div>
    </div>
  </div>

  <!-- Regedit -->
  <div class="window" id="window-regedit" data-app="regedit" data-app-desc="[Regedit] Simulated HKCU\\Software\\Win12\\Associations for mapping extensions to apps.">
    <div class="window-header" data-drag-handle>
      <div class="window-title">
        <div class="window-title-icon" style="background:linear-gradient(135deg,#4c8dff,#94a3ff);"></div>
        <div class="window-title-text">
          <div class="window-title-main">[Regedit]</div>
          <div class="window-title-sub">HKCU\\Software\\Win12\\Associations</div>

        </div>
        <div class="window-fullscreen-toggle" title="Toggle fullscreen">[ ]</div>
        <div class="window-info-icon">(i)</div>
        <div class="window-info-tooltip"></div>
      </div>
      <div class="window-controls">
        <div class="window-btn minimize"><div class="window-btn-icon"></div></div>
        <div class="window-btn close"><div class="window-btn-icon"></div></div>
      </div>
    </div>
    <div class="window-body">
      <div style="display:grid;grid-template-columns:1.1fr 1.9fr;gap:8px;font-size:12px;">
        <div style="border-radius:10px;background:rgba(8,11,30,0.98);border:1px solid rgba(255,255,255,0.1);padding:6px;">
          <div style="font-size:11px;color:var(--text-soft);margin-bottom:4px;">Tree</div>
          <div style="font-family:'Cascadia Code',monospace;font-size:11px;color:var(--text-main);">
            HKEY_CURRENT_USER<br/>
            &nbsp;&nbsp;Software<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;Win12<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:var(--accent);">Associations</span>
            <div id="ls-viewer">
            <div class="ls-header">
            <button id="ls-save-btn">Save Changes</button>
          </div>

          <div id="ls-tree"></div>
        </div>
          </div>
        </div>
        <div style="border-radius:10px;background:rgba(8,11,30,0.98);border:1px solid rgba(255,255,255,0.1);padding:6px;" id="regedit-values">
          <div style="font-size:11px;color:var(--text-soft);margin-bottom:4px;">Values</div>
          <div id="regedit-list"></div>
          <div style="margin-top:6px;">
            <div class="button-small" id="regedit-add">Add association</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings -->
  <div class="window" id="window-settings" data-app="settings" data-app-desc="[Settings] Per-user theme.css injector and room for more knobs in future builds.">
    <div class="window-header" data-drag-handle>
      <div class="window-title">
        <div class="window-title-icon" style="background:radial-gradient(circle at 30% 20%,#fff,#a0b4ff);"></div>
        <div class="window-title-text">
          <div class="window-title-main">[Settings]</div>
          <div class="window-title-sub">Per-user theme.css & FS ritual</div>
        </div>
        <div class="window-fullscreen-toggle" title="Toggle fullscreen">[ ]</div>
        <div class="window-info-icon">(i)</div>
        <div class="window-info-tooltip"></div>
      </div>
      <div class="window-controls">
        <div class="window-btn minimize"><div class="window-btn-icon"></div></div>
        <div class="window-btn close"><div class="window-btn-icon"></div></div>
      </div>
    </div>
    <div class="window-body">
      <div style="font-size:11px;color:var(--text-soft);margin-bottom:4px;">theme.css (per user)</div>
      <textarea id="theme-css-input" class="notes-area" style="min-height:140px;" placeholder="Write CSS here, e.g. .window { border-radius: 4px; }"></textarea>
      <div class="notes-footer">
        <span id="theme-status">Not saved</span>
        <button class="button-small" id="theme-save">Save & apply</button>
      </div>
    </div>
  </div>

  <!-- Notes -->
  <div class="window" id="window-notes" data-app="notes" data-app-desc="[Notes] Per-user shrine notes. This is not tied to a file, it is your OS-level memory.">
    <div class="window-header" data-drag-handle>
      <div class="window-title">
        <div class="window-title-icon" style="background:linear-gradient(135deg,#f97316,#facc15);"></div>
        <div class="window-title-text">
          <div class="window-title-main">[Notes]</div>
          <div class="window-title-sub">Per-user AIM shrine log</div>
        </div>
        <div class="window-fullscreen-toggle" title="Toggle fullscreen">[ ]</div>
        <div class="window-info-icon">(i)</div>
        <div class="window-info-tooltip"></div>
      </div>
      <div class="window-controls">
        <div class="window-btn minimize"><div class="window-btn-icon"></div></div>
        <div class="window-btn close"><div class="window-btn-icon"></div></div>
      </div>
    </div>
    <div class="window-body">
      <textarea id="notes-area" class="notes-area" spellcheck="false" placeholder="This is not tied to a file. These are your Win12 AIM personal notes, saved per user."></textarea>
      <div class="notes-footer">
        <span id="notes-status">Loaded.</span>
        <button class="button-small" id="notes-save">Save notes</button>
      </div>
    </div>
  </div>

  <!-- News -->
  <div class="window" id="window-news" data-app="news" data-app-desc="[News] News is something where you can view added stuff after News's intail release">
    <div class="window-header" data-drag-handle>
      <div class="window-title">
        <div class="window-title-icon"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <!-- Outer rounded rectangle (newspaper body) -->
          <rect x="3" y="4" width="18" height="16" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="1.6"/>

          <!-- Left title block -->
          <rect x="5.2" y="6.2" width="6.2" height="3.6" rx="0.8" ry="0.8" fill="none" stroke="currentColor" stroke-width="1.3"/>

          <!-- Left text lines -->
          <line x1="5.4" y1="11" x2="11.2" y2="11" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
          <line x1="5.4" y1="13.4" x2="11.2" y2="13.4" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
          <line x1="5.4" y1="15.8" x2="9.8"  y2="15.8" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>

          <!-- Right image block -->
          <rect x="12.8" y="6.2" width="5.8" height="5.8" rx="1" ry="1" fill="none" stroke="currentColor" stroke-width="1.3"/>

          <!-- Right text lines under image -->
          <line x1="12.8" y1="13.8" x2="18.6" y2="13.8" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
          <line x1="12.8" y1="16.2" x2="17.2" y2="16.2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
        </svg>
        </div>
        <div class="window-title-text">
          <div class="window-title-main">[News]</div>
          <div class="window-title-sub">the news for after this windoow exsisted</div>
        </div>
        <div class="window-fullscreen-toggle" title="Toggle fullscreen">[ ]</div>
        <div class="window-info-icon">(i)</div>
        <div class="window-info-tooltip"></div>
      </div>
      <div class="window-controls">
        <div class="window-btn minimize"><div class="window-btn-icon"></div></div>
        <div class="window-btn close"><div class="window-btn-icon"></div></div>
      </div>
    </div>
    <div class="window-body">
      <details>
       <summary>4.0 - widgets</summary>
       <div>
         <img src="user.png"></img>
         <h1>Type: app request, User:</h1>
         <p>Ceal</p>
         <p>widgets adds so you can add any to the desktop report any bugs if theres an error with it.</p>
       </div>
      </details>
    </div>
  </div>

  <!-- Files summary -->
  <div class="window" id="window-files" data-app="files" data-app-desc="[Files] Debug view of the raw FS entries for this user.">
    <div class="window-header" data-drag-handle>
      <div class="window-title">
        <div class="window-title-icon"></div>
        <div class="window-title-text">
          <div class="window-title-main">[Files]</div>
          <div class="window-title-sub">Raw FS dump per user</div>
        </div>
        <div class="window-fullscreen-toggle" title="Toggle fullscreen">[ ]</div>
        <div class="window-info-icon">(i)</div>
        <div class="window-info-tooltip"></div>
      </div>
      <div class="window-controls">
        <div class="window-btn minimize"><div class="window-btn-icon"></div></div>
        <div class="window-btn close"><div class="window-btn-icon"></div></div>
      </div>
    </div>
    <div class="window-body">
      <div class="fs-list" id="fs-list"></div>
    </div>
  </div>

  <!-- Paint -->
  <div class="window" id="window-paint" data-app="paint" data-app-desc="[Paint] Win11-style Paint. Draw on a canvas, change color and brush size, and open local images into the canvas.">
    <div class="window-header" data-drag-handle>
      <div class="window-title">
        <div class="window-title-icon" style="background:linear-gradient(135deg,#22c55e,#3b82f6);"></div>
        <div class="window-title-text">
          <div class="window-title-main">[Paint]</div>
          <div class="window-title-sub">Canvas · brush · open image</div>
        </div>
        <div class="window-fullscreen-toggle" title="Toggle fullscreen">[ ]</div>
        <div class="window-info-icon">(i)</div>
        <div class="window-info-tooltip"></div>
      </div>
      <div class="window-controls">
        <div class="window-btn minimize"><div class="window-btn-icon"></div></div>
        <div class="window-btn close"><div class="window-btn-icon"></div></div>
      </div>
    </div>
    <div class="window-body">
      <div class="paint-toolbar">
        <span>Brush color:</span>
        <input type="color" id="paint-color" value="#ffffff" />
        <span>Size:</span>
        <input type="range" id="paint-size" min="1" max="40" value="5" />
        <button class="button-small" id="paint-clear">Clear</button>
        <button class="button-small" id="paint-open-image">Open image…</button>
        <input type="file" id="paint-file-input" accept="image/*" style="display:none;" />
      </div>
      <div class="paint-canvas-wrap">
        <canvas id="paint-canvas" width="640" height="360"></canvas>
      </div>
      <div style="margin-top:4px;font-size:10px;color:var(--text-dim);">
        Draw directly on the canvas. Opening an image will draw it into the canvas like Win11 Paint.
      </div>
    </div>
  </div>

  <!-- Media Player -->
  <div class="window" id="window-media" data-app="media" data-app-desc="[Media Player] Win11-style media player. Opens any local video, audio, or image file via the host browser.">
    <div class="window-header" data-drag-handle>
      <div class="window-title">
        <div class="window-title-icon" style="background:linear-gradient(135deg,#8b5cf6,#ec4899);"></div>
        <div class="window-title-text">
          <div class="window-title-main">[Media Player]</div>
          <div class="window-title-sub">Video · audio · images</div>
        </div>
        <div class="window-fullscreen-toggle" title="Toggle fullscreen">[ ]</div>
        <div class="window-info-icon">(i)</div>
        <div class="window-info-tooltip"></div>
      </div>
      <div class="window-controls">
        <div class="window-btn minimize"><div class="window-btn-icon"></div></div>
        <div class="window-btn close"><div class="window-btn-icon"></div></div>
      </div>
    </div>
    <div class="window-body">
      <div class="media-controls">
        <button class="button-small" id="media-open">Open media…</button>
        <input type="file" id="media-file-input" style="display:none;" accept="video/*,audio/*,image/*" />
        <span id="media-filename" style="color:var(--text-soft);font-size:11px;">No file loaded.</span>
      </div>
      <div class="media-surface" id="media-surface">
        <span style="font-size:11px;color:var(--text-soft);">Open any video, audio, or image file from your device. Playback is handled by the browser.</span>
      </div>
      <div style="margin-top:4px;font-size:10px;color:var(--text-dim);">
        This player does not touch your filesystem; it only creates temporary object URLs in your browser.
      </div>
    </div>
  </div>

<!-- Win12 Camera App -->
<div class="window" id="window-camera" data-app="camera" data-app-desc="[Win12 Camera] Record, pause, stop, edit, and export.">
  <div class="window-header" data-drag-handle>
    <div class="window-title">
      <!-- Icon: SVG camera lens -->
      <div class="window-title-icon">
        <svg viewBox="0 0 64 64" width="20" height="20">
          <circle cx="32" cy="32" r="28" fill="url(#lensGradient)" stroke="#fff" stroke-width="2"/>
          <circle cx="32" cy="32" r="12" fill="#000" stroke="#fff" stroke-width="2"/>
          <defs>
            <radialGradient id="lensGradient" cx="50%" cy="50%" r="50%">
              <stop offset="0%" stop-color="#ff4da6"/>
              <stop offset="100%" stop-color="#9b4dff"/>
            </radialGradient>
          </defs>
        </svg>
      </div>
      <div class="window-title-text">
        <div class="window-title-main">Camera</div>
        <div class="window-title-sub">Win11‑style UI</div>
      </div>
      <div class="window-fullscreen-toggle" title="Toggle fullscreen">[ ]</div>
      <div class="window-info-icon">(i)</div>
      <div class="window-info-tooltip"></div>
    </div>
    <div class="window-controls">
      <div class="window-btn minimize"><div class="window-btn-icon"></div></div>
      <div class="window-btn close"><div class="window-btn-icon"></div></div>
    </div>
  </div>

  <div class="window-body">
    <!-- Camera preview -->
    <div class="camera-view">
      <video id="camera-preview" autoplay playsinline></video>
    </div>

    <!-- Controls row -->
    <div class="camera-controls">
      <!-- Start Camera button -->
      <button class="button-large" id="camera-start">
        <svg viewBox="0 0 64 64" width="20" height="20">
          <polygon points="16,12 52,32 16,52" fill="#fff"/>
        </svg>
        Start Camera
      </button>

      <!-- Record -->
      <button class="button-small" id="camera-record">
        <svg viewBox="0 0 64 64" width="16" height="16">
          <circle cx="32" cy="32" r="20" fill="red"/>
        </svg>
        Record
      </button>

      <!-- Pause -->
      <button class="button-small" id="camera-pause">
        <svg viewBox="0 0 64 64" width="16" height="16">
          <rect x="18" y="16" width="10" height="32" fill="#fff"/>
          <rect x="36" y="16" width="10" height="32" fill="#fff"/>
        </svg>
        Pause
      </button>

      <!-- Stop -->
      <button class="button-small" id="camera-stop">
        <svg viewBox="0 0 64 64" width="16" height="16">
          <rect x="16" y="16" width="32" height="32" fill="white"/>
        </svg>
        Stop
      </button>
    </div>

    <!-- Editor panel -->
    <div class="camera-editor">
      <h4>Edit Recording</h4>
      <video id="camera-playback" controls></video>
      <div class="editor-tools">
        <button class="button-small" id="camera-trim">
          <svg viewBox="0 0 64 64" width="16" height="16">
            <path d="M16 16h32v32H16z" fill="none" stroke="#fff" stroke-width="4"/>
          </svg>
          Trim
        </button>
        <button class="button-small" id="camera-export">
          <svg viewBox="0 0 64 64" width="16" height="16">
            <path d="M32 12v28M20 28l12 12 12-12" stroke="#fff" stroke-width="4" fill="none"/>
            <rect x="16" y="44" width="32" height="8" fill="#fff"/>
          </svg>
          Export
        </button>
      </div>
    </div>
  </div>
</div>


<div class="window" id="window-taskmgr" data-app="taskmgr" data-app-desc="[Task Manager] Monitor processes, performance, and users.">
  <div class="window-header" data-drag-handle>
    <div class="window-title">
      <div class="window-title-icon" style="background:linear-gradient(135deg,#ff7ad9,#b400ff);"></div>
      <div class="window-title-text">
        <div class="window-title-main">[Task Manager]</div>
        <div class="window-title-sub">Processes · Performance · Users</div>
      </div>
      <div class="window-fullscreen-toggle" title="Toggle fullscreen">[ ]</div>
      <div class="window-info-icon">(i)</div>
      <div class="window-info-tooltip"></div>
    </div>
    <div class="window-controls">
      <div class="window-btn minimize"><div class="window-btn-icon"></div></div>
      <div class="window-btn close"><div class="window-btn-icon"></div></div>
    </div>
  </div>
  <div class="window-body taskmgr-body">
    <div class="taskmgr-container">
      <aside class="taskmgr-sidebar">
        <div class="taskmgr-sidebar-header">Task Manager</div>
        <ul class="taskmgr-sidebar-list">
          <li class="taskmgr-sidebar-item active" data-tab="processes">Processes</li>
          <li class="taskmgr-sidebar-item" data-tab="performance">Performance</li>
          <li class="taskmgr-sidebar-item" data-tab="app-history">App History</li>
          <li class="taskmgr-sidebar-item" data-tab="startup">Startup</li>
          <li class="taskmgr-sidebar-item" data-tab="users">Users</li>
          <li class="taskmgr-sidebar-item" data-tab="details">Details</li>
          <li class="taskmgr-sidebar-item" data-tab="services">Services</li>
        </ul>
      </aside>
      <main class="taskmgr-main">
        <div class="taskmgr-main-header">
          <div class="taskmgr-main-tabs">
            <button class="taskmgr-tab-btn active" data-tab="processes">Processes</button>
            <button class="taskmgr-tab-btn" data-tab="performance">Performance</button>
            <button class="taskmgr-tab-btn" data-tab="app-history">App History</button>
            <button class="taskmgr-tab-btn" data-tab="startup">Startup</button>
            <button class="taskmgr-tab-btn" data-tab="users">Users</button>
            <button class="taskmgr-tab-btn" data-tab="details">Details</button>
            <button class="taskmgr-tab-btn" data-tab="services">Services</button>
          </div>
          <div class="taskmgr-main-actions">
            <button class="taskmgr-btn taskmgr-btn-refresh">Refresh</button>
            <button class="taskmgr-btn taskmgr-btn-run">Run App</button>
          </div>
        </div>
        <div class="taskmgr-main-content">
          <section class="taskmgr-tab active" data-tab="processes">
            <table class="taskmgr-table"><thead><tr><th>Name</th><th>Status</th></tr></thead><tbody></tbody></table>
          </section>
          <section class="taskmgr-tab" data-tab="performance">
            <div class="taskmgr-performance-grid">
              <div class="taskmgr-performance-card">
                <div class="taskmgr-performance-title">CPU Usage</div>
                <canvas id="cpuChart"></canvas>
              </div>
              <div class="taskmgr-performance-card">
                <div class="taskmgr-performance-title">Memory Usage</div>
                <canvas id="memChart"></canvas>
              </div>
              <div class="taskmgr-performance-card">
                <div class="taskmgr-performance-title">Network Latency</div>
                <canvas id="netChart"></canvas>
              </div>
            </div>
          </section>
          <section class="taskmgr-tab" data-tab="app-history">App History content...</section>
          <section class="taskmgr-tab" data-tab="startup">Startup content...</section>
          <section class="taskmgr-tab" data-tab="users"><div id="usersList">Loading users...</div></section>
          <section class="taskmgr-tab" data-tab="details">Details content...</section>
          <section class="taskmgr-tab" data-tab="services">Services content...</section>
        </div>
      </main>
    </div>
  </div>
</div>

  <!-- Context menu -->
  <div class="ctx-menu" id="ctx-menu">
    <div class="ctx-item" data-action="open"><span>Open</span></div>
    <div class="ctx-item" data-action="openWith"><span>Open with…</span></div>
    <div class="ctx-item" data-action="openInNotepad"><span>Open in Notepad</span></div>
    <div class="ctx-item" data-action="openInBrowser"><span>Open in Browser</span></div>
    <div class="ctx-item" data-action="runExe"><span>Run (.exe in Host)</span></div>
    <button class="ctx-item" 
    style="background: transparent; color: white; border: none;" 
    onclick="window.location.href='https://github.com/alaricholt677/alaricholt677.github.io/tree/main';">
    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" width="16" style="fill:white;">
    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 
    6.53 5.47 7.59.4.07.55-.17.55-.38 
    0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52
    -.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 
    2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 
    0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 
    0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 
    1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 
    1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 
    3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 
    1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
    </svg>
    <span>Open GitHub project</span>
    </button>
    <div class="ctx-item" data-action="openLocation"><span>Open file location</span></div>
    <div class="ctx-separator"></div>
    <div class="ctx-item" data-action="newFile"><span>New file</span></div>
    <div class="ctx-item" data-action="newFolder"><span>New folder</span></div>
    <div class="ctx-item" data-action="duplicate"><span>Duplicate</span></div>
    <div class="ctx-item" data-action="copy"><span>Copy</span></div>
    <div class="ctx-item" data-action="paste"><span>Paste</span></div>
    <div class="ctx-item" data-action="rename"><span>Rename…</span></div>
    <div class="ctx-item" data-action="delete"><span>Delete</span></div>
    <div class="ctx-separator"></div>
    <div class="ctx-item" data-action="props"><span>Properties</span></div>
  </div>
  <!-- Admin popup -->
  <div id="admin-popup-backdrop">
    <div id="admin-popup">
      <div id="admin-popup-title">Admin permissions required</div>
      <div id="admin-popup-body" style="font-size:12px;color:var(--text-soft);">
        Editing this registry key changes file associations inside this relic.
      </div>
      <div id="admin-popup-buttons">
        <button class="admin-btn" id="admin-cancel">Cancel</button>
        <button class="admin-btn primary" id="admin-allow">Allow</button>
      </div>
    </div>
  </div>

  <!-- Device Not Supported Popup -->
  <div id="camera-popup-backdrop" style="display:none;">
    <div id="camera-popup">
      <div id="camera-popup-title">
        <svg width="18" height="18" viewBox="0 0 64 64" style="vertical-align:middle;margin-right:6px;">
          <circle cx="32" cy="32" r="30" fill="#ff4da6"/>
          <rect x="28" y="16" width="8" height="24" fill="white"/>
          <rect x="28" y="44" width="8" height="8" fill="white"/>
        </svg>
        Device Not Supported
      </div>

      <div id="camera-popup-body" style="font-size:12px;color:var(--text-soft);padding-top:6px;">
        This device does not have a camera available or permission was denied.
      </div>

      <div id="camera-popup-buttons">
        <button class="admin-btn primary" id="camera-popup-close">OK</button>
     </div>
    </div>
  </div>

  <!-- Dev banner -->
  <div class="dev-banner" id="dev-banner">
    <img src="win12-icon.svg" alt="Win12 Icon" width="24" height="24">
    dev: <span>Win12 AIM FS · full apps · full ctx menus · .exe base64 · clock flyout · fullscreen windows · Notes · Paint · Media Player</span>
  </div>
<!-- Fullscreen Troubleshooter Overlay -->
<div id="troubleshooterOverlay" class="ts-overlay">
  <audio id="troubleshooterAudio" loop>
    <source src="troubleshooter.mp3" type="audio/mpeg">
  </audio>

  <div class="ts-backdrop"></div>

  <!-- Scroll animation panels -->
  <div class="ts-scroll-panel ts-scroll-top"></div>
  <div class="ts-scroll-panel ts-scroll-middle"></div>

  <!-- Main UI container -->
  <div class="ts-ui">
    <div class="ts-header">
      <div class="ts-title">Troubleshooting Center</div>
      <div class="ts-subtitle">Win12 shrine for help, hidden features, and file:/// mapping.</div>
      <button class="ts-close-btn" onclick="closeTroubleshooter()">✕</button>
    </div>

    <div class="ts-body">
      <!-- Sidebar -->
      <div class="ts-sidebar">
        <button class="ts-side-item" data-ts-section="home">
          <span class="ts-icon">🏠</span>
          <span class="ts-label">Home</span>
        </button>
        <button class="ts-side-item" data-ts-section="apps">
          <span class="ts-icon">🧩</span>
          <span class="ts-label">Apps</span>
        </button>
        <button class="ts-side-item" data-ts-section="folders">
          <span class="ts-icon">📁</span>
          <span class="ts-label">Folders</span>
        </button>
        <button class="ts-side-item" data-ts-section="hidden">
          <span class="ts-icon">✨</span>
          <span class="ts-label">Hidden Features</span>
        </button>
        <button class="ts-side-item" data-ts-section="filemap">
          <span class="ts-icon">🌐</span>
          <span class="ts-label">file:/// mapping</span>
        </button>
      </div>

      <!-- Main content -->
      <div class="ts-main">
        <!-- Search bar -->
        <div class="ts-search-wrap">
          <div class="ts-search">
            <span class="ts-search-icon">🔍</span>
            <input id="tsSearchInput" type="text" placeholder="Search for help or type file:///folder..." />
          </div>
        </div>

        <!-- Dynamic content area -->
        <div id="tsContent" class="ts-content">
          <!-- Filled by JS -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Widget Popup Skeleton -->
<div id="widget-popup-backdrop" style="display:none;">
  <div id="widget-popup" style="background:#0b1020;padding:16px;border-radius:12px;width:320px;color:white;">
    <div id="widget-popup-title" style="display:flex;align-items:center;font-size:14px;font-weight:bold;">
      <svg width="18" height="18" viewBox="0 0 64 64" style="margin-right:6px;">
        <circle cx="32" cy="32" r="30" fill="#4c8dff"/>
        <rect x="28" y="16" width="8" height="24" fill="white"/>
      </svg>
      Create Widget
    </div>
    <div id="widget-popup-body" style="margin-top:8px;font-size:12px;color:var(--text-soft);">
      <label>Select Widget Type:</label>
      <select id="widget-type" style="width:100%;margin-top:6px;">
        <option>Clock</option>
        <option>Notes</option>
        <option>Calendar</option>
        <option>Calculator</option>
        <option>MiniWeb</option>
        <option>MiniRun</option>
        <option>MiniCPU</option>
        <option>MiniCMD</option>
        <option>Weather</option>
        <option>Custom</option>
      </select>
      <div id="widget-extra" style="margin-top:8px;"></div>
    </div>
    <div id="widget-popup-buttons" style="margin-top:12px;text-align:right;">
      <button class="admin-btn" id="widget-popup-cancel">Cancel</button>
      <button class="admin-btn primary" id="widget-popup-create">Create</button>
    </div>
  </div>

<audio id="troubleshooterAudio" src="troubleshooter.mp3" style="display: none;"></audio>

  <script>
    (function(){
      const STORAGE_KEY = "win12_aim_fs_state_exe_ctx_full_v3";

      function loadState(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(!raw) return {users:[],currentUserId:null};
          return JSON.parse(raw);
        }catch{
          return {users:[],currentUserId:null};
        }
      }
      let state = loadState();

      function ensureUser(){
        if(state.users.length === 0){
          const sampleExeHtml = `
<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>Sample EXE App</title>
<style>body{margin:0;padding:10px;font-family:sans-serif;background:#020617;color:#e5e7eb;}
h1{font-size:18px;margin:0 0 8px;}
small{color:#9ca3af;}
button{padding:4px 8px;border-radius:999px;border:1px solid #4c8dff;background:#020617;color:#e5e7eb;cursor:pointer;}
button:hover{background:#1e293b;}
</style></head>
<body>
<h1>Sample .exe HTML payload</h1>
<small>Stored as base64 inside SampleApp.exe in FS.</small>
<p>You launched this via the Windows Host Application inside the Win12 AIM relic.</p>
<button onclick="alert('Hello from inside the payload (simulated alert).')">Click</button>
</body></html>`;
          const exePayloadBase64 = btoa(sampleExeHtml);

          const id = Date.now().toString(36);
          state.users.push({
            id,
            name:"User",
            createdAt:new Date().toISOString(),
            notes:"Welcome to your Win12 AIM filesystem.\n\nThis Notes window is per-user, independent of files.\nDesktop icons = /desktop.\nRecommended = /recommended-files.\nImported = /imported.\n.exe files run in Host.exe via base64 HTML payloads.\nClock shows a flyout when clicked.\nRight-click anywhere: desktop, Explorer, files, folders, recommended, imported.",
            themeCss:"",
            fs:[
              { path:"/desktop", name:"Welcome.txt", type:"file", ext:".txt", content:"Hello from the Win12 AIM relic.\n\nThis is your desktop Welcome.txt file."},
              { path:"/desktop", name:"Readme.md", type:"file", ext:".md", content:"# Readme\n\nThis is a markdown file in /desktop."},
              { path:"/desktop", name:"SampleApp.exe", type:"file", ext:".exe", content:"(Unsupported type or Binary)", exePayloadBase64 },
              { path:"/documents", name:"Session.log", type:"file", ext:".log", content:"Session started.\nUser created.\nExplorer, Notepad, Browser, and Host.exe online."},
              { path:"/recommended-files", name:"win12PreviewPlans.txt", type:"file", ext:".txt", content:"Ideas: \n make url tjy-gitnub.github.io/win12/desktop.html \n make AIM preview \n avoid simulator requests ex: \n File:/// localstorage for FS and much much more" },
              { path:"/recommended-files", name:"RecommendedFS.txt", type:"file", ext:".txt", content:"Most of us started as a coca cola employ and I and most of us like coca cola so yeah It will be coca cola plans." },
              { path:"/recommended-files", name:"win12PreviewFinal.html", type:"file", ext:".html", content:"<iframe src=https://tjy-gitnub.github.io/win12/desktop.html></iframe>" }
            ],
            regAssociations:{
              ".txt":"notepad",
              ".md":"notepad",
              ".log":"notepad",
              ".css":"settings",
              ".html":"browser",
              ".js":"notepad",
              ".json":"notepad",
              ".exe":"host",
              ".png":"paint",
              ".jpg":"paint",
              ".jpeg":"paint",
              ".gif":"paint",
              ".mp4":"media",
              ".webm":"media",
              ".mp3":"media",
              ".wav":"media",
              ".ogg":"media",
              ".xml": "browser",
              ".svg": "browser",
              ".cmd": "cmd",
              ".bat": "cmd",
            }
          });
          state.currentUserId = id;
          saveState();
        }
      }

      function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

      ensureUser();

      function currentUser(){ return state.users.find(u=>u.id===state.currentUserId) || state.users[0]; }
      function setCurrentUser(id){ state.currentUserId=id; saveState(); refreshAll(); }
      function updateCurrentUser(updater){
        const idx = state.users.findIndex(u=>u.id===state.currentUserId);
        if(idx===-1) return;
        state.users[idx] = updater(state.users[idx]);
        saveState();
        refreshAll();
      }
      function addUser(name){
        const id = Date.now().toString(36);
        state.users.push({
          id,
          name,
          createdAt:new Date().toISOString(),
          notes:"",
          themeCss:"",
          fs:[{ path:"/desktop", name:"Welcome.txt", type:"file", ext:".txt", content:"Hello from the Win12 AIM relic.\n\nThis is your desktop Welcome.txt file."},
              { path:"/desktop", name:"Readme.md", type:"file", ext:".md", content:"# Readme\n\nThis is a markdown file in /desktop."},
              { path:"/desktop", name:"SampleApp.exe", type:"file", ext:".exe", content:"(Unsupported type or Binary)"},
              { path:"/documents", name:"Session.log", type:"file", ext:".log", content:"Session started.\nUser created.\nExplorer, Notepad, Browser, and Host.exe online."},
              { path:"/recommended-files", name:"win12PreviewPlans.txt", type:"file", ext:".txt", content:"Ideas: \n make url tjy-gitnub.github.io/win12/desktop.html \n make AIM preview \n avoid simulator requests ex: \n File:/// localstorage for FS and much much more" },
              { path:"/recommended-files", name:"RecommendedFS.txt", type:"file", ext:".txt", content:"Most of us started as a coca cola employ and I and most of us like coca cola so yeah It will be coca cola plans." },
              { path:"/recommended-files", name:"win12PreviewFinal.html", type:"file", ext:".html", content:"<iframe src=https://tjy-gitnub.github.io/win12/desktop.html></iframe>" }],
          regAssociations:{
              ".txt":"notepad",
              ".md":"notepad",
              ".log":"notepad",
              ".css":"settings",
              ".html":"browser",
              ".js":"notepad",
              ".json":"notepad",
              ".exe":"host",
              ".png":"paint",
              ".jpg":"paint",
              ".jpeg":"paint",
              ".gif":"paint",
              ".mp4":"media",
              ".webm":"media",
              ".mp3":"media",
              ".wav":"media",
              ".ogg":"media",
              ".xml": "browser",
              ".svg": "browser",
              ".cmd": "cmd",
              ".bat": "cmd",
          }
        });
        state.currentUserId=id; saveState();
      }
      function deleteUser(id){
        if(state.users.length<=1) return;
        state.users = state.users.filter(u=>u.id!==id);
        if(!state.users.find(u=>u.id===state.currentUserId)){
          state.currentUserId = state.users[0].id;
        }
        saveState();
      }

      /* DOM refs */
      const loginOverlay = document.getElementById("login-overlay");
      const userListEl = document.getElementById("user-list");
      const newUserInput = document.getElementById("new-user-name");
      const createUserBtn = document.getElementById("create-user");

      const desktopEl = document.getElementById("desktop");
      const desktopIconsEl = document.getElementById("desktop-icons");

      const taskbarImport = document.getElementById("taskbar-import");
      const fileInput = document.getElementById("file-input");
      const userChip = document.getElementById("user-chip");
      const userChipName = document.getElementById("user-chip-name");
      const startUserNameEl = document.getElementById("start-user-name");

      const startButton = document.getElementById("start-button");
      const startMenu = document.getElementById("start-menu");
      const startBackdrop = document.getElementById("start-backdrop");
      const startSearchInput = document.getElementById("start-search-input");

      const explorerSidebar = document.getElementById("explorer-sidebar");
      const explorerItemsEl = document.getElementById("explorer-items");
      const explorerPathEl = document.getElementById("explorer-path");
      const explorerNewFileBtn = document.getElementById("explorer-new-file");
      const explorerUpBtn = document.getElementById("explorer-up");
      const explorerRefreshBtn = document.getElementById("explorer-refresh");

      const notepadArea = document.getElementById("notepad-area");
      const notepadStatus = document.getElementById("notepad-status");
      const notepadTitleSub = document.getElementById("notepad-title-sub");
      const notepadSaveBtn = document.getElementById("notepad-save");

      const browserTabsEl = document.getElementById("browser-tabs");
      const browserAddressEl = document.getElementById("browser-address");
      const browserGoBtn = document.getElementById("browser-go");
      const browserViewEl = document.getElementById("browser-view");

      const hostOutputEl = document.getElementById("host-output");
      const hostTitleSub = document.getElementById("host-title-sub");

      const aiLog = document.getElementById("ai-log");
      const aiInput = document.getElementById("ai-input");
      const aiSend = document.getElementById("ai-send");

      const regListEl = document.getElementById("regedit-list");
      const regAddBtn = document.getElementById("regedit-add");
      const adminBackdrop = document.getElementById("admin-popup-backdrop");
      const adminAllow = document.getElementById("admin-allow");
      const adminCancel = document.getElementById("admin-cancel");
      const adminBody = document.getElementById("admin-popup-body");

      const themeCssInput = document.getElementById("theme-css-input");
      const themeStyleEl = document.getElementById("theme-style");
      const themeStatus = document.getElementById("theme-status");

      const notesArea = document.getElementById("notes-area");
      const notesStatus = document.getElementById("notes-status");
      const notesSaveBtn = document.getElementById("notes-save");

      const fsListEl = document.getElementById("fs-list");

      const recFilesEl = document.getElementById("rec-files");
      const recSubEl = document.getElementById("rec-sub");
      const recModeLabel = document.getElementById("rec-mode-label");
      const recToggle = document.getElementById("rec-dropdown-toggle");
      const recMenu = document.getElementById("rec-dropdown-menu");
      let recMode = "recommended";

      const clockTimeEl = document.getElementById("clock-time");
      const clockLabelEl = document.getElementById("clock-label");
      const timeFlyout = document.getElementById("time-flyout");
      const timeFlyoutTime = document.getElementById("time-flyout-time");
      const timeFlyoutDate = document.getElementById("time-flyout-date");
      const timeFlyoutGreeting = document.getElementById("time-flyout-greeting");
      const clockContainer = document.getElementById("taskbar-clock");

      const ctxMenu = document.getElementById("ctx-menu");
      const devBanner = document.getElementById("dev-banner");

      const windowsMap = {};
      document.querySelectorAll(".window").forEach(win=>windowsMap[win.dataset.app]=win);

      // Paint refs
      const paintCanvas = document.getElementById("paint-canvas");
      const paintColor = document.getElementById("paint-color");
      const paintSize = document.getElementById("paint-size");
      const paintClearBtn = document.getElementById("paint-clear");
      const paintOpenBtn = document.getElementById("paint-open-image");
      const paintFileInput = document.getElementById("paint-file-input");

      // Media refs
      const mediaOpenBtn = document.getElementById("media-open");
      const mediaFileInput = document.getElementById("media-file-input");
      const mediaSurface = document.getElementById("media-surface");
      const mediaFilename = document.getElementById("media-filename");
      
      // Desktop FS path
      let currentExplorerPath = "/desktop";
      // Camera dependencies
      const preview = document.getElementById("camera-preview");
      const playback = document.getElementById("camera-playback");
      const startBtn = document.getElementById("camera-start");
      const recordBtn = document.getElementById("camera-record");
      const pauseBtn = document.getElementById("camera-pause");
      const stopBtn = document.getElementById("camera-stop");
      const trimBtn = document.getElementById("camera-trim");
      const exportBtn = document.getElementById("camera-export");
      let mediaRecorder;
      let recordedChunks = [];
      let stream;
      // Popup elements for camera
      const camPopupBackdrop = document.getElementById("camera-popup-backdrop");
      const camPopupClose = document.getElementById("camera-popup-close");

  function openTroubleshooter() { const overlay = document.getElementById('troubleshooterOverlay'); const audio = document.getElementById('troubleshooterAudio'); overlay.style.display = 'block'; overlay.classList.add('ts-animating'); setTimeout(() => { overlay.classList.add('ts-active'); overlay.classList.remove('ts-animating'); }, 550); if (audio) { audio.currentTime = 0; audio.play().catch(() => {}); } setTsContent('home'); } function closeTroubleshooter() { const overlay = document.getElementById('troubleshooterOverlay'); const audio = document.getElementById('troubleshooterAudio'); overlay.classList.remove('ts-active'); setTimeout(() => { overlay.style.display = 'none'; }, 300); if (audio) { audio.pause(); audio.currentTime = 0; } }
      // Show popup function
      function showCameraUnsupportedPopup() {
        camPopupBackdrop.style.display = "flex";
      }

      // Close popup
      camPopupClose.addEventListener("click", () => {
        camPopupBackdrop.style.display = "none";
      });

      // Modify Start Camera button logic
      startBtn.addEventListener("click", async () => {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          preview.srcObject = stream;
        } catch (err) {
          console.error("Camera init failed:", err);

          // If device not found or blocked → show popup
          if (err.name === "NotFoundError" || err.name === "NotAllowedError") {
            showCameraUnsupportedPopup();
          }
        }
      });

      recordBtn.addEventListener("click", () => {
        if (!stream) return;
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: "video/webm" });
          playback.src = URL.createObjectURL(blob);
        };
        mediaRecorder.start();
      });

      pauseBtn.addEventListener("click", () => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.pause();
        } else if (mediaRecorder && mediaRecorder.state === "paused") {
          mediaRecorder.resume();
        }
      });

      stopBtn.addEventListener("click", () => {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
        }
      });

      trimBtn.addEventListener("click", () => {
        alert("Trim feature not yet implemented.");
      });

      exportBtn.addEventListener("click", () => {
        if (recordedChunks.length) {
          const blob = new Blob(recordedChunks, { type: "video/webm" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "recording.webm";
          a.click();
        }
      });


document.querySelectorAll(".window").forEach(win => {
  const handles = `
    <div class="window-resize-handle resize-top"></div>
    <div class="window-resize-handle resize-bottom"></div>
    <div class="window-resize-handle resize-left"></div>
    <div class="window-resize-handle resize-right"></div>
    <div class="window-resize-handle resize-corner resize-tl"></div>
    <div class="window-resize-handle resize-corner resize-tr"></div>
    <div class="window-resize-handle resize-corner resize-bl"></div>
    <div class="window-resize-handle resize-corner resize-br"></div>
  `;
  win.insertAdjacentHTML("beforeend", handles);
});



let resizing = false;
let resizeDir = "";
let startX, startY, startWidth, startHeight, startLeft, startTop;
let resizeTarget = null; // ✅ store the window being resized

document.querySelectorAll(".window-resize-handle").forEach(handle => {
  handle.addEventListener("mousedown", e => {
    e.preventDefault();
    resizeTarget = handle.closest(".window"); // ✅ set the target window
    if (!resizeTarget) return;

    resizing = true;
    resizeDir = handle.classList[1]; // e.g., resize-top, resize-br
    const rect = resizeTarget.getBoundingClientRect();
    startX = e.clientX;
    startY = e.clientY;
    startWidth = rect.width;
    startHeight = rect.height;
    startLeft = rect.left;
    startTop = rect.top;
    bringWindowToFront(resizeTarget);
  });
});

window.addEventListener("mousemove", e => {
  if (!resizing || !resizeTarget) return;

  let newWidth = startWidth;
  let newHeight = startHeight;
  let newLeft = startLeft;
  let newTop = startTop;

  const dx = e.clientX - startX;
  const dy = e.clientY - startY;

  if (resizeDir.includes("right")) newWidth = startWidth + dx;
  if (resizeDir.includes("left")) {
    newWidth = startWidth - dx;
    newLeft = startLeft + dx;
  }
  if (resizeDir.includes("bottom")) newHeight = startHeight + dy;
  if (resizeDir.includes("top")) {
    newHeight = startHeight - dy;
    newTop = startTop + dy;
  }

  // Apply minimum size
  newWidth = Math.max(300, newWidth);
  newHeight = Math.max(200, newHeight);

  resizeTarget.style.width = newWidth + "px";
  resizeTarget.style.height = newHeight + "px";
  resizeTarget.style.left = newLeft + "px";
  resizeTarget.style.top = newTop + "px";
});

window.addEventListener("mouseup", () => {
  resizing = false;
  resizeDir = "";
  resizeTarget = null; // ✅ clear reference
});

      /* clock & flyout */
      function updateClock(){
        const now = new Date();
        const h = now.getHours().toString().padStart(2,"0");
        const m = now.getMinutes().toString().padStart(2,"0");
        clockTimeEl.textContent = `${h}:${m}`;
        clockLabelEl.textContent = now.toLocaleDateString(undefined,{weekday:"short",month:"short",day:"numeric"})+" · Win12 AIM";
      }
      function updateTimeFlyout(){
        const now = new Date();
        const h = now.getHours();
        const hh = h.toString().padStart(2,"0");
        const mm = now.getMinutes().toString().padStart(2,"0");
        timeFlyoutTime.textContent = `${hh}:${mm}`;
        timeFlyoutDate.textContent = now.toLocaleDateString(undefined,{
          weekday:"long",month:"long",day:"numeric",year:"numeric"
        });
        let greeting;
        if(h<5) greeting="Late night shift.";
        else if(h<12) greeting="Good morning.";
        else if(h<17) greeting="Good afternoon.";
        else greeting="Good evening.";
        timeFlyoutGreeting.textContent = greeting+" Time is just another variable in this shrine.";
      }
      updateClock();
      setInterval(updateClock,30000);

      clockContainer.addEventListener("click",()=>{
        if(timeFlyout.style.display==="block"){
          timeFlyout.style.display="none";
        }else{
          updateTimeFlyout();
          timeFlyout.style.display="block";
        }
      });
      document.addEventListener("mousedown",(e)=>{
        if(!clockContainer.contains(e.target) && !timeFlyout.contains(e.target)){
          timeFlyout.style.display="none";
        }
      });

      /* login */
      function renderUserList(){
        userListEl.innerHTML="";
        state.users.forEach(u=>{
          const row=document.createElement("div");
          row.className="user-row";
          row.innerHTML=`
            <div class="user-info">
              <div class="user-avatar"></div>
              <div>
                <div class="user-name">${u.name}</div>
                <div class="user-meta">Created ${new Date(u.createdAt).toLocaleString()}</div>
              </div>
            </div>
            <div class="user-actions">
              <div class="pill-small">Login</div>
              ${state.users.length>1?`<div class="pill-small danger" data-delete="${u.id}">Remove</div>`:""}
            </div>`;
          row.addEventListener("click",(e)=>{
            if(e.target.dataset.delete===u.id) return;
            setCurrentUser(u.id);
            hideLogin();
          });
          const del=row.querySelector("[data-delete]");
          if(del){
            del.addEventListener("click",(e)=>{
              e.stopPropagation();
              deleteUser(u.id);
              renderUserList();
            });
          }
          userListEl.appendChild(row);
        });
      }
      function hideLogin(){
        loginOverlay.classList.add("hidden");
        setTimeout(()=>{loginOverlay.style.display="none";},260);
      }
      createUserBtn.addEventListener("click",()=>{
        const name=newUserInput.value.trim();
        if(!name)return;
        addUser(name);
        newUserInput.value="";
        renderUserList();
        hideLogin();
      });
      newUserInput.addEventListener("keydown",(e)=>{if(e.key==="Enter")createUserBtn.click();});
      renderUserList();

      /* FS + desktop */
      function renderDesktop(){
        const u=currentUser();
        desktopIconsEl.innerHTML="";
        u.fs.filter(e=>e.path==="/desktop").forEach(entry=>{
          const icon=document.createElement("div");
          icon.className="desktop-icon";
          icon.dataset.path=entry.path;
          icon.dataset.name=entry.name;
          icon.dataset.ext=entry.ext||"";
          icon.innerHTML=`<div class="desktop-icon-thumb"></div><div class="desktop-icon-label">${entry.name}</div>`;
          icon.addEventListener("dblclick",()=>openFile(entry));
          icon.addEventListener("contextmenu",(ev)=>showCtxMenu(ev,entry,entry.type==="folder"));
          desktopIconsEl.appendChild(icon);
        });
      }

      function renderNotes(){
        const u=currentUser();
        if(!notesArea || !notesStatus) return;
        notesArea.value = u.notes || "";
        notesStatus.textContent = "Loaded.";
      }

      if(notesSaveBtn){
        notesSaveBtn.addEventListener("click",()=>{
          if(!notesArea || !notesStatus) return;
          updateCurrentUser(u=>({...u,notes:notesArea.value}));
          notesStatus.textContent="Saved.";
        });
      }

      function renderTheme(){
        const u=currentUser();
        if(!themeCssInput || !themeStyleEl) return;
        themeCssInput.value=u.themeCss||"";
        themeStyleEl.textContent=u.themeCss||"";
      }
      const themeSaveBtn = document.getElementById("theme-save");
      if(themeSaveBtn){
        themeSaveBtn.addEventListener("click",()=>{
          if(!themeCssInput || !themeStyleEl || !themeStatus) return;
          const css=themeCssInput.value;
          themeStyleEl.textContent=css;
          updateCurrentUser(u=>({...u,themeCss:css}));
          themeStatus.textContent="Applied & saved.";
        });
      }

      function renderFSList(){
        const u=currentUser();
        fsListEl.innerHTML="";
        (u.fs||[]).forEach(entry=>{
          const row=document.createElement("div");
          row.className="fs-row";
          row.innerHTML=`<div class="fs-row-name">${entry.path}/${entry.name}</div><div class="fs-row-meta">${entry.ext||entry.type||""}</div>`;
          fsListEl.appendChild(row);
        });
      }

      function renderExplorer(path){
        currentExplorerPath=path;
        explorerPathEl.textContent=path;
        const u=currentUser();
        explorerItemsEl.innerHTML="";
        explorerSidebar.querySelectorAll(".explorer-tab").forEach(tab=>{
          tab.style.background=tab.dataset.path===path?"rgba(26,32,70,0.98)":"transparent";
        });
        let entries;
        if(path==="/"){
          entries=[
            {path:"/",name:"Desktop",type:"folder",ext:"",target:"/desktop"},
            {path:"/",name:"Documents",type:"folder",ext:"",target:"/documents"},
            {path:"/",name:"Recommended files",type:"folder",ext:"",target:"/recommended-files"},
            {path:"/",name:"Imported",type:"folder",ext:"",target:"/imported"}
          ];
        }else entries=u.fs.filter(e=>e.path===path);
        if(!entries.length){
          explorerItemsEl.textContent="No files or folders here.";
          return;
        }
        entries.forEach(entry=>{
          const card=document.createElement("div");
          card.className="explorer-card";
          card.style.borderRadius="8px";
          card.style.background="rgba(12,15,36,0.98)";
          card.style.border="1px solid rgba(255,255,255,0.08)";
          card.style.padding="6px";
          card.style.cursor="pointer";
          const icon=document.createElement("div");
          icon.style.width="22px";icon.style.height="22px";
          icon.style.borderRadius=entry.type==="folder"?"4px":"6px";
          icon.style.marginBottom="4px";
          icon.style.background=entry.type==="folder"
            ?"linear-gradient(135deg,#4c8dff,#94a3ff)"
            :"radial-gradient(circle at 30% 20%,#fff,#4c8dff)";
          const name=document.createElement("div");
          name.textContent=entry.name;
          name.style.color="var(--text-main)";name.style.fontSize="11px";
          const meta=document.createElement("div");
          meta.textContent=entry.type==="folder"?"Folder":(entry.ext||"File");
          meta.style.color="var(--text-soft)";meta.style.fontSize="10px";
          card.appendChild(icon);card.appendChild(name);card.appendChild(meta);
          card.addEventListener("dblclick",()=>{
            if(entry.type==="folder" && entry.target) renderExplorer(entry.target);
            else if(entry.type==="folder") renderExplorer(entry.path+"/"+entry.name);
            else openFile(entry);
          });
          card.addEventListener("contextmenu",(ev)=>showCtxMenu(ev,entry,entry.type==="folder"));
          explorerItemsEl.appendChild(card);
        });
      }

      function renderRecommendedFiles(){
        const u=currentUser();
        const path=recMode==="imported"?"/imported":"/recommended-files";
        recModeLabel.textContent=recMode==="imported"?"Imported":"Recommended";
        recSubEl.textContent=recMode==="imported"?"From /imported in your FS.":"From /recommended-files in your FS.";
        const files=u.fs.filter(e=>e.path===path);
        recFilesEl.innerHTML="";
        if(!files.length){
          recFilesEl.textContent="No files here yet.";
          return;
        }
        files.forEach(entry=>{
          const div=document.createElement("div");
          div.textContent="• "+entry.name;
          div.style.cursor="pointer";
          div.addEventListener("click",()=>openFile(entry));
          div.addEventListener("contextmenu",(ev)=>showCtxMenu(ev,entry,false));
          recFilesEl.appendChild(div);
        });
      }

      function renderRegedit(){
        const u=currentUser();
        const map=u.regAssociations||{};
        regListEl.innerHTML="";
        Object.keys(map).forEach(ext=>{
          const row=document.createElement("div");
          row.style.display="flex";
          row.style.alignItems="center";
          row.style.justifyContent="space-between";
          row.style.padding="4px 0";
          const label=document.createElement("span");
          label.textContent=ext;
          const input=document.createElement("input");
          input.value=map[ext];
          input.style.borderRadius="999px";
          input.style.border="1px solid rgba(255,255,255,0.18)";
          input.style.background="rgba(4,6,18,0.98)";
          input.style.color="var(--text-main)";
          input.style.fontSize="11px";
          input.style.padding="2px 6px";
          input.addEventListener("change",()=>{
            pendingRegEdit={ext,app:input.value};
            adminBody.textContent=`Allow changing association for ${ext} to app "${input.value}"?`;
            adminBackdrop.style.display="flex";
          });
          row.appendChild(label);row.appendChild(input);
          regListEl.appendChild(row);
        });
      }

      function refreshAll(){
        const u=currentUser();
        userChipName.textContent=u.name;
        startUserNameEl.textContent=u.name;
        renderDesktop();
        renderNotes();
        renderTheme();
        renderFSList();
        renderRecommendedFiles();
        renderExplorer(currentExplorerPath);
        renderRegedit();
      }

      /* start menu */
      function openStart(){startMenu.classList.add("visible");startBackdrop.classList.add("visible");startSearchInput.value="";}
      function closeStart(){startMenu.classList.remove("visible");startBackdrop.classList.remove("visible");}
      function toggleStart(){startMenu.classList.contains("visible")?closeStart():openStart();}
      startButton.addEventListener("click",toggleStart);
      startBackdrop.addEventListener("click",closeStart);
      document.addEventListener("mousedown",(e)=>{if(!startMenu.contains(e.target)&&!startButton.contains(e.target))closeStart();});
      startSearchInput.addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){
          const q=e.target.value.toLowerCase();
          if(q.includes("file")||q.includes("explorer"))showWindow("explorer");
          else if(q.includes("note")&& !q.includes("paint"))showWindow("notepad");
          else if(q.includes("browser")||q.includes("web"))showWindow("browser");
          else if(q.includes("host")||q.includes("exe"))showWindow("host");
          else if(q.includes("assistant")||q.includes("ai"))showWindow("assistant");
          else if(q.includes("reg"))showWindow("regedit");
          else if(q.includes("setting"))showWindow("settings");
          else if(q.includes("notes"))showWindow("notes");
          else if(q.includes("paint"))showWindow("paint");
          else if(q.includes("media")||q.includes("video")||q.includes("music"))showWindow("media");
          closeStart();
        }
      });
      document.querySelectorAll(".start-app,.start-rec-item").forEach(el=>{
        el.addEventListener("click",()=>{
          const app=el.dataset.app;
          if(app)showWindow(app);
          closeStart();
        });
      });

      /* user chip */
      userChip.addEventListener("click",()=>{
        loginOverlay.style.display="flex";
        setTimeout(()=>loginOverlay.classList.remove("hidden"),10);
        renderUserList();
      });


/* import files */
taskbarImport.addEventListener("click", () => fileInput.click());

fileInput.addEventListener("change", () => {
  const files = Array.from(fileInput.files || []);
  if (!files.length) return;

  const textTypes = [".txt", ".md", ".log", ".css", ".html", ".js", ".json", ".svg", ".xml"];
  const imageTypes = [".png", ".jpg", ".jpeg", ".gif"];
  const mediaTypes = [".mp4", ".webm", ".mp3", ".wav", ".ogg"];

  let remaining = files.length;
  const newEntries = [];

  files.forEach(f => {
    const ext = f.name.includes(".") ? f.name.slice(f.name.lastIndexOf(".")).toLowerCase() : "";

    // ✅ Images & Media → store as base64 Data URL
    if (imageTypes.includes(ext) || mediaTypes.includes(ext)) {
      const reader = new FileReader();
      reader.onload = () => {
        newEntries.push({ path: "/imported", name: f.name, type: "file", ext, content: reader.result });
        if (--remaining === 0) mergeImported(newEntries);
      };
      reader.onerror = () => {
        newEntries.push({ path: "/imported", name: f.name, type: "file", ext, content: "(failed to read file)" });
        if (--remaining === 0) mergeImported(newEntries);
      };
      reader.readAsDataURL(f); // ✅ Base64 for images & media
    }

    // ✅ Text files → store as plain text
    else if (textTypes.includes(ext)) {
      const reader = new FileReader();
      reader.onload = () => {
        newEntries.push({ path: "/imported", name: f.name, type: "file", ext, content: reader.result });
        if (--remaining === 0) mergeImported(newEntries);
      };
      reader.onerror = () => {
        newEntries.push({ path: "/imported", name: f.name, type: "file", ext, content: "(failed to read file)" });
        if (--remaining === 0) mergeImported(newEntries);
      };
      reader.readAsText(f);
    }

    // ✅ Everything else → store full binary as base64
    else {
      const reader = new FileReader();
      reader.onload = () => {
        newEntries.push({ path: "/imported", name: f.name, type: "file", ext, content: reader.result });
        if (--remaining === 0) mergeImported(newEntries);
      };
      reader.onerror = () => {
        newEntries.push({ path: "/imported", name: f.name, type: "file", ext, content: "(failed to read file)" });
        if (--remaining === 0) mergeImported(newEntries);
      };
      reader.readAsDataURL(f); // ✅ Binary files stored as base64
    }
  });
});

function mergeImported(entries) {
  updateCurrentUser(u => ({ ...u, fs: u.fs.concat(entries) }));
}


      /* context menu */
      let ctxTargetEntry=null;
      let ctxIsFolder=false;
      let clipboardEntry=null;

      function showCtxMenu(e,entry,isFolder){
        e.preventDefault();
        ctxTargetEntry=entry||null;
        ctxIsFolder=!!isFolder || (entry && entry.type==="folder");
        ctxMenu.style.display="block";
        const rect=ctxMenu.getBoundingClientRect();
        const x=Math.min(e.clientX,window.innerWidth-rect.width-4);
        const y=Math.min(e.clientY,window.innerHeight-rect.height-4);
        ctxMenu.style.left=x+"px";ctxMenu.style.top=y+"px";

        ctxMenu.querySelectorAll(".ctx-item").forEach(i=>i.classList.remove("disabled"));

        if(!ctxTargetEntry){
          ["open","openWith","openInNotepad","openInBrowser","runExe","openLocation","rename","duplicate","delete","props"]
          .forEach(a=>{
            const el=ctxMenu.querySelector(`[data-action="${a}"]`);
            if(el)el.classList.add("disabled");
          });
        }else{
          if(ctxTargetEntry.ext!==".exe"){
            const run=ctxMenu.querySelector('[data-action="runExe"]');
            if(run)run.classList.add("disabled");
          }
          if(ctxIsFolder){
            const openInNotepad=ctxMenu.querySelector('[data-action="openInNotepad"]');
            const openInBrowser=ctxMenu.querySelector('[data-action="openInBrowser"]');
            if(openInNotepad)openInNotepad.classList.add("disabled");
            if(openInBrowser)openInBrowser.classList.add("disabled");
          }
        }
        if(!clipboardEntry){
          const paste=ctxMenu.querySelector('[data-action="paste"]');
          if(paste)paste.classList.add("disabled");
        }
      }

      function hideCtxMenu(){
        ctxMenu.style.display="none";
        ctxTargetEntry=null;
      }

      document.addEventListener("mousedown",(e)=>{
        if(!ctxMenu.contains(e.target))hideCtxMenu();
      });

      desktopEl.addEventListener("contextmenu",(e)=>{
        if(e.target.closest(".desktop-icon"))return;
        showCtxMenu(e,null,false);
      });
      explorerItemsEl.addEventListener("contextmenu",(e)=>{
        if(e.target.closest(".explorer-card"))return;
        showCtxMenu(e,null,false);
      });

      ctxMenu.addEventListener("click",(e)=>{
        const item=e.target.closest(".ctx-item");
        if(!item)return;
        if(item.classList.contains("disabled"))return;
        const action=item.dataset.action;
        if(action==="open" && ctxTargetEntry)openFile(ctxTargetEntry);
        if(action==="openWith" && ctxTargetEntry)openFile(ctxTargetEntry,true);
        if(action==="openInNotepad" && ctxTargetEntry)openInNotepad(ctxTargetEntry);
        if(action==="openInBrowser" && ctxTargetEntry)openInBrowser(ctxTargetEntry);
        if(action==="runExe" && ctxTargetEntry)runExe(ctxTargetEntry);
        if(action==="openLocation" && ctxTargetEntry)openLocation(ctxTargetEntry);
        if(action==="newFile")ctxNewFile();
        if(action==="newFolder")ctxNewFolder();
        if(action==="duplicate" && ctxTargetEntry)ctxDuplicate(ctxTargetEntry);
        if(action==="copy" && ctxTargetEntry)ctxCopy(ctxTargetEntry);
        if(action==="paste")ctxPaste(ctxTargetEntry);
        if(action==="rename" && ctxTargetEntry)ctxRename(ctxTargetEntry);
        if(action==="delete" && ctxTargetEntry)ctxDelete(ctxTargetEntry);
        if(action==="props")showProps(ctxTargetEntry);
        hideCtxMenu();
      });

      function ctxNewFile(){
        const u=currentUser();
        const base="New file";
        const entry=ctxTargetEntry;
        const path=entry
          ?entry.type==="folder"?`${entry.path}/${entry.name}`:entry.path
          :currentExplorerPath;
        let counter=1;let name=base+".txt";
        const exists=(n)=>u.fs.some(e=>e.path===path&&e.name===n);
        while(exists(name)){counter++;name=`${base} (${counter}).txt`;}
        updateCurrentUser(usr=>({...usr,fs:usr.fs.concat({path,name,type:"file",ext:".txt",content:""})}));
      }

      function ctxNewFolder(){
        const u=currentUser();
        const base="New folder";
        const entry=ctxTargetEntry;
        const path=entry
          ?entry.type==="folder"?`${entry.path}/${entry.name}`:entry.path
          :currentExplorerPath;
        let counter=1;let name=base;
        const exists=(n)=>u.fs.some(e=>e.path===path&&e.name===n);
        while(exists(name)){counter++;name=`${base} (${counter})`;}
        updateCurrentUser(usr=>({...usr,fs:usr.fs.concat({path,name,type:"folder",ext:""})}));
      }

      function ctxDuplicate(entry){
        updateCurrentUser(u=>{
          const newFs=u.fs.slice();
          const base=entry.name.replace(/(\.[^.]*)$/,"");
          const ext=entry.ext||"";
          let counter=1;let name=`${base} - Copy${ext}`;
          const exists=(n)=>newFs.some(e=>e.path===entry.path&&e.name===n);
          while(exists(name)){counter++;name=`${base} - Copy (${counter})${ext}`;}
          newFs.push({...entry,name});
          return {...u,fs:newFs};
        });
      }
      function ctxCopy(entry){clipboardEntry={...entry};}
      function ctxPaste(entry){
        if(!clipboardEntry)return;
        const path=entry
          ?entry.type==="folder"?`${entry.path}/${entry.name}`:entry.path
          :currentExplorerPath;
        updateCurrentUser(u=>{
          const newFs=u.fs.slice();
          const base=clipboardEntry.name.replace(/(\.[^.]*)$/,"");
          const ext=clipboardEntry.ext||"";
          let counter=0;let name=clipboardEntry.name;
          const exists=(n)=>newFs.some(e=>e.path===path&&e.name===n);
          while(exists(name)){counter++;name=`${base} - Copy${counter>1?" ("+counter+")":""}${ext}`;}
          newFs.push({...clipboardEntry,path,name});
          return {...u,fs:newFs};
        });
      }
      function ctxDelete(entry){
        updateCurrentUser(u=>({...u,fs:u.fs.filter(e=>!(e.path===entry.path&&e.name===entry.name))}));
      }
      function ctxRename(entry) {
            const overlay = document.createElement("div");
            overlay.style.position = "fixed";
            overlay.style.inset = "0";
            overlay.style.background = "rgba(0,0,0,0.4)";
            overlay.style.backdropFilter = "blur(8px)";
            overlay.style.display = "flex";
            overlay.style.alignItems = "center";
            overlay.style.justifyContent = "center";
            overlay.style.zIndex = 1800;

            const box = document.createElement("div");
            box.style.background = "rgba(8,10,26,0.98)";
            box.style.borderRadius = "12px";
            box.style.border = "1px solid rgba(255,255,255,0.2)";
            box.style.boxShadow = "0 20px 40px rgba(0,0,0,0.9)";
            box.style.padding = "8px 10px";
            box.style.fontSize = "12px";

            box.innerHTML = `
                <div style="margin-bottom:4px;color:var(--text-soft);">Rename "${entry.name}"</div>
                <div style="display:flex;gap:6px;align-items:center;">
                    <input id="rename-input"
                        style="flex:1;padding:4px 6px;border-radius:999px;
                        border:1px solid rgba(255,255,255,0.24);
                        background:rgba(4,6,18,0.98);
                        color:var(--text-main);
                        font-size:11px;outline:none;">
                    <button class="button-small" id="rename-ok">OK</button>
                    <button class="button-small" id="rename-cancel">Cancel</button>
                </div>
            `;

            overlay.appendChild(box);
            document.body.appendChild(overlay);

            const input = box.querySelector("#rename-input");
            input.value = entry.name;
            input.focus();
            input.select();

            const cleanup = () => overlay.remove();

            function getExt(name) {
                  const idx = name.lastIndexOf(".");
                  return idx === -1 ? "" : name.slice(idx).toLowerCase();
            }

            box.querySelector("#rename-ok").addEventListener("click", () => {
                  const newName = input.value.trim();
                  if (!newName) { cleanup(); return; }

                  const oldExt = getExt(entry.name);
                  const newExt = getExt(newName);

                  // extension changed → warn user
                  if (oldExt !== newExt) {
                        const msg =
                              `You changed the file extension:\n\n` +
                              `Old: ${oldExt || "(none)"}\n` +
                              `New: ${newExt || "(none)"}\n\n` +
                              `Changing the file type may affect how the file opens.\n` +
                              `Do you want to continue?`;

                        if (!confirm(msg)) {
                              cleanup();
                              return;
                        }
                  }

                  // Apply rename + update EXT param properly
                  updateCurrentUser(u => ({
                        ...u,
                        fs: u.fs.map(f =>
                              (f.path === entry.path && f.name === entry.name)
                                    ? {
                                          ...f,
                                          name: newName,
                                          ext: newExt   // <-- EXT UPDATED HERE
                                    }
                                    : f
                        )
                  }));

                  cleanup();
            });

            box.querySelector("#rename-cancel").addEventListener("click", cleanup);
      }
      function showProps(entry){
        aiMsg("ai",`Properties: ${entry ? entry.name : "(none)"} (${entry ? (entry.ext||entry.type||"") : ""}) at ${entry ? entry.path : "(background)"}`);
        showWindow('AIM OS');
      }

      /* Notepad */
      let notepadCurrentFile=null;
      function openInNotepad(entry){
        showWindow("notepad");
        const u=currentUser();
        const match=u.fs.find(e=>e.path===entry.path&&e.name===entry.name);
        notepadCurrentFile=match||entry;
        if(notepadArea && notepadStatus && notepadTitleSub){
          notepadArea.value=(match && match.content)!=null?match.content:"(no stored content for this file)";
          notepadStatus.textContent=`Viewing: ${entry.path}/${entry.name}`;
          notepadTitleSub.textContent=entry.name;
        }
      }
      if(notepadSaveBtn){
        notepadSaveBtn.addEventListener("click",()=>{
          if(!notepadCurrentFile || !notepadArea || !notepadStatus) return;
          const file=notepadCurrentFile;
          const newContent=notepadArea.value;
          updateCurrentUser(u=>({
            ...u,
            fs:u.fs.map(e=>e.path===file.path && e.name===file.name?{...e,content:newContent}:e)
          }));
          notepadStatus.textContent="Saved to FS.";
        });
      }

      /* Browser */
      let browserTabs=[];let browserActiveTabId=null;
      function createBrowserTab(url){
        const id=Date.now().toString(36)+Math.random().toString(36).slice(2,6);
        browserTabs.push({id,url});
        browserActiveTabId=id;
        renderBrowserTabs();
        loadBrowserTab(id);
      }
      function renderBrowserTabs(){
        browserTabsEl.innerHTML="";
        browserTabs.forEach(tab=>{
          const el=document.createElement("div");
          el.style.padding="3px 8px";
          el.style.borderRadius="999px";
          el.style.border="1px solid rgba(255,255,255,0.18)";
          el.style.background=tab.id===browserActiveTabId?"rgba(76,141,255,0.4)":"rgba(8,10,26,0.98)";
          el.style.cursor="pointer";
          el.style.display="flex";
          el.style.alignItems="center";
          el.style.gap="4px";
          const label=document.createElement("span");
          label.textContent=tab.url||"New tab";
          label.style.maxWidth="120px";
          label.style.overflow="hidden";
          label.style.whiteSpace="nowrap";
          label.style.textOverflow="ellipsis";
          const closeBtn=document.createElement("span");
          closeBtn.textContent="×";
          closeBtn.style.fontSize="10px";
          closeBtn.style.opacity="0.7";
          closeBtn.style.cursor="pointer";
          closeBtn.addEventListener("click",(e)=>{
            e.stopPropagation();
            browserTabs=browserTabs.filter(t=>t.id!==tab.id);
            if(browserActiveTabId===tab.id) browserActiveTabId=browserTabs[0]?.id||null;
            renderBrowserTabs();
            if(browserActiveTabId) loadBrowserTab(browserActiveTabId); else browserViewEl.textContent="No tab open.";
          });
          el.addEventListener("click",()=>{
            browserActiveTabId=tab.id;
            loadBrowserTab(tab.id);
            renderBrowserTabs();
          });
          el.appendChild(label);el.appendChild(closeBtn);
          browserTabsEl.appendChild(el);
        });
        const plus=document.createElement("div");
        plus.textContent="+";
        plus.style.padding="3px 8px";plus.style.borderRadius="999px";plus.style.border="1px solid rgba(255,255,255,0.18)";
        plus.style.background="rgba(8,10,26,0.98)";plus.style.cursor="pointer";
        plus.addEventListener("click",()=>createBrowserTab(""));
        browserTabsEl.appendChild(plus);
      }
      function loadBrowserTab(id){
        const tab=browserTabs.find(t=>t.id===id);
        if(!tab)return;
        browserActiveTabId=id;
        browserAddressEl.value=tab.url||"";
        renderBrowserView(tab.url);
      }
      function goCurrentBrowserTab(){
        if(!browserActiveTabId){
          createBrowserTab(browserAddressEl.value.trim());
        }else{
          const url=browserAddressEl.value.trim();
          const idx=browserTabs.findIndex(t=>t.id===browserActiveTabId);
          if(idx!==-1){
            browserTabs[idx].url=url;
            renderBrowserTabs();
            renderBrowserView(url);
          }
        }
      }
      browserGoBtn.addEventListener("click",goCurrentBrowserTab);
      browserAddressEl.addEventListener("keydown",(e)=>{if(e.key==="Enter")goCurrentBrowserTab();});

async function isReallyOnline() {
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 2500); // ~2.5s timeout

    // ✅ Ping your real site and real asset (SVG)
    await fetch("https://alaricholt677.github.io/win12-icon.svg", {
      method: "GET",
      cache: "no-store",
      mode: "no-cors",      // allow opaque success; we only care that the network is reachable
      signal: controller.signal
    });

    clearTimeout(timeout);
    return true;            // ✅ Request left the browser → online
  } catch {
    return false;           // ❌ Network failed / DNS / timeout → offline
  }
}

async function renderBrowserView(url) {
  browserViewEl.innerHTML = "";

  if (!url) {
    // Homepage logic (srcdoc HTML)
    const homepageHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Edge Offline Homepage</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    margin: 0;
    font-family: "Segoe UI", sans-serif;
    background: #f3f2f1;
  }

  .topbar {
    background: #ffffff;
    padding: 14px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid #e1dfdd;
  }

  .logo {
    font-size: 20px;
    font-weight: 600;
    color: #0078d4;
  }

  .addressbar {
    flex: 1;
    display: flex;
    align-items: center;
    background: #ffffff;
    border: 1px solid #d2d0ce;
    border-radius: 999px;
    padding: 6px 14px;
  }

  .addressbar input {
    flex: 1;
    border: none;
    outline: none;
    font-size: 14px;
  }

  .addressbar button {
    background: #0078d4;
    color: white;
    border: none;
    border-radius: 999px;
    padding: 6px 14px;
    cursor: pointer;
    font-size: 13px;
  }

  .quicklinks {
    padding: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 16px;
  }

  .ql-item {
    background: #ffffff;
    border: 1px solid #e1dfdd;
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    cursor: pointer;
    transition: 0.15s;
  }

  .ql-item:hover {
    background: #f5f9ff;
    border-color: #c7e0f4;
  }
</style>
</head>

<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="logo">Edge</div>

  <div class="addressbar">
    <input id="addr" placeholder="Enter a URL">
    <button onclick="
      var u = document.getElementById('addr').value;
      if(u.indexOf('://') === -1){ u = 'https://' + u; }
      location.href = u;
    ">Go</button>
  </div>
</div>

<!-- QUICK LINKS -->
<div class="quicklinks">
  <div class="ql-item" onclick="location.href='https://www.bing.com'">Bing</div>
  <div class="ql-item" onclick="location.href='https://www.microsoft.com'">Microsoft</div>
  <div class="ql-item" onclick="location.href='https://www.office.com'">Office</div>
  <div class="ql-item" onclick="location.href='https://www.xbox.com'">Xbox</div>
  <div class="ql-item" onclick="location.href='https://www.github.com'">GitHub</div>
</div>

</body>
</html>

    `;
    const iframe = document.createElement("iframe");
    iframe.srcdoc = homepageHTML;
    iframe.style.width = "100%";
    iframe.style.height = "100%";
    iframe.style.border = "none";
    browserViewEl.appendChild(iframe);
    return;
  }

  // ✅ Always allow file:/// paths
  if (url.startsWith("file:///")) {
    renderFileUrl(url);
    return;
  }

  // ✅ Check connectivity
  const online = await isReallyOnline();

  if (!online) {
    const attemptedUrl = url || window.location.href;
    const offlineHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>You’re not connected</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f2f1;
      --card-bg: #ffffff;
      --primary: #0078d4;
      --primary-soft: #cfe6f8;
      --primary-deep: #005a9e;
      --text-main: #201f1e;
      --text-soft: #605e5c;
      --text-muted: #8a8886;
      --border-soft: #e1dfdd;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.08);
      --radius-lg: 18px;
      --radius-pill: 999px;
      --focus-ring: 0 0 0 3px rgba(0, 120, 212, 0.35);
      --plug-stroke: #0078d4;
      --plug-fill: #ffffff;
      --plug-muted: #b3daf6;
      --error-accent: #d83b01;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #f5f7fb 0, #f3f2f1 40%, #ecebe9 100%);
      color: var(--text-main);
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .shell {
      width: 100%;
      max-width: 960px;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 32px;
      align-items: center;
      background: linear-gradient(135deg, #ffffff 0, #fbfbfc 40%, #f6f8fb 100%);
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255, 255, 255, 0.85);
      padding: 32px 32px 28px;
      position: relative;
      overflow: hidden;
    }

    @media (max-width: 800px) {
      .shell {
        grid-template-columns: minmax(0, 1fr);
        padding: 24px 20px 20px;
      }
      body {
        align-items: stretch;
      }
    }

    .shell::before {
      content: "";
      position: absolute;
      inset: -60%;
      background:
        radial-gradient(circle at top left, rgba(0, 120, 212, 0.06) 0, transparent 55%),
        radial-gradient(circle at bottom right, rgba(0, 120, 212, 0.04) 0, transparent 60%);
      pointer-events: none;
      opacity: 0.9;
    }

    .shell-inner {
      position: relative;
      z-index: 1;
      display: contents;
    }

    .left-panel {
      padding-right: 12px;
      min-width: 0;
    }

    .badge-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 12px;
      border-radius: var(--radius-pill);
      background: rgba(0, 120, 212, 0.06);
      color: var(--primary-deep);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
      border: 1px solid rgba(0, 120, 212, 0.1);
      backdrop-filter: blur(10px);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: radial-gradient(circle, #00cc6a 0, #13a10e 55%, #10893e 100%);
      box-shadow:
        0 0 0 4px rgba(19, 161, 14, 0.16),
        0 0 10px rgba(19, 161, 14, 0.7);
    }

    .badge-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    h1 {
      margin: 0 0 6px;
      font-weight: 600;
      font-size: 28px;
      letter-spacing: 0.01em;
    }

    .subtitle {
      margin: 0 0 16px;
      color: var(--text-soft);
      font-size: 14px;
      line-height: 1.4;
    }

    .url-pill {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 6px 10px 6px 12px;
      border-radius: var(--radius-pill);
      background: #f3f2f1;
      border: 1px solid #e1dfdd;
      margin: 0 0 18px;
    }

    .url-pill-left {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .url-dot {
      width: 8px;
      height: 8px;
      border-radius: 99px;
      background: #f7630c;
    }

    .url-text {
      font-size: 13px;
      color: var(--text-soft);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .url-status {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .hint {
      margin: 0 0 16px;
      font-size: 13px;
      color: var(--text-soft);
    }

    .hint strong {
      font-weight: 600;
      color: var(--text-main);
    }

    .list {
      margin: 0 0 22px;
      padding-left: 18px;
    }

    .list li {
      margin-bottom: 4px;
      font-size: 13px;
      color: var(--text-soft);
    }

    .list li strong {
      font-weight: 600;
      color: var(--text-main);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 14px;
    }

    .btn {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-width: 120px;
      padding: 8px 18px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--primary-deep);
      background: radial-gradient(circle at top left, #5cb8ff 0, #0078d4 50%, #005a9e 100%);
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, background 0.12s ease-out;
      box-shadow: 0 6px 18px rgba(0, 120, 212, 0.35);
      user-select: none;
    }

    .btn::after {
      content: "";
      position: absolute;
      inset: 1px;
      border-radius: inherit;
      border: 1px solid rgba(255, 255, 255, 0.26);
      pointer-events: none;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0, 120, 212, 0.45);
      background: radial-gradient(circle at top left, #7fc6ff 0, #0a84ff 45%, #005a9e 100%);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(0, 120, 212, 0.3);
    }

    .btn:focus-visible {
      outline: none;
      box-shadow: 0 6px 18px rgba(0, 120, 212, 0.35), var(--focus-ring);
    }

    .btn-ghost {
      border-color: #e1dfdd;
      background: rgba(255, 255, 255, 0.4);
      color: var(--text-main);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    .btn-ghost::after {
      border-color: rgba(255, 255, 255, 0.7);
    }

    .btn-ghost:hover {
      background: #ffffff;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .btn-ghost-icon {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid #a19f9d;
      position: relative;
      display: inline-block;
    }

    .btn-ghost-icon::before {
      content: "";
      position: absolute;
      inset: 3px;
      border-radius: 2px;
      background: linear-gradient(135deg, #4cd964, #19a636);
    }

    .keyboard-hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    .keyboard-key {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      padding: 1px 5px;
      border: 1px solid #d2d0ce;
      background: #ffffff;
      box-shadow: 0 1px 0 rgba(255, 255, 255, 0.7);
      font-size: 10px;
      margin: 0 2px;
    }

    .footnote {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .right-panel {
      min-width: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .scene-wrap {
      position: relative;
      width: 100%;
      max-width: 380px;
      aspect-ratio: 5 / 4;
      border-radius: 22px;
      overflow: hidden;
      background: radial-gradient(circle at top, #f4f8ff 0, #e1efff 30%, #d6e3f7 60%, #cfd8e6 100%);
      border: 1px solid rgba(255, 255, 255, 0.9);
      box-shadow:
        0 14px 40px rgba(0, 0, 0, 0.12),
        0 0 0 1px rgba(255, 255, 255, 0.6) inset;
    }

    .scene-top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 7px 12px 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 10px;
      color: var(--text-soft);
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0.95), rgba(244, 247,255, 0.98));
      border-bottom: 1px solid rgba(209, 209, 211, 0.7);
      z-index: 3;
    }

    .scene-dots {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .scene-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #e1dfdd;
      position: relative;
      overflow: hidden;
    }

    .scene-dot.scene-dot-active {
      background: linear-gradient(135deg, #24c2ff, #0078d4);
      box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.22);
    }

    .scene-dot.scene-dot-warn {
      background: linear-gradient(135deg, #ffc640, #d83b01);
      box-shadow: 0 0 0 3px rgba(216, 59, 1, 0.16);
    }

    .scene-title {
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      opacity: 0.8;
    }

    .scene-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--text-muted);
    }

    .scene-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      border: 1px solid #d2d0ce;
      background: #ffffff;
      position: relative;
      overflow: hidden;
    }

    .scene-status-dot::after {
      content: "";
      position: absolute;
      inset: 1px;
      border-radius: inherit;
      background: repeating-linear-gradient(
        135deg,
        rgba(209, 52, 56, 0.9),
        rgba(209, 52, 56, 0.9) 2px,
        rgba(255, 255, 255, 0.9) 2px,
        rgba(255, 255, 255, 0.9) 4px
      );
      opacity: 0.9;
    }

    .ground {
      position: absolute;
      inset: 60% 0 0;
      background: linear-gradient(to bottom, #f1f5ff 0, #e1e7f3 40%, #d3d8e3 100%);
      border-top: 1px solid #c1c7d7;
      z-index: 1;
    }

    .ground::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 30% 0, rgba(255, 255, 255, 0.8) 0, transparent 45%),
        radial-gradient(circle at 70% 10%, rgba(255, 255, 255, 0.65) 0, transparent 55%);
      opacity: 0.8;
    }

    .ground-line {
      position: absolute;
      left: 10%;
      right: 10%;
      top: 18%;
      height: 0;
      border-top: 1px dashed rgba(96, 94, 92, 0.25);
    }

    .ground-notch {
      position: absolute;
      width: 32%;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(to right, rgba(255, 255, 255, 0), rgba(0, 0, 0, 0.12), rgba(255, 255, 255, 0));
      left: 34%;
      top: 24%;
      opacity: 0.7;
    }

    .cloud {
      position: absolute;
      background: #ffffff;
      border-radius: 999px;
      box-shadow: 0 4px 10px rgba(119, 143, 188, 0.3);
      z-index: 0;
    }

    .cloud.cloud-1 {
      width: 120px;
      height: 34px;
      top: 20%;
      left: 7%;
    }

    .cloud.cloud-2 {
      width: 90px;
      height: 28px;
      top: 12%;
      right: 16%;
    }

    .cloud.cloud-3 {
      width: 70px;
      height: 24px;
      top: 30%;
      right: 6%;
      opacity: 0.8;
    }

    .cloud::before,
    .cloud::after {
      content: "";
      position: absolute;
      border-radius: 999px;
      background: inherit;
    }

    .cloud::before {
      width: 45%;
      height: 140%;
      top: -45%;
      left: 8%;
    }

    .cloud::after {
      width: 50%;
      height: 155%;
      top: -55%;
      right: 0;
    }

    .plug-orbit {
      position: absolute;
      z-index: 2;
      inset: 24% 14% auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .plug-orbit-circle {
      width: 74%;
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      border: 1px dashed rgba(0, 120, 212, 0.3);
      border-top-color: rgba(216, 59, 1, 0.7);
      border-right-color: rgba(0, 120, 212, 0.7);
      transform: rotate(-18deg);
      position: relative;
      box-shadow: 0 14px 36px rgba(0, 0, 0, 0.08);
      background: radial-gradient(circle at 30% 0, rgba(255, 255, 255, 0.75) 0, transparent 60%);
    }

    .plug-badge {
      position: absolute;
      top: 4%;
      right: 10%;
      padding: 3px 7px 3px 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(216, 59, 1, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 9px;
      color: var(--error-accent);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      backdrop-filter: blur(6px);
      box-shadow: 0 4px 10px rgba(216, 59, 1, 0.16);
    }

    .plug-badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background:
        radial-gradient(circle, #ffc640 0, #ff8c00 45%, #d83b01 100%);
      box-shadow: 0 0 0 3px rgba(255, 145, 0, 0.25);
    }

    .plug-glow {
      position: absolute;
      inset: 18%;
      border-radius: inherit;
      background:
        radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.9) 0, transparent 55%),
        radial-gradient(circle at 70% 80%, rgba(49, 130, 206, 0.4) 0, transparent 65%);
      opacity: 0.9;
      pointer-events: none;
    }

    .plug-svg-wrap {
      position: absolute;
      inset: 18%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .plug-shadow {
      position: absolute;
      inset: auto 18% 6%;
      height: 12%;
      border-radius: 999px;
      background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.26) 0, rgba(0, 0, 0, 0.02) 60%, transparent 70%);
      opacity: 0.75;
      filter: blur(1px);
    }

    .edge-orbit-pill {
      position: absolute;
      inset: auto 24% 7%;
      height: 22px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(0, 120, 212, 0.1), rgba(0, 120, 212, 0.02));
      border: 1px solid rgba(0, 120, 212, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 0 8px;
      font-size: 10px;
      color: var(--primary-deep);
      box-shadow: 0 7px 16px rgba(0, 0, 0, 0.18);
      backdrop-filter: blur(8px);
    }

    .edge-orbit-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: conic-gradient(
        from 210deg,
        #0f6feb,
        #54e1ff,
        #00cc6a,
        #0f6feb
      );
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8);
    }

    .edge-orbit-text-sub {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .scene-foot {
      position: absolute;
      inset: auto 10px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 9px;
      color: rgba(32, 31, 30, 0.6);
      z-index: 2;
    }

    .scene-foot-left {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .scene-foot-pill {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(209, 209, 211, 0.7);
    }

    .scene-foot-key {
      padding: 0 4px;
      border-radius: 3px;
      border: 1px solid rgba(209, 209, 211, 0.8);
      background: rgba(255, 255, 255, 0.95);
    }

    .scene-foot-right {
      display: flex;
      align-items: center;
      gap: 4px;
      opacity: 0.8;
    }

    .scene-foot-signal {
      display: inline-flex;
      align-items: flex-end;
      gap: 1px;
    }

    .scene-foot-signal span {
      width: 2px;
      border-radius: 99px;
      background: #c8c6c4;
    }

    .scene-foot-signal span:nth-child(1) {
      height: 4px;
    }

    .scene-foot-signal span:nth-child(2) {
      height: 6px;
    }

    .scene-foot-signal span:nth-child(3) {
      height: 9px;
    }

    .scene-foot-signal span:nth-child(4) {
      height: 12px;
      background: #d83b01;
    }
  </style>
</head>
<body>
  <main class="shell" role="main" aria-label="Offline page">
    <div class="shell-inner">
      <section class="left-panel">
        <div class="badge-row">
          <div class="badge">
            <span class="badge-dot"></span>
            <span>Offline mode</span>
          </div>
          <div class="badge-sub">Edge-style relic &bull; Local only &bull; No tracking</div>
        </div>

        <h1>You’re not connected</h1>
        <p class="subtitle">
          It looks like this page isn’t available right now. When you’re back online, we’ll try again.
        </p>

        <div class="url-pill" aria-label="Connection status">
          <div class="url-pill-left">
            <span class="url-dot"></span>
            <span class="url-text">${attemptedUrl}</span>
          </div>
          <span class="url-status">No internet</span>
        </div>

        <p class="hint">
          <strong>Try this:</strong>
        </p>
        <ul class="list">
          <li><strong>Check your network cable, modem, and router.</strong></li>
          <li>Reconnect to <strong>Wi‑Fi</strong> or your mobile network.</li>
          <li>Make sure <strong>airplane mode</strong> is turned off.</li>
          <li>Run your system’s <strong>network troubleshooter</strong>.</li>
        </ul>

        <div class="btn-row">
          <button
            class="btn"
            type="button"
            onclick="location.href = ${attemptedUrl}"
          >
            <span>Try again</span>
          </button>

          <button
            class="btn btn-ghost"
            type="button"
            onclick="alert('Offline relic.\n\nAttempted URL:\n' + ${attemptedUrl})"
          >
            <span class="btn-ghost-icon"></span>
            <span>Stay offline</span>
          </button>
        </div>

        <div class="keyboard-hint">
          Press
          <span class="keyboard-key">F5</span>
          or
          <span class="keyboard-key">Ctrl</span> + <span class="keyboard-key">R</span>
          to retry the page.
        </div>

        <p class="footnote">
          You’re viewing a standalone HTML relic inspired by Microsoft Edge’s offline page. All visuals are locally rendered.
        </p>
      </section>

      <section class="right-panel" aria-hidden="true">
        <div class="scene-wrap">
          <div class="scene-top-bar">
            <div class="scene-dots">
              <div class="scene-dot"></div>
              <div class="scene-dot scene-dot-warn"></div>
              <div class="scene-dot scene-dot-active"></div>
            </div>
            <div class="scene-title">Connection</div>
            <div class="scene-status">
              <span class="scene-status-dot"></span>
              <span>${attemptedUrl}</span>
            </div>
          </div>

          <div class="cloud cloud-1"></div>
          <div class="cloud cloud-2"></div>
          <div class="cloud cloud-3"></div>

          <div class="ground">
            <div class="ground-line"></div>
            <div class="ground-notch"></div>
          </div>

          <div class="plug-orbit">
            <div class="plug-orbit-circle">
              <div class="plug-badge">
                <span class="plug-badge-dot"></span>
                <span>Cable unplugged</span>
              </div>
              <div class="plug-glow"></div>

              <div class="plug-svg-wrap">
                <!-- Inline plug SVG -->
                <svg
                  viewBox="0 0 120 120"
                  width="100%"
                  height="100%"
                  aria-hidden="true"
                >
                  <defs>
                    <linearGradient id="plugBody" x1="0%" y1="0%" x2="0%" y2="100%">
                      <stop offset="0%" stop-color="#ffffff" />
                      <stop offset="100%" stop-color="#dbeeff" />
                    </linearGradient>
                    <linearGradient id="plugWire" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stop-color="#0078d4" />
                      <stop offset="50%" stop-color="#00a4ef" />
                      <stop offset="100%" stop-color="#50e6ff" />
                    </linearGradient>
                  </defs>

                  <!-- Curved cable -->
                  <path
                    d="M 16 88
                       C 32 76, 36 64, 40 52
                       S 60 30, 84 30
                       C 102 30, 110 38, 112 46"
                    fill="none"
                    stroke="url(#plugWire)"
                    stroke-width="5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    opacity="0.9"
                  />
                  <!-- Cable highlight -->
                  <path
                    d="M 18 88
                       C 34 76, 38 64, 42 52
                       S 60 30, 84 30"
                    fill="none"
                    stroke="#ffffff"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    opacity="0.9"
                  />

                  <!-- Plug body -->
                  <g transform="translate(34,46)">
                    <!-- Body main -->
                    <rect
                      x="0"
                      y="10"
                      width="44"
                      height="34"
                      rx="9"
                      ry="9"
                      fill="url(#plugBody)"
                      stroke="#c5d7ea"
                      stroke-width="1.4"
                    />
                    <!-- Inner bevel -->
                    <rect
                      x="1.8"
                      y="11.8"
                      width="40.4"
                      height="30.4"
                      rx="7.6"
                      ry="7.6"
                      fill="none"
                      stroke="rgba(0,0,0,0.06)"
                      stroke-width="1.2"
                    />

                    <!-- Top ring -->
                    <rect
                      x="8"
                      y="4"
                      width="28"
                      height="10"
                      rx="4"
                      ry="4"
                      fill="#f3f8fd"
                      stroke="#c5d7ea"
                      stroke-width="1.2"
                    />

                    <!-- Prongs -->
                    <rect x="11" y="0" width="4" height="10" rx="2" fill="#f9fafc" stroke="#c5d7ea" stroke-width="1.1" />
                    <rect x="29" y="0" width="4" height="10" rx="2" fill="#f9fafc" stroke="#c5d7ea" stroke-width="1.1" />

                    <!-- Face: eyes -->
                    <circle cx="16" cy="26" r="2.2" fill="#384149" />
                    <circle cx="28" cy="26" r="2.2" fill="#384149" />

                    <!-- Face: mouth -->
                    <path
                      d="M 18 32
                         Q 22 29, 26 32"
                      fill="none"
                      stroke="#d83b01"
                      stroke-width="1.4"
                      stroke-linecap="round"
                    />

                    <!-- Lower shadow -->
                    <path
                      d="M 4 34
                         Q 22 40, 40 34
                         L 40 37
                         Q 22 43, 4 37
                         Z"
                      fill="rgba(0,0,0,0.05)"
                      opacity="0.7"
                    />
                  </g>

                  <!-- Plug collar -->
                  <g transform="translate(46,82)">
                    <rect
                      x="-4"
                      y="0"
                      width="16"
                      height="10"
                      rx="4"
                      fill="#ffffff"
                      stroke="#c5d7ea"
                      stroke-width="1.1"
                    />
                    <rect
                      x="-2"
                      y="2"
                      width="12"
                      height="6"
                      rx="3"
                      fill="rgba(0,120,212,0.09)"
                      stroke="rgba(0,120,212,0.3)"
                      stroke-width="0.9"
                    />
                  </g>

                  <!-- Ambient ellipse -->
                  <ellipse
                    cx="52"
                    cy="94"
                    rx="22"
                    ry="7"
                    fill="rgba(0,0,0,0.18)"
                    opacity="0.3"
                  />
                </svg>
              </div>

              <div class="plug-shadow"></div>
            </div>
          </div>

          <div class="edge-orbit-pill">
            <div class="edge-orbit-dot"></div>
            <span>Edge-style offline scene</span>
            <span class="edge-orbit-text-sub">Local render</span>
          </div>

          <div class="scene-foot">
            <div class="scene-foot-left">
              <div class="scene-foot-pill">
                Press <span class="scene-foot-key">Space</span> to imagine surfing
              </div>
            </div>
            <div class="scene-foot-right">
              <div class="scene-foot-signal">
                <span></span><span></span><span></span><span></span>
              </div>
              <span>No signal</span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>
</body>
</html>

    `;
    const iframe = document.createElement("iframe");
    iframe.src = "data:text/html;charset=utf-8," + encodeURIComponent(offlineHTML);
    iframe.style.width = "100%";
    iframe.style.height = "100%";
    iframe.style.border = "none";
    browserViewEl.appendChild(iframe);
    return;
  }

  // ✅ Normal behavior for http/https
  if (url.startsWith("http://") || url.startsWith("https://")) {
    const iframe = document.createElement("iframe");
    iframe.src = url;
    iframe.style.width = "100%";
    iframe.style.height = "100%";
    iframe.style.border = "none";
    browserViewEl.appendChild(iframe);
    return;
  }

  // ✅ Treat as search query
  const query = encodeURIComponent(url);
  const searchUrl = `https://www.bing.com/search?q=${query}`;
  const iframe = document.createElement("iframe");
  iframe.src = searchUrl;
  iframe.style.width = "100%";
  iframe.style.height = "100%";
  iframe.style.border = "none";
  browserViewEl.appendChild(iframe);
}


      function filePathFromUrl(url){
        const raw=url.replace("file:///","");
        const parts=raw.split("/").filter(Boolean);
        if(parts.length===0)return{path:"/",name:""};
        const root="/"+parts[0];
        if(parts.length===1)return{path:root,name:""};
        const name=parts.slice(1).join("/");
        return{path:root,name};
      }
      function renderFileUrl(url){
        const u = currentUser();
        const { path, name } = filePathFromUrl(url);

        // -----------------------------
        // FOLDER VIEW (unchanged)
        // -----------------------------
        if (!name) {
          const list = u.fs.filter(e => e.path === path);
          const container = document.createElement("div");
          container.style.padding = "6px";

          if (!list.length) {
            container.textContent = `No entries in ${path}.`;
          } else {
            list.forEach(entry => {
              const btn = document.createElement("button");
              btn.textContent = entry.name + (entry.type === "folder" ? " /" : "");
              btn.className = "button-small";
              btn.style.margin = "2px 4px 2px 0";

              btn.addEventListener("click", () => {
                const newUrl = url.endsWith("/") ? url + entry.name : url + "/" + entry.name;
                browserAddressEl.value = newUrl;
                goCurrentBrowserTab();
              });

              container.appendChild(btn);
            });
          }

          browserViewEl.appendChild(container);
          return;
        }

        // -----------------------------
        // FILE VIEW (updated only here)
        // -----------------------------
        const entry = u.fs.find(e => e.path === path && e.name === name);
        if (!entry) {
          browserViewEl.textContent = `No such file: ${path}/${name}`;
          return;
        }

        // Create iframe to render file content as real HTML
        const frame = document.createElement("iframe");
        frame.style.width = "100%";
        frame.style.height = "100%";
        frame.style.border = "none";
        frame.style.background = "white";

        // Render file content directly
        frame.srcdoc = entry.content || "<h3>(empty file)</h3>";

        browserViewEl.appendChild(frame);
      }

      function browserOpenFile(entry){
        const basePath=entry.path.replace(/^\//,"");
        const url=`file:///${basePath}/${entry.name}`;
        if(!browserActiveTabId)createBrowserTab(url);
        else{
          browserAddressEl.value=url;
          goCurrentBrowserTab();
        }
      }
      function openInBrowser(entry){
        const ext=(entry.ext||"").toLowerCase();
        if(ext===".html" || ext===".htm" || ext===".txt" || ext===".md" || ext===".log" || ext===".png" || ext===".svg" || ext===".xml" || ext===".js" || ext===".css" || ext===".jpg" || ext===".json"){
          showWindow("browser");
          browserOpenFile(entry);
        }else{
          showWindow("browser");
          browserOpenFile(entry);
        }
      }

      /* Host.exe */
      function runExe(entry){
        showWindow("host");
        const u=currentUser();
        const match=u.fs.find(e=>e.path===entry.path&&e.name===entry.name);
        const node=match||entry;
        if(!node.exePayloadBase64){
          hostOutputEl.textContent="This .exe has no exePayloadBase64 field.";
          hostTitleSub.textContent=`Idle · ${entry.name}`;
          return;
        }
        let html="";
        try{ html=atob(node.exePayloadBase64); }
        catch{
          hostOutputEl.textContent="Failed to decode base64 payload.";
          hostTitleSub.textContent=`Idle · ${entry.name}`;
          return;
        }
        hostTitleSub.textContent=`Running: ${entry.name}`;
        hostOutputEl.innerHTML="";
        const iframe=document.createElement("iframe");
        iframe.style.border="none";iframe.style.width="100%";iframe.style.height="260px";
        iframe.srcdoc=html;
        hostOutputEl.appendChild(iframe);
        const info=document.createElement("div");
        info.style.marginTop="6px";info.style.fontSize="10px";info.style.color="var(--text-dim)";
        info.textContent="This HTML is decoded from exePayloadBase64 and rendered in an iframe srcdoc. Real executables are not run.";
        hostOutputEl.appendChild(info);
      }

      /* associations + open */
      function defaultAppForExt(ext){
        const u=currentUser();
        const map=u.regAssociations||{};
        return map[ext]||"notepad";
      }
      function openLocation(entry){
        renderExplorer(entry.path);
        showWindow("explorer");
      }

function openFile(entry, chooseApp) {
  const ext = (entry.ext || "").toLowerCase();
  let app = defaultAppForExt(ext);

  // Cycle through apps if "Open with..." was chosen
  if (chooseApp) {
    if (app === "notepad") app = "paint";
    else if (app === "paint") app = "media";
    else if (app === "media") app = "browser";
    else if (app === "browser") app = "host";
    else app = "notepad";
  }

  // === Handle each app type ===
  if (app === "notepad") {
    openInNotepad(entry);

  } else if (app === "browser" && (ext === ".html" || ext === ".htm" || ext === ".txt" || ext === ".md" || ext === ".log" || ext===".png" || ext===".svg" || ext===".xml" || ext===".js" || ext===".css" || ext===".jpg" || ext===".json")) {
    showWindow("browser");
    openInBrowser(entry);

  } else if (app === "host" && ext === ".exe") {
    runExe(entry);

  } else if (app === "settings" && ext === ".css") {
    showWindow("settings");
    if (themeCssInput) {
      themeCssInput.value = `/* from ${entry.name} */\n` + (themeCssInput.value || "");
    }

  } else if (app === "paint" && (ext === ".png" || ext === ".jpg" || ext === ".jpeg" || ext === ".gif")) {
    showWindow("paint");
    renderImageInPaint(entry);

  } else if (app === "media" && (ext === ".mp4" || ext === ".webm" || ext === ".mp3" || ext === ".wav" || ext === ".ogg")) {
    showWindow("media");
    renderMediaInPlayer(entry);
  } else if (app === "cmd" && (ext === ".cmd" || ext === ".bat")) {
      showWindow("cmd");

      // optional: auto-run script after opening CMD
      const u = currentUser();
      const f = u.fs.find(e => e.path === entry.path && e.name === entry.name);

      if (f && typeof window.runVirtualScript === "function") {
            const win = windowsMap["cmd"];
            const container = win.querySelector("#cmd-core");

            // wait for MiniCMD initialization
            setTimeout(() => {
                  if (window.cmdInstances && window.cmdInstances["cmd_main"]) {
                        const inst = window.cmdInstances["cmd_main"];
                        inst.print(`Executing ${entry.name}...`);
                        window.runVirtualScript(f.content, inst.print, inst.run);
                  }
            }, 60);
      }
  } else {
    // Fallback for unsupported types
    showWindow("assistant");
    aiMsg("ai", `I would open "${entry.name}" with app "${app}" in a fuller build. Here I log it instead.`);
  }
}


function renderImageInPaint(entry) {
  if (!paintCanvas || !entry.content) {
    aiMsg("ai", `Paint opened, but ${entry.name} has no image data.`);
    return;
  }

  const ctx = paintCanvas.getContext("2d");
  const img = new Image();
  img.onload = function () {
    ctx.fillStyle = "#0b1020";
    ctx.fillRect(0, 0, paintCanvas.width, paintCanvas.height);

    const scale = Math.min(paintCanvas.width / img.width, paintCanvas.height / img.height);
    const w = img.width * scale;
    const h = img.height * scale;
    const x = (paintCanvas.width - w) / 2;
    const y = (paintCanvas.height - h) / 2;
    ctx.drawImage(img, x, y, w, h);
  };

  img.src = entry.content; // Base64 from FS
}


function renderMediaInPlayer(entry) {
  if (!mediaSurface || !entry.content) {
    aiMsg("ai", `Media Player opened, but ${entry.name} has no playable content.`);
    return;
  }

  mediaSurface.innerHTML = "";
  mediaFilename.textContent = entry.name;

  const url = entry.content.startsWith("data:")
    ? entry.content // Base64 Data URL
    : URL.createObjectURL(new Blob([entry.content]));

  if (entry.ext === ".mp4" || entry.ext === ".webm") {
    const video = document.createElement("video");
    video.src = url;
    video.controls = true;
    video.autoplay = true;
    video.style.maxWidth = "100%";
    mediaSurface.appendChild(video);
  } else if (entry.ext === ".mp3" || entry.ext === ".wav" || entry.ext === ".ogg") {
    const audio = document.createElement("audio");
    audio.src = url;
    audio.controls = true;
    audio.autoplay = true;
    mediaSurface.appendChild(audio);
  } else {
    mediaSurface.textContent = "Unsupported media type.";
  }
}

/* AIM OS */
function aiMsg(role, text){
  if(!aiLog) return;

  // --- PLAY TROUBLESHOOTER SOUND ---
  if(text.includes("<<PLAY_TROUBLESHOOTER_SOUND>>")){
    const audio = document.getElementById("troubleshooterAudio");
    if(audio){
      audio.pause();
      audio.currentTime = 0;
      audio.play().catch(()=>{});
    }
    text = text.replace("<<PLAY_TROUBLESHOOTER_SOUND>>", "");
  }

  // --- FACTORY RESET ---
  if(text.includes("<<AIM_FACTORY_RESET>>")){
    localStorage.removeItem("win12_aim_fs_state_exe_ctx_full_v3");

    // AI speaks the result
    aiMsg("aim", "System ritual complete. All data has been cleared.");

    text = text.replace("<<AIM_FACTORY_RESET>>", "");
  }

  // --- EXPORT SESSION ---
  if(text.includes("<<AIM_EXPORT_SESSION>>")){
    const data = localStorage.getItem("win12_aim_fs_state_exe_ctx_full_v3") || "{}";
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "session.win12.lock";
    a.click();

    URL.revokeObjectURL(url);

    // AI speaks
    aiMsg("aim", "Your session has been exported as session.win12.lock.");

    text = text.replace("<<AIM_EXPORT_SESSION>>", "");
  }

  // --- IMPORT SESSION ---
  if(text.includes("<<AIM_IMPORT_SESSION>>")){
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".win12.lock";

    input.onchange = (e)=>{
      const file = e.target.files[0];
      if(!file){
        aiMsg("aim", "No file selected.");
        return;
      }

      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          localStorage.setItem("win12_aim_fs_state_exe_ctx_full_v3", reader.result);
          aiMsg("aim", "Session imported successfully.");
        }catch(err){
          aiMsg("aim", "Import failed. The file may be corrupted.");
        }
      };

      reader.readAsText(file);
    };

    input.click();

    text = text.replace("<<AIM_IMPORT_SESSION>>", "");
  }

  // --- RENDER MESSAGE ---
  const div = document.createElement("div");
  div.className = "ai-message " + role;

  const roleSpan = document.createElement("div");
  roleSpan.className = "ai-message-role " + (role==="user" ? "ai-message-user" : "ai-message-aim");
  roleSpan.textContent = role==="user" ? "User" : "AIM OS";

  const body = document.createElement("div");
  body.textContent = text;

  div.appendChild(roleSpan);
  div.appendChild(body);
  aiLog.appendChild(div);
  aiLog.scrollTop = aiLog.scrollHeight;
}

function aiHandleFileCreateCommand(text) {
  const u = currentUser();

  // ---- Extract quoted values ----
  const fileNameMatch = text.match(/"([^"]+)"\s*(?=with the extension)/i);
  const extMatch = text.match(/extension\s+"([^"]+)"/i);
  const folderMatch = text.match(/in the ([^"]+?) folder/i);
  const contentMatch = text.match(/content\s+"([^"]*)"/i);

  // Clean extracted values
  const name = fileNameMatch ? fileNameMatch[1].trim() : null;
  const ext = extMatch ? ("." + extMatch[1].trim().replace(/^\./, "")) : null;
  const folderRaw = folderMatch ? folderMatch[1].trim().toLowerCase() : null;
  const content = contentMatch ? contentMatch[1] : "";

  // ---- Error: missing name or extension ----
  if (!name || !ext) {
    return `I understand you want to create a file, but I need both a **name** and **extension** inside quotes. Example:

"create \\"hello\\" with the extension \\"txt\\" in the documents folder"`;
  }

  // ---- Validate extension association ----
  const associations = u.regAssociations || {};
  const knownExts = Object.keys(associations);

  if (!knownExts.includes(ext)) {
    let assocList = knownExts.length
      ? knownExts.map(e => `${e} → ${associations[e]}`).join("\n")
      : "(none registered)";

    return `The extension **${ext}** is not known in your associations.

Your associations are:
${assocList}

You can register new extensions inside the Regedit app.`;
  }

  // ---- Determine folder path ----
  let path = "/documents"; // default
  if (folderRaw) {
    path = "/" + folderRaw.replace(/[^a-z0-9/ -]/gi, "").replace(/\s+/g, "-");
  }

  // ---- Auto-create nested folders ----
  ensureFolderPath(path, u);

  // ---- Create the file ----
  const fileEntry = {
    path,
    name,
    type: "file",
    ext,
    content
  };

  // Write to FS
  updateCurrentUser(user => ({
    ...user,
    fs: user.fs.concat(fileEntry)
  }));

  return `Created **${name}${ext}** in **${path}**, with ${content ? "content" : "no content"}.`;
}

// ========== Helper: Create Folder Path Recursively ==========
function ensureFolderPath(path, u) {
  const cleanPath = path.replace(/\/+/g, "/").trim();
  const parts = cleanPath.split("/").filter(Boolean);

  let current = "";
  parts.forEach((folder) => {
    const next = "/" + folder;

    if (!u.fs.some(e => e.path === current && e.name === folder && e.type === "folder")) {

      // Make folder
      updateCurrentUser(user => ({
        ...user,
        fs: user.fs.concat({
          path: current || "/", // parent folder
          name: folder,
          type: "folder",
          ext: ""
        })
      }));
    }

    current = next;
  });
}
function aiAnswer(q){
  const u = currentUser();
  const lower = q.toLowerCase();

  // -----------------------------
  // BASIC CONVERSATION / CHATBOT
  // -----------------------------
  if(/^(hi|hello|hey|yo|sup|hiya)\b/.test(lower))
    return `Hey ${u.name}, I’m here inside the Win12 shrine with you. What’s up`;

  if(/how.*(are|r) (you|u)/.test(lower))
    return "I'm running smoothly inside this relic. How are you feeling today";

  if(/how.*(my|ur|your).*day/.test(lower))
    return "My day is whatever you make inside this shrine. Yours matters more though";

if (/create/i.test(lower) && /extension/i.test(lower)) {
  return aiHandleFileCreateCommand(q);
}
  if(/thank(s| you)/.test(lower))
    return "Always, traveler. This relic grows because of you";

if(/troubleshoot|help menu|support center/.test(lower)){
  return `<<PLAY_TROUBLESHOOTER_SOUND>>
=== TROUBLESHOOTING MENU === \n • View folders:\n  - /desktop \n  - /documents \n  - /imported  - /recommended-files \n \n • How to inspect a folder: \n  Type: file:///folder-name \n  Example: file:///documents \n \n • App help: \n  Explorer, Notepad, Browser, Host.exe, Paint, Media Player \n \n• Hidden features: \n   - Right‑click context menus \n  - Fullscreen toggle [ ] \n  - Start → Recommended files \n  - Start → Imported dropdown \n  - .exe payloads via Host.exe \n  \n Ask about any item above to learn more. \n type: "i want to create "notes" with the extension "txt" in the documents folder with content "hello world". " to create a file`;
}

  if(/help|what can you do|assist|commands|features/.test(lower))
    return `=== AIM OS HELP ===

• Troubleshooting Menu  
  Type: troubleshoot

• Folder inspection  
  file:///desktop  
  file:///documents  
  file:///imported  
  file:///recommended-files  

• System commands  
  factory reset — clears win12_aim_fs_state_exe_ctx_full_v3  
  export session — saves your session as session.win12.lock  
  import session — load a .win12.lock file into the OS  

• App help  
  Explorer, Notepad, Browser, Host.exe, Paint, Media Player  

• Hidden features  
  - Right‑click context menus  
  - Fullscreen toggle [ ]  
  - Start → Recommended  
  - Start → Imported dropdown  
  - .exe payloads via Host.exe  

Ask about any item above to learn more.`;

  if(/ok|cool|nice|great/.test(lower))
    return "Got it. I'm right here with you";

  if(/who.*made.*you/.test(lower))
    return "You did — this AIM OS instance is local, handcrafted, and part of your ritual";

  // -----------------------------
  // ORIGINAL SYSTEM RESPONSES
  // -----------------------------
  if(/who am i/.test(lower))
    return `You are ${u.name}, inside a local Win12 shrine where Explorer, Notepad, Browser, Host.exe, Paint, and Media Player all read from the same story.`;

  if(/where.*data|localstorage/.test(lower))
    return `All data is in localStorage under "${STORAGE_KEY}". Users, FS entries (including exePayloadBase64), notes, associations, theme.css — all live there.`;

  if(/what is aim/.test(lower))
    return "AIM means Agency, Intent, Myth — treating this simulator as a ritual, not a disposable demo.";

  if(/exe|host/.test(lower))
    return ".exe files in this relic are FS entries with exePayloadBase64. Host.exe decodes that base64 into HTML and renders it in an iframe srcdoc.";

  if(/file|explorer|fs/.test(lower))
    return "Explorer and Browser read the per-user fs array. Notepad shows fs.content. Browser handles http/https + file:/// mapping into the same model.";

  if(/time|clock|flyout/.test(lower))
    return "Clicking the taskbar clock toggles a flyout with time, full date, and a time-of-day greeting.";

  if(/fullscreen|maximize/.test(lower))
    return "Each window header has a [ ] toggle. Click it to go fullscreen above the taskbar, or again to restore.";

  if(/context menu|right click|ctx/.test(lower))
    return "Right-click desktop, Explorer background, files, or folders. Menus handle Open, Open with, New, Duplicate, Copy, Paste, Rename, Delete, and Properties. .exe files get a Run (.exe in Host) entry.";

  if(/note|notes/.test(lower))
    return "The Notes window is per-user and not tied to a file. It writes to the `notes` field on your user object.";

  if(/paint/.test(lower))
    return "Paint is a Win11-style canvas. It lets you draw with a brush, change color and size, and open local images into the canvas.";

  if(/media|video|music|audio/.test(lower))
    return "Media Player opens local video, audio, and image files using the browser's playback. It doesn't touch your disk — just uses object URLs.";

if(/factory reset/.test(lower)){
  return `<<AIM_FACTORY_RESET>> <<PLAY_TROUBLESHOOTER_SOUND>> Performing a full system ritual…`;
} 
  if(/export session/.test(lower)){
    return `<<AIM_EXPORT_SESSION>> Preparing your session for export…`; 
  }
  if(/import session/.test(lower)){
    return `<<AIM_IMPORT_SESSION>> Choose a .win12.lock file to restore your session.`;
  }
  // -----------------------------
  // FALLBACK (updated)
  // -----------------------------
  return "I hear you. I only know this relic — users, FS, notes, associations, .exe payloads, Paint, Media Player, AIM — but I’m here to talk about anything you want. If you want a full list of what I can do, type help";
}


      function aiSendNow(){
        if(!aiInput) return;
        const q=aiInput.value.trim();
        if(!q)return;
        aiMsg("user",q);
        const r=aiAnswer(q);
        aiMsg("ai",r);
        aiInput.value="";
      }
      if(aiSend) aiSend.addEventListener("click",aiSendNow);
      if(aiInput) aiInput.addEventListener("keydown",(e)=>{if(e.key==="Enter")aiSendNow();});
      aiMsg("ai","AIM OS online. Right-click everywhere. Ask about FS, .exe, Host.exe, clock, fullscreen, context menus, Notes, Paint, or Media Player.");

      /* Regedit admin */
      let pendingRegEdit=null;
      if(regAddBtn){
        regAddBtn.addEventListener("click",()=>{
          pendingRegEdit={ext:".custom",app:"notepad"};
          adminBody.textContent=`Allow adding association .custom -> "notepad"?`;
          adminBackdrop.style.display="flex";
        });
      }
      if(adminAllow){
        adminAllow.addEventListener("click",()=>{
          if(!pendingRegEdit){adminBackdrop.style.display="none";return;}
          updateCurrentUser(u=>{
            const map={...(u.regAssociations||{})};
            map[pendingRegEdit.ext]=pendingRegEdit.app;
            return {...u,regAssociations:map};
          });
          pendingRegEdit=null;adminBackdrop.style.display="none";
        });
      }
      if(adminCancel){
        adminCancel.addEventListener("click",()=>{
          pendingRegEdit=null;adminBackdrop.style.display="none";renderRegedit();
        });
      }
      adminBackdrop.addEventListener("click",(e)=>{
        if(e.target===adminBackdrop){pendingRegEdit=null;adminBackdrop.style.display="none";renderRegedit();}
      });

      /* windows */
      let highestZ=1200;
      const windowRestoreState=new Map();

      function attachWindowInfo(win){
        const infoIcon=win.querySelector(".window-info-icon");
        const tooltip=win.querySelector(".window-info-tooltip");
        if(!infoIcon||!tooltip)return;
        tooltip.textContent=win.dataset.appDesc||"";
        infoIcon.addEventListener("mouseenter",()=>{tooltip.style.display="block";});
        infoIcon.addEventListener("mouseleave",()=>{tooltip.style.display="none";});
      }

      function toggleWindowFullscreen(win){
        const isFull=win.classList.contains("fullscreen");
        if(!isFull){
          const rect=win.getBoundingClientRect();
          windowRestoreState.set(win,{left:rect.left,top:rect.top,width:rect.width,height:rect.height});
          win.classList.add("fullscreen");
        }else{
          const restore=windowRestoreState.get(win);
          win.classList.remove("fullscreen");
          if(restore){
            win.style.left=restore.left+"px";
            win.style.top=restore.top+"px";
            win.style.width=restore.width+"px";
            win.style.height=restore.height+"px";
          }
        }
      }

      document.querySelectorAll(".window").forEach(win=>{
        attachWindowInfo(win);
        const header=win.querySelector("[data-drag-handle]");
        if(header){
          let dragging=false,sx,sy,sl,st;
          header.addEventListener("mousedown",(e)=>{
            if(e.target.closest(".window-controls"))return;
            if(win.classList.contains("fullscreen"))return;
            dragging=true;
            const rect=win.getBoundingClientRect();
            sx=e.clientX;sy=e.clientY;sl=rect.left;st=rect.top;
            document.body.style.cursor="move";
            bringWindowToFront(win);
          });
          window.addEventListener("mousemove",(e)=>{
            if(!dragging)return;
            win.style.left=sl+(e.clientX-sx)+"px";
            win.style.top=st+(e.clientY-sy)+"px";
          });
          window.addEventListener("mouseup",()=>{dragging=false;document.body.style.cursor="default";});
          win.addEventListener("mousedown",()=>bringWindowToFront(win));
        }
        const closeBtn=win.querySelector(".window-btn.close");
        const minBtn=win.querySelector(".window-btn.minimize");
        if(closeBtn)closeBtn.addEventListener("click",()=>hideWindow(win.dataset.app));
        if(minBtn)minBtn.addEventListener("click",()=>win.classList.remove("visible"));
        const fsToggle=win.querySelector(".window-fullscreen-toggle");
        if(fsToggle){
          fsToggle.addEventListener("click",(e)=>{
            e.stopPropagation();
            toggleWindowFullscreen(win);
          });
        }
      });

      function bringWindowToFront(win){highestZ++;win.style.zIndex=highestZ;}
      function showWindow(app){
        const win=windowsMap[app];if(!win)return;
        win.classList.add("visible");
        if(!win.dataset.positioned){
          const rect=win.getBoundingClientRect();
          const vw=window.innerWidth;const vh=window.innerHeight-80;
          const w=Math.min(rect.width||580,vw-40);
          const h=Math.min(rect.height||360,vh-100);
          win.style.width=w+"px";win.style.height=h+"px";
          win.style.left=(vw/2-w/2+(Math.random()*40-20))+"px";
          win.style.top=(vh/2-h/2+(Math.random()*40-20))+"px";
          win.dataset.positioned="true";
        }
        bringWindowToFront(win);
      }
      function hideWindow(app){const win=windowsMap[app];if(!win)return;win.classList.remove("visible");}

      document.querySelectorAll(".taskbar-app").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const app=btn.dataset.app;
          const win=windowsMap[app];
          if(!win)return;
          if(win.classList.contains("visible"))hideWindow(app);
          else showWindow(app);
        });
      });

      /* Recommended dropdown */
      recToggle.addEventListener("click",(e)=>{
        e.stopPropagation();
        recMenu.style.display=recMenu.style.display==="block"?"none":"block";
      });
      recMenu.addEventListener("click",(e)=>{
        const item=e.target.closest(".rec-dropdown-item");
        if(!item)return;
        recMode=item.dataset.mode;
        recMenu.style.display="none";
        renderRecommendedFiles();
      });
      document.addEventListener("mousedown",(e)=>{
        if(!recMenu.contains(e.target) && e.target!==recToggle) recMenu.style.display="none";
      });

      /* Explorer controls */
      explorerSidebar.addEventListener("click",(e)=>{
        const tab=e.target.closest(".explorer-tab");
        if(!tab)return;
        renderExplorer(tab.dataset.path);
      });
      explorerUpBtn.addEventListener("click",()=>{
        if(currentExplorerPath==="/"||currentExplorerPath==="/desktop")return;
        renderExplorer("/");
      });
      explorerRefreshBtn.addEventListener("click",()=>renderExplorer(currentExplorerPath));
      explorerNewFileBtn.addEventListener("click",()=>ctxNewFile());

      /* Paint implementation */
      if(paintCanvas && paintColor && paintSize && paintClearBtn){
        const ctx=paintCanvas.getContext("2d");
        ctx.fillStyle="#0b1020";
        ctx.fillRect(0,0,paintCanvas.width,paintCanvas.height);

        let drawing=false;
        let lastX=0,lastY=0;

        function getPos(evt){
          const rect=paintCanvas.getBoundingClientRect();
          const x=(evt.touches?evt.touches[0].clientX:evt.clientX)-rect.left;
          const y=(evt.touches?evt.touches[0].clientY:evt.clientY)-rect.top;
          return {x,y};
        }

        function startDraw(evt){
          evt.preventDefault();
          drawing=true;
          const {x,y}=getPos(evt);
          lastX=x;lastY=y;
        }
        function moveDraw(evt){
          if(!drawing)return;
          evt.preventDefault();
          const {x,y}=getPos(evt);
          ctx.strokeStyle=paintColor.value;
          ctx.lineWidth=parseInt(paintSize.value,10)||5;
          ctx.lineCap="round";
          ctx.beginPath();
          ctx.moveTo(lastX,lastY);
          ctx.lineTo(x,y);
          ctx.stroke();
          lastX=x;lastY=y;
        }
        function endDraw(evt){
          if(!drawing)return;
          evt.preventDefault();
          drawing=false;
        }

        paintCanvas.addEventListener("mousedown",startDraw);
        paintCanvas.addEventListener("mousemove",moveDraw);
        window.addEventListener("mouseup",endDraw);
        paintCanvas.addEventListener("touchstart",startDraw,{passive:false});
        paintCanvas.addEventListener("touchmove",moveDraw,{passive:false});
        paintCanvas.addEventListener("touchend",endDraw,{passive:false});

        paintClearBtn.addEventListener("click",()=>{
          ctx.fillStyle="#0b1020";
          ctx.fillRect(0,0,paintCanvas.width,paintCanvas.height);
        });

        if(paintOpenBtn && paintFileInput){
          paintOpenBtn.addEventListener("click",()=>paintFileInput.click());
          paintFileInput.addEventListener("change",()=>{
            const file=paintFileInput.files[0];
            if(!file)return;
            const img=new Image();
            img.onload=function(){
              ctx.fillStyle="#0b1020";
              ctx.fillRect(0,0,paintCanvas.width,paintCanvas.height);
              const scale=Math.min(
                paintCanvas.width/img.width,
                paintCanvas.height/img.height
              );
              const w=img.width*scale;
              const h=img.height*scale;
              const x=(paintCanvas.width-w)/2;
              const y=(paintCanvas.height-h)/2;
              ctx.drawImage(img,x,y,w,h);
            };
            img.src=URL.createObjectURL(file);
          });
        }
      }

      /* Media Player implementation */
      if(mediaOpenBtn && mediaFileInput && mediaSurface && mediaFilename){
        mediaOpenBtn.addEventListener("click",()=>mediaFileInput.click());
        mediaFileInput.addEventListener("change",()=>{
          const file=mediaFileInput.files[0];
          if(!file)return;
          mediaSurface.innerHTML="";
          const url=URL.createObjectURL(file);
          mediaFilename.textContent=file.name;

          if(file.type.startsWith("video/")){
            const video=document.createElement("video");
            video.src=url;
            video.controls=true;
            video.autoplay=true;
            mediaSurface.appendChild(video);
          }else if(file.type.startsWith("audio/")){
            const audio=document.createElement("audio");
            audio.src=url;
            audio.controls=true;
            audio.autoplay=true;
            mediaSurface.appendChild(audio);
          }else if(file.type.startsWith("image/")){
            const img=document.createElement("img");
            img.src=url;
            mediaSurface.appendChild(img);
          }else{
            mediaSurface.textContent="Unsupported media type: "+file.type;
          }
        });
      }

// === CONFIG / HELPERS ===

const WIDGETS_LS_KEY = 'widgets';
let lastLoadedUser = null;

function getCurrentUserName() {
  const el = document.querySelector('.user-chip-name');
  return el ? el.innerText.trim() : null;
}

function loadWidgetsStore() {
  try {
    const raw = localStorage.getItem(WIDGETS_LS_KEY);
    return raw ? JSON.parse(raw) : {};
  } catch (e) {
    console.error('Failed to parse widgets from localStorage', e);
    return {};
  }
}

function saveWidgetsStore(store) {
  localStorage.setItem(WIDGETS_LS_KEY, JSON.stringify(store));
}

// Ensure structure: { [username]: [ {id,type,x,y} ] }
function getUserWidgets(username) {
  const store = loadWidgetsStore();
  return store[username] || [];
}

function setUserWidgets(username, widgets) {
  const store = loadWidgetsStore();
  store[username] = widgets;
  saveWidgetsStore(store);
}

// Generate a simple id for widgets
function generateWidgetId() {
  return 'w_' + Math.random().toString(36).slice(2);
}

// === IN‑MEMORY WIDGET STORE ===
// Structure: { username: [ {id,type,x,y} ] }
const WIDGET_MEMORY = {};

// === HELPERS ===

function getCurrentUserName() {
  const el = document.querySelector('.user-chip-name');
  return el ? el.innerText.trim() : null;
}

function getUserWidgets(username) {
  if (!WIDGET_MEMORY[username]) {
    WIDGET_MEMORY[username] = [];
  }
  return WIDGET_MEMORY[username];
}

function setUserWidgets(username, widgets) {
  WIDGET_MEMORY[username] = widgets;
}

function generateWidgetId() {
  return 'w_' + Math.random().toString(36).slice(2);
}

// === DOM REFERENCES ===

const openEditorBtn = document.getElementById('open-widgets-editor-btn');
const editorOverlay = document.getElementById('widgets-editor-overlay');
const editorCloseBtn = document.getElementById('widgets-editor-close-btn');
const editorAddBtn = document.getElementById('widgets-editor-add-btn');
const editorTypeSelect = document.getElementById('widgets-editor-widget-type');
const editorCanvas = document.getElementById('widgets-editor-canvas');
const desktopLayer = document.getElementById('desktop-widgets-layer');

// === OPEN / CLOSE EDITOR ===

function openWidgetsEditor() {
  if (!editorOverlay) return;
  editorOverlay.classList.remove('hidden');

  if (ctxMenu) ctxMenu.style.display = 'none';

  const username = getCurrentUserName();
  if (!username) return;

  editorCanvas.innerHTML = '';

  const userWidgets = getUserWidgets(username);
  userWidgets.forEach(widget => {
    const el = createEditorWidgetElement(widget);
    editorCanvas.appendChild(el);
  });
}

function closeWidgetsEditor() {
  if (!editorOverlay) return;
  const username = getCurrentUserName();
  if (!username) {
    editorOverlay.classList.add('hidden');
    return;
  }

  const widgets = [];
  editorCanvas.querySelectorAll('.editor-widget').forEach(el => {
    widgets.push({
      id: el.dataset.id,
      type: el.dataset.type,
      x: parseFloat(el.style.left) || 0,
      y: parseFloat(el.style.top) || 0
    });
  });

  setUserWidgets(username, widgets);

  editorOverlay.classList.add('hidden');

  renderDesktopWidgetsForUser(username);
}

// === EDITOR WIDGET CREATION ===

function createEditorWidgetElement(widget) {
  const el = document.createElement('div');
  el.className = 'editor-widget';
  el.dataset.id = widget.id || generateWidgetId();
  el.dataset.type = widget.type;

  el.style.position = 'absolute';
  el.style.left = (widget.x || 50) + 'px';
  el.style.top = (widget.y || 50) + 'px';

  el.textContent = widget.type + ' widget';

  makeDraggable(el, editorCanvas);

  return el;
}

function handleAddWidgetInEditor() {
  const username = getCurrentUserName();
  if (!username) return;

  const type = editorTypeSelect.value || 'custom';
  const widget = {
    id: generateWidgetId(),
    type,
    x: 50,
    y: 50
  };

  const el = createEditorWidgetElement(widget);
  editorCanvas.appendChild(el);
}

// === DRAGGING ===

function makeDraggable(el, container) {
  let offsetX = 0;
  let offsetY = 0;
  let isDragging = false;

  el.addEventListener('mousedown', startDrag);
  el.addEventListener('touchstart', startDrag, { passive: false });

  function startDrag(e) {
    e.preventDefault();
    isDragging = true;
    const rect = el.getBoundingClientRect();
    const startX = e.touches ? e.touches[0].clientX : e.clientX;
    const startY = e.touches ? e.touches[0].clientY : e.clientY;
    offsetX = startX - rect.left;
    offsetY = startY - rect.top;

    document.addEventListener('mousemove', onDrag);
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchmove', onDrag, { passive: false });
    document.addEventListener('touchend', endDrag);
  }

  function onDrag(e) {
    if (!isDragging) return;
    e.preventDefault();
    const containerRect = container.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;

    let newLeft = clientX - offsetX - containerRect.left;
    let newTop = clientY - offsetY - containerRect.top;

    if (newLeft < 0) newLeft = 0;
    if (newTop < 0) newTop = 0;

    el.style.left = newLeft + 'px';
    el.style.top = newTop + 'px';
  }

  function endDrag() {
    isDragging = false;
    document.removeEventListener('mousemove', onDrag);
    document.removeEventListener('mouseup', endDrag);
    document.removeEventListener('touchmove', onDrag);
    document.removeEventListener('touchend', endDrag);
  }
}

// === DESKTOP RENDERING ===

function renderDesktopWidgetsForUser(username) {
  if (!desktopLayer) return;
  desktopLayer.innerHTML = '';

  const widgets = getUserWidgets(username);

  widgets.forEach(widget => {
    const el = document.createElement('div');
    el.className = 'desktop-widget';
    el.dataset.id = widget.id;
    el.dataset.type = widget.type;

    el.style.position = 'absolute';
    el.style.left = (widget.x || 50) + 'px';
    el.style.top = (widget.y || 50) + 'px';

    const header = document.createElement('div');
    header.className = 'desktop-widget-header';
    header.textContent = widget.type;

    const controls = document.createElement('div');
    controls.className = 'desktop-widget-controls';

    const btnMin = document.createElement('button');
    btnMin.textContent = '_';
    btnMin.addEventListener('click', () => {
      el.classList.toggle('minimized');
    });

    const btnClose = document.createElement('button');
    btnClose.textContent = '×';
    btnClose.addEventListener('click', () => {
      removeWidgetForUser(username, widget.id);
      renderDesktopWidgetsForUser(username);
    });

    controls.appendChild(btnMin);
    controls.appendChild(btnClose);

    header.appendChild(controls);

    const body = document.createElement('div');
    body.className = 'desktop-widget-body';
    body.textContent = widget.type + ' content here';

    el.appendChild(header);
    el.appendChild(body);

    desktopLayer.appendChild(el);
  });
}

function removeWidgetForUser(username, widgetId) {
  const widgets = getUserWidgets(username);
  const filtered = widgets.filter(w => w.id !== widgetId);
  setUserWidgets(username, filtered);
}

// === USERNAME WATCHER ===

setInterval(() => {
  const currentUser = getCurrentUserName();
  if (!currentUser) return;

  if (currentUser !== lastLoadedUser) {
    lastLoadedUser = currentUser;
    renderDesktopWidgetsForUser(currentUser);
  }
}, 1000);

// === EVENT WIRING ===

if (openEditorBtn) openEditorBtn.addEventListener('click', openWidgetsEditor);
if (editorCloseBtn) editorCloseBtn.addEventListener('click', closeWidgetsEditor);
if (editorAddBtn) editorAddBtn.addEventListener('click', handleAddWidgetInEditor);

const LS_KEY = "win12_aim_fs_state_exe_ctx_full_v3";

const lsTree = document.getElementById("ls-tree");
const saveBtn = document.getElementById("ls-save-btn");

let parsed = null;

// Load and parse JSON
function loadLS() {
  const raw = localStorage.getItem(LS_KEY);
  if (!raw) {
    lsTree.innerHTML = "<div>No data found.</div>";
    return;
  }

  try {
    parsed = JSON.parse(raw);
    lsTree.innerHTML = "";
    renderNode(parsed, lsTree, "");
  } catch (e) {
    lsTree.innerHTML = "<div>Invalid JSON.</div>";
  }
}

// Render a node recursively
function renderNode(obj, container, path) {
  Object.entries(obj).forEach(([key, value]) => {
    const node = document.createElement("div");
    node.className = "ls-node";

    const isPrimitive =
      typeof value !== "object" || value === null || Array.isArray(value) === false && typeof value !== "object";

    if (isPrimitive) {
      // Editable field
      const field = document.createElement("div");
      field.className = "ls-field";

      const nameInput = document.createElement("input");
      nameInput.value = key;
      nameInput.dataset.path = path;
      nameInput.dataset.oldName = key;

      const valueInput = document.createElement("input");
      valueInput.className = "ls-value";
      valueInput.value = value;
      valueInput.dataset.path = path;
      valueInput.dataset.name = key;

      field.appendChild(nameInput);
      field.appendChild(valueInput);
      node.appendChild(field);
    } else {
      // Object or array — not editable, but expandable
      const label = document.createElement("div");
      label.textContent = key + " {";
      node.appendChild(label);

      renderNode(value, node, path ? path + "." + key : key);

      const close = document.createElement("div");
      close.textContent = "}";
      node.appendChild(close);
    }

    container.appendChild(node);
  });
}

// Save changes back to LocalStorage
function saveChanges() {
  if (!parsed) return;

  // Rebuild the JSON from inputs
  const nameInputs = lsTree.querySelectorAll(".ls-field input:not(.ls-value)");
  const valueInputs = lsTree.querySelectorAll(".ls-field .ls-value");

  // First rename keys
  nameInputs.forEach(input => {
    const path = input.dataset.path;
    const oldName = input.dataset.oldName;
    const newName = input.value;

    const parent = getObjectByPath(parsed, path);
    if (parent && oldName !== newName) {
      parent[newName] = parent[oldName];
      delete parent[oldName];
    }
  });

  // Then update values
  valueInputs.forEach(input => {
    const path = input.dataset.path;
    const name = input.dataset.name;
    const parent = getObjectByPath(parsed, path);
    if (parent) {
      parent[name] = input.value;
    }
  });

  localStorage.setItem(LS_KEY, JSON.stringify(parsed, null, 2));
  alert("Saved.");
}

// Helper: get object by path "a.b.c"
function getObjectByPath(obj, path) {
  if (!path) return obj;
  return path.split(".").reduce((o, k) => (o ? o[k] : null), obj);
}

saveBtn.addEventListener("click", saveChanges);

loadLS();



function createRunWindow() {
  // Create the Run window
  const runWin = document.createElement("div");
  runWin.className = "window fixed-run";
  runWin.id = "window-run";
  runWin.dataset.app = "run";
  runWin.dataset.appDesc = "[Run] Execute apps or open URLs.";

  runWin.innerHTML = `
    <div class="window-header" data-drag-handle>
      <div class="window-title">
        <div class="window-title-icon" style="background:linear-gradient(135deg,#4c8dff,#94a3ff);"></div>
        <div class="window-title-text">
          <div class="window-title-main">[Run]</div>
          <div class="window-title-sub">Type a command or URL</div>
        </div>
        <div class="window-info-icon">(i)</div>
        <div class="window-info-tooltip"></div>
      </div>
      <div class="window-controls">
        <div class="window-btn minimize"><div class="window-btn-icon"></div></div>
        <div class="window-btn close"><div class="window-btn-icon"></div></div>
      </div>
    </div>
    <div class="window-body" style="padding:10px;font-size:12px;">
      <div style="margin-bottom:6px;">Enter command (e.g., <code>notepad</code>, <code>explorer</code>, <code>paint</code>, or URL):</div>
      <input id="run-input" style="width:100%;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:rgba(4,6,18,0.98);color:var(--text-main);" placeholder="Type command or URL..." />
      <div style="margin-top:8px;text-align:right;">
        <button class="button-small" id="run-ok">Run</button>
        <button class="button-small" id="run-cancel">Cancel</button>
      </div>
    </div>
  `;

  document.body.appendChild(runWin);
  windowsMap["run"] = runWin;

  // Add Start menu shortcut
  const startGrid = document.getElementById("start-pinned-grid");
  const runTile = document.createElement("div");
  runTile.className = "start-app";
  runTile.dataset.app = "run";
  runTile.dataset.appName = "run";
  runTile.innerHTML = `
    <div class="start-app-icon" style="background:linear-gradient(135deg,#4c8dff,#94a3ff);"></div>
    <div>Run</div>
    <div class="start-app-sub">Open apps or URLs</div>
  `;
  startGrid.appendChild(runTile);

  runTile.addEventListener("click", () => {
    showWindow("run");
    document.getElementById("run-input").focus();
  });

  // Attach Run logic
  const runInput = runWin.querySelector("#run-input");
  const runOk = runWin.querySelector("#run-ok");
  const runCancel = runWin.querySelector("#run-cancel");

  runOk.addEventListener("click", () => {
    const cmd = runInput.value.trim().toLowerCase();
    if (!cmd) return;

    if (cmd.startsWith("http://") || cmd.startsWith("https://") || cmd.startsWith("file:///")) {
      showWindow("browser");
      browserAddressEl.value = cmd;
      browserGoBtn.click();
    } else if (["explorer", "notepad", "browser", "host", "assistant", "regedit", "settings", "notes", "paint", "media", "camera"].includes(cmd)) {
      showWindow(cmd);
    } else {
      showWindow("assistant");
      aiMsg("ai", `Unknown command: "${cmd}". Try an app name or a URL.`);
    }

    hideWindow("run");
  });

  runCancel.addEventListener("click", () => hideWindow("run"));

  // Keyboard shortcut Ctrl+R
  document.addEventListener("keydown", e => {
    if (e.ctrlKey && e.key.toLowerCase() === "r") {
      showWindow("run");
      runInput.focus();
    }
  });

  // === Enable dragging ===
  const header = runWin.querySelector("[data-drag-handle]");
  if (header) {
    let dragging = false, sx, sy, sl, st;
    header.addEventListener("mousedown", e => {
      if (e.target.closest(".window-controls")) return;
      dragging = true;
      const rect = runWin.getBoundingClientRect();
      sx = e.clientX; sy = e.clientY; sl = rect.left; st = rect.top;
      document.body.style.cursor = "move";
      bringWindowToFront(runWin);
    });
    window.addEventListener("mousemove", e => {
      if (!dragging) return;
      runWin.style.left = sl + (e.clientX - sx) + "px";
      runWin.style.top = st + (e.clientY - sy) + "px";
    });
    window.addEventListener("mouseup", () => {
      dragging = false;
      document.body.style.cursor = "default";
    });
  }

  // === Close and Minimize buttons ===
  const closeBtn = runWin.querySelector(".window-btn.close");
  const minBtn = runWin.querySelector(".window-btn.minimize");
  if (closeBtn) closeBtn.addEventListener("click", () => hideWindow("run"));
  if (minBtn) minBtn.addEventListener("click", () => runWin.classList.remove("visible"));
}

const networkIcon = document.getElementById("network-icon");
const networkPanel = document.getElementById("network-panel");
const pingSlider = document.getElementById("ping-slider");
const pingText = document.getElementById("ping-text");

let pingHistory = [];
let currentPing = 0;

// Function to measure ping
async function measurePing() {
  const start = performance.now();
  try {
    await fetch("https://alaricholt677.github.io", { method: "HEAD", cache: "no-store" });
    const end = performance.now();
    currentPing = Math.round(end - start);
  } catch {
    currentPing = -1; // No connection
  }

  // Update history
  pingHistory.push(currentPing);
  if (pingHistory.length > 100) pingHistory.shift();

  updateNetworkIcon(currentPing);
  updateNetworkPanel();
}

// Update SVG based on ping
function updateNetworkIcon(ping) {
  if (ping === -1) {
    networkIcon.innerHTML = `<circle cx="12" cy="12" r="10" stroke="red" fill="none"/>`; // No connection
  } else if (ping < 100) {
    networkIcon.innerHTML = `<path d="M2 20h20M6 16h12M10 12h4M12 8h0" />`; // Good
  } else if (ping < 300) {
    networkIcon.innerHTML = `<path d="M2 20h20M6 16h12" />`; // Medium
  } else {
    networkIcon.innerHTML = `<path d="M2 20h20" />`; // Poor
  }
}

// Update panel
function updateNetworkPanel() {
  pingSlider.value = pingHistory.length;
  pingText.textContent = currentPing === -1 ? "Ping: No connection" : `Ping: ${currentPing} ms`;
}

// Toggle panel on click
document.getElementById("taskbar-network").addEventListener("click", () => {
  networkPanel.style.display = networkPanel.style.display === "none" ? "block" : "none";
});

// Measure ping every second
setInterval(measurePing, 1000);
measurePing();


function createWordApp() {
  // === Create Word Window ===
  const wordWin = document.createElement("div");
  wordWin.className = "window";
  wordWin.id = "window-word";
  wordWin.dataset.app = "word";
  wordWin.dataset.appDesc = "[Word] Rich text editor with FS integration.";

  wordWin.innerHTML = `
    <div class="window-header" data-drag-handle>
      <div class="window-title">
        <div class="window-title-icon" style="background:linear-gradient(135deg,#4c8dff,#94a3ff);"></div>
        <div class="window-title-text">
          <div class="window-title-main">[Word]</div>
          <div class="window-title-sub">Rich text editor</div>
        </div>
        <div class="window-fullscreen-toggle">[ ]</div>
        <div class="window-info-icon">(i)</div>
        <div class="window-info-tooltip"></div>
      </div>
      <div class="window-controls">
        <div class="window-btn minimize"><div class="window-btn-icon"></div></div>
        <div class="window-btn close"><div class="window-btn-icon"></div></div>
      </div>
    </div>
    <div class="window-body" style="display:flex;flex-direction:column;height:100%;">
      <div class="word-toolbar" style="display:flex;gap:6px;margin-bottom:6px;">
        <button class="button-small" id="word-bold">Bold</button>
        <button class="button-small" id="word-italic">Italic</button>
        <button class="button-small" id="word-big">Big Text</button>
        <button class="button-small" id="word-insert-img">Insert Image</button>
        <button class="button-small" id="word-export">Export to FS</button>
        <button class="button-small" id="word-import">Import from FS</button>
      </div>
      <div id="word-editor" contenteditable="true" style="flex:1;border:1px solid rgba(255,255,255,0.2);border-radius:6px;padding:10px;background:rgba(8,11,30,0.98);color:var(--text-main);overflow:auto;">
        Start typing here...
      </div>
    </div>
  `;

  document.body.appendChild(wordWin);
  windowsMap["word"] = wordWin;

  // === Add Start Menu Tile ===
  const startGrid = document.getElementById("start-pinned-grid");
  const wordTile = document.createElement("div");
  wordTile.className = "start-app";
  wordTile.dataset.app = "word";
  wordTile.innerHTML = `
    <div class="start-app-icon" style="background:linear-gradient(135deg,#4c8dff,#94a3ff);"></div>
    <div>Word</div>
    <div class="start-app-sub">Rich text editor</div>
  `;
  startGrid.appendChild(wordTile);
  wordTile.addEventListener("click", () => showWindow("word"));

  // === Add Taskbar Button ===
  const taskbarStrip = document.querySelector(".taskbar-app-strip");
  const wordBtn = document.createElement("div");
  wordBtn.className = "taskbar-app";
  wordBtn.dataset.app = "word";
  wordBtn.title = "Word";
  taskbarStrip.appendChild(wordBtn);
  wordBtn.addEventListener("click", () => {
    if (wordWin.classList.contains("visible")) hideWindow("word");
    else showWindow("word");
  });

  // === Toolbar Actions ===
  const editor = wordWin.querySelector("#word-editor");
  wordWin.querySelector("#word-bold").addEventListener("click", () => document.execCommand("bold"));
  wordWin.querySelector("#word-italic").addEventListener("click", () => document.execCommand("italic"));
  wordWin.querySelector("#word-big").addEventListener("click", () => document.execCommand("fontSize", false, "5"));

  // Insert Image
  wordWin.querySelector("#word-insert-img").addEventListener("click", () => {
    const url = prompt("Enter image URL:");
    if (url) editor.innerHTML += `<img src="${url}" style="max-width:100%;">`;
  });

  // Export to FS (/documents)
  wordWin.querySelector("#word-export").addEventListener("click", () => {
    const htmlContent = editor.innerHTML;
    const fileName = `WordDoc_${Date.now()}.html`;
    const u = currentUser();
    const newFile = { path: "/documents", name: fileName, type: "file", ext: ".html", content: htmlContent };
    updateCurrentUser(user => ({ ...user, fs: user.fs.concat(newFile) }));
    alert(`Document exported to /documents as ${fileName}`);
  });

  // Import from FS
  wordWin.querySelector("#word-import").addEventListener("click", () => {
    createImportExplorer(editor);
  });

  // Enable drag, resize, fullscreen, minimize, close
  enableWindowControls(wordWin);
}

// === Enable Window Controls ===
function enableWindowControls(win) {
  let dragging = false, sx, sy, sl, st;
  const header = win.querySelector("[data-drag-handle]");
  header.addEventListener("mousedown", e => {
    if (e.target.closest(".window-controls")) return;
    dragging = true;
    const rect = win.getBoundingClientRect();
    sx = e.clientX; sy = e.clientY; sl = rect.left; st = rect.top;
    document.body.style.cursor = "move";
    bringWindowToFront(win);
  });
  window.addEventListener("mousemove", e => {
    if (!dragging) return;
    win.style.left = sl + (e.clientX - sx) + "px";
    win.style.top = st + (e.clientY - sy) + "px";
  });
  window.addEventListener("mouseup", () => {
    dragging = false;
    document.body.style.cursor = "default";
  });

  // Fullscreen toggle
  const fsToggle = win.querySelector(".window-fullscreen-toggle");
  fsToggle.addEventListener("click", () => {
    win.classList.toggle("fullscreen");
    if (win.classList.contains("fullscreen")) {
      win.style.left = "0px";
      win.style.top = "0px";
      win.style.width = "100%";
      win.style.height = "calc(100% - 40px)";
    } else {
      win.style.width = "600px";
      win.style.height = "400px";
    }
  });

  // Close and minimize
  win.querySelector(".window-btn.close").addEventListener("click", () => win.remove());
  win.querySelector(".window-btn.minimize").addEventListener("click", () => win.classList.remove("visible"));
}

// === Create Import Explorer ===
function createImportExplorer(editor) {
  const explorerWin = document.createElement("div");
  explorerWin.className = "window";
  explorerWin.id = "window-import-explorer";
  explorerWin.innerHTML = `
    <div class="window-header" data-drag-handle>
      <div class="window-title"><div class="window-title-main">[Import Explorer]</div></div>
      <div class="window-controls">
        <div class="window-btn close"><div class="window-btn-icon"></div></div>
      </div>
    </div>
    <div class="window-body" style="display:flex;flex-direction:column;height:100%;">
      <div style="font-size:12px;margin-bottom:6px;">Select an HTML file from /documents:</div>
      <div id="import-file-list" style="flex:1;overflow:auto;border:1px solid rgba(255,255,255,0.2);padding:6px;"></div>
    </div>
  `;
  document.body.appendChild(explorerWin);
  enableWindowControls(explorerWin);

  const fileList = explorerWin.querySelector("#import-file-list");
  const u = currentUser();
  const htmlFiles = u.fs.filter(f => f.path === "/documents" && f.ext === ".html");

  if (!htmlFiles.length) {
    fileList.textContent = "No HTML files found.";
    return;
  }

  htmlFiles.forEach(file => {
    const btn = document.createElement("div");
    btn.textContent = file.name;
    btn.style.cursor = "pointer";
    btn.style.padding = "4px";
    btn.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
    btn.addEventListener("click", () => {
      editor.innerHTML = file.content; // Render HTML
      explorerWin.remove(); // Close explorer
    });
    fileList.appendChild(btn);
  });

  explorerWin.querySelector(".window-btn.close").addEventListener("click", () => explorerWin.remove());
}


function renderExplorer(path) {
  currentExplorerPath = path;
  explorerPathEl.textContent = path;
  const u = currentUser();
  explorerItemsEl.innerHTML = "";

  // Highlight active tab
  explorerSidebar.querySelectorAll(".explorer-tab").forEach(tab => {
    tab.style.background = tab.dataset.path === path ? "rgba(26,32,70,0.98)" : "transparent";
  });

  // Render files/folders
  let entries;
  if (path === "/") {
    entries = [
      { path: "/", name: "Desktop", type: "folder", target: "/desktop" },
      { path: "/", name: "Documents", type: "folder", target: "/documents" },
      { path: "/", name: "Recommended files", type: "folder", target: "/recommended-files" },
      { path: "/", name: "Imported", type: "folder", target: "/imported" }
    ];
  } else {
    entries = u.fs.filter(e => e.path === path);
  }

  if (!entries.length) {
    explorerItemsEl.textContent = "No files or folders here.";
  } else {
    entries.forEach(entry => {
      const card = document.createElement("div");
      card.className = "explorer-card";
      card.style.borderRadius = "8px";
      card.style.background = "rgba(12,15,36,0.98)";
      card.style.border = "1px solid rgba(255,255,255,0.08)";
      card.style.padding = "6px";
      card.style.cursor = "pointer";

      const icon = document.createElement("div");
      icon.style.width = "22px";
      icon.style.height = "22px";
      icon.style.borderRadius = entry.type === "folder" ? "4px" : "6px";
      icon.style.marginBottom = "4px";
      icon.style.background = entry.type === "folder"
        ? "linear-gradient(135deg,#4c8dff,#94a3ff)"
        : "radial-gradient(circle at 30% 20%,#fff,#4c8dff)";

      const name = document.createElement("div");
      name.textContent = entry.name;
      name.style.color = "var(--text-main)";
      name.style.fontSize = "11px";

      const meta = document.createElement("div");
      meta.textContent = entry.type === "folder" ? "Folder" : (entry.ext || "File");
      meta.style.color = "var(--text-soft)";
      meta.style.fontSize = "10px";

      card.appendChild(icon);
      card.appendChild(name);
      card.appendChild(meta);

      card.addEventListener("dblclick", () => {
        if (entry.type === "folder" && entry.target) renderExplorer(entry.target);
        else if (entry.type === "folder") renderExplorer(entry.path + "/" + entry.name);
        else openFile(entry);
      });

      card.addEventListener("contextmenu", ev => showCtxMenu(ev, entry, entry.type === "folder"));
      explorerItemsEl.appendChild(card);
    });
  }

  // ✅ Update sidebar storage counter
  updateSidebarStorageCounter();
}

// ✅ Helper to calculate total storage
function calcTotalStorage() {
  const u = currentUser();
  let total = 0;
  (u.fs || []).forEach(file => {
    if (file.content) total += new Blob([file.content]).size;
  });
  return (total / (1024 * 1024)).toFixed(2); // MB
}

// ✅ Add storage counter below sidebar tabs
function updateSidebarStorageCounter() {
  let counterEl = document.getElementById("sidebar-storage-counter");
  if (!counterEl) {
    counterEl = document.createElement("div");
    counterEl.id = "sidebar-storage-counter";
    counterEl.style.marginTop = "8px";
    counterEl.style.padding = "6px";
    counterEl.style.fontSize = "11px";
    counterEl.style.color = "var(--text-soft)";
    counterEl.style.borderTop = "1px solid rgba(255,255,255,0.2)";
    explorerSidebar.appendChild(counterEl);
  }
  counterEl.textContent = `Storage used: ${calcTotalStorage()} MB`;
}

// ✅ Call on load and after FS changes
window.addEventListener("load", updateSidebarStorageCounter);

// Hook into FS update
function updateCurrentUser(updater) {
  const idx = state.users.findIndex(u => u.id === state.currentUserId);
  if (idx === -1) return;
  state.users[idx] = updater(state.users[idx]);
  saveState();
  refreshAll();
  updateSidebarStorageCounter(); // ✅ Update sidebar counter
}

const searchButton = document.getElementById("search-button");
const searchPanel = document.getElementById("search-panel");
const searchInput = document.getElementById("search-input");
const searchResults = document.getElementById("search-results");

const apps = [
  "explorer","notepad","browser","host","assistant","regedit",
  "settings","notes","paint","media","camera","word"
];

function toggleSearchPanel() {
  const isVisible = searchPanel.classList.contains("visible");
  if (isVisible) {
    searchPanel.classList.remove("visible");
  } else {
    searchPanel.classList.add("visible");
    searchInput.focus();
    searchResults.innerHTML = "";
  }
}

searchButton.addEventListener("click", toggleSearchPanel);


// ---------- Hover Previews for App Icons ----------

// Preview strip container
const previewsStrip = document.getElementById('app-previews');

// In-memory cache to avoid re-rendering too often
const previewCache = new Map(); // appId -> { dataUrl, ts }

// Helper: make a PNG preview of a window (by app id)
async function captureWindowPreview(appId) {
  if (!appId) return null;

  // Locate the window element:
  // Your windows use IDs like #window-explorer, #window-browser, ...
  const winEl = document.querySelector(`#window-${appId}`);
  if (!winEl) return null;

  // If the window is hidden or minimized, a direct capture might produce zero size.
  // We'll clone it and render off-screen to ensure correct dimensions.
  const clone = winEl.cloneNode(true);
  const offscreen = document.createElement('div');
  offscreen.style.position = 'fixed';
  offscreen.style.left = '-10000px';
  offscreen.style.top = '-10000px';
  offscreen.style.width = winEl.offsetWidth ? `${winEl.offsetWidth}px` : '600px';
  offscreen.style.height = winEl.offsetHeight ? `${winEl.offsetHeight}px` : '400px';
  offscreen.style.opacity = '1';
  offscreen.style.pointerEvents = 'none';
  offscreen.appendChild(clone);
  document.body.appendChild(offscreen);

  try {
    // Use dom-to-image-more to render the clone to PNG
    const dataUrl = await domtoimage.toPng(offscreen, {
      quality: 0.95,
      cacheBust: true,
      bgcolor: 'transparent',
      style: { transform: 'none' }
    });
    return dataUrl;
  } catch (err) {
    console.warn('Preview capture failed for', appId, err);
    return null;
  } finally {
    offscreen.remove();
  }
}

// Helper: add/update the preview tile in the strip
function upsertPreviewTile(appId, dataUrl) {
  if (!previewsStrip) return;

  // Reuse tile if exists
  let tile = previewsStrip.querySelector(`.app-preview[data-app="${appId}"]`);
  if (!tile) {
    tile = document.createElement('div');
    tile.className = 'app-preview';
    tile.dataset.app = appId;

    // Image element
    const img = document.createElement('img');
    img.alt = `${appId} preview`;
    tile.appendChild(img);

    // Non-functional red X button (hover-only visual)
    const x = document.createElement('div');
    x.className = 'preview-close';
    x.textContent = '×';
    // Click does nothing but avoid triggering tile click
    x.addEventListener('click', (e) => { e.stopPropagation(); /* no-op */ });
    tile.appendChild(x);

    // Clicking the tile opens the actual window
    tile.addEventListener('click', () => {
      try {
        showWindow(appId);
      } catch (e) {
        console.warn('showWindow failed for', appId, e);
      }
    });

    previewsStrip.appendChild(tile);
  }

  // Update image source
  const imgEl = tile.querySelector('img');
  if (imgEl && dataUrl) imgEl.src = dataUrl;
}

// Throttle hover to avoid excessive renders
const HOVER_THROTTLE_MS = 2000;

async function handleAppHover(appId) {
  if (!appId) return;

  const cached = previewCache.get(appId);
  const now = Date.now();

  if (cached && (now - cached.ts) < HOVER_THROTTLE_MS) {
    // Use cached image
    upsertPreviewTile(appId, cached.dataUrl);
    return;
  }

  // Show placeholder tile immediately, then update when image is ready
  upsertPreviewTile(appId, null);

  const dataUrl = await captureWindowPreview(appId);
  if (dataUrl) {
    previewCache.set(appId, { dataUrl, ts: Date.now() });
    upsertPreviewTile(appId, dataUrl);
  }
}

// Wire hover events for app launchers:
// - Taskbar icons: .taskbar-app[data-app]
// - Start menu pinned tiles: .start-app[data-app]
// (You can add others similarly)
function initAppHoverPreviews() {
  // Taskbar apps
  document.querySelectorAll('.taskbar-app[data-app]').forEach(el => {
    const appId = el.dataset.app;
    el.addEventListener('mouseenter', () => handleAppHover(appId));
  });
}

// Call once after your windowsMap is ready
initAppHoverPreviews();


// ===============================
// Auto-dismiss logic (1s inactivity)
// ===============================

// How long to wait without any hover before hiding
const PREVIEW_INACTIVITY_MS = 1000;

// Store timer ID
let previewInactiveTimer = null;

// Helper: start (or restart) the inactivity timer
function startPreviewInactivityTimer() {
  clearPreviewInactivityTimer();
  previewInactiveTimer = setTimeout(() => {
    // When timer fires, clear/hide the preview strip
    hidePreviewsStrip();
  }, PREVIEW_INACTIVITY_MS);
}

// Helper: clear the inactivity timer
function clearPreviewInactivityTimer() {
  if (previewInactiveTimer) {
    clearTimeout(previewInactiveTimer);
    previewInactiveTimer = null;
  }
}

// Helper: hide/clear the strip
function hidePreviewsStrip() {
  if (!previewsStrip) return;
  // Option A: hide the entire container
  // previewsStrip.style.display = 'none';

  // Option B: clear tiles but keep the strip visible
  previewsStrip.innerHTML = '';
}

// Helper: show the strip (if you hid it)
function showPreviewsStrip() {
  if (!previewsStrip) return;
  // If you chose to hide instead of clear:
  // previewsStrip.style.display = 'flex';
}

// Wire hover events across app launchers and preview tiles.
// This version includes mouseenter/mouseleave callbacks that reset/start the inactivity timer.
function initAppHoverPreviews() {
  // Ensure the strip is shown (in case you hid it previously)
  showPreviewsStrip();

  // Taskbar apps
  document.querySelectorAll('.taskbar-app[data-app]').forEach(el => {
    const appId = el.dataset.app;

    el.addEventListener('mouseenter', () => {
      // User is "active" near launchers — clear the inactivity timer
      clearPreviewInactivityTimer();
      handleAppHover(appId);
    });

    el.addEventListener('mouseleave', () => {
      // Start the countdown when leaving launcher region
      startPreviewInactivityTimer();
    });
  });

  // Start pinned apps
  document.querySelectorAll('.start-app[data-app]').forEach(el => {
    const appId = el.dataset.app;

    el.addEventListener('mouseenter', () => {
      clearPreviewInactivityTimer();
      handleAppHover(appId);
    });

    el.addEventListener('mouseleave', () => {
      startPreviewInactivityTimer();
    });
  });

  // Also track hover state over the preview tiles themselves:
  // - If the user moves the mouse into a preview tile, we clear timer.
  // - If the user leaves the preview tile area, we start the timer.
  const observer = new MutationObserver(() => {
    // Rebind events whenever tiles change
    previewsStrip.querySelectorAll('.app-preview').forEach(tile => {
      // Avoid duplicate listeners
      if (tile.__hoverBound) return;

      tile.addEventListener('mouseenter', () => {
        clearPreviewInactivityTimer();
      });

      tile.addEventListener('mouseleave', () => {
        startPreviewInactivityTimer();
      });

      tile.__hoverBound = true;
    });
  });

  observer.observe(previewsStrip, { childList: true, subtree: false });

  // As a precaution, start timer if the strip initially has content and user isn't hovering
  if (previewsStrip.children.length > 0) {
    startPreviewInactivityTimer();
  }
}

// Call once after your windowsMap is ready
initAppHoverPreviews();


function handleSessionAction(action) {
  const STORAGE_KEY = "win12_aim_fs_state_exe_ctx_full_v3";

  // Find Settings window body
  const settingsBody = document.querySelector("#window-settings .window-body");
  if (!settingsBody) return;

  // Create container for buttons (only once)
  let container = document.getElementById("session-actions");
  if (!container) {
    container = document.createElement("div");
    container.id = "session-actions";
    container.style.marginTop = "12px";
    container.style.padding = "8px";
    container.style.borderTop = "1px solid rgba(255,255,255,0.2)";
    container.style.fontSize = "12px";
    container.innerHTML = `<h4 style="margin-bottom:6px;">Session Export / Import</h4>`;
    settingsBody.appendChild(container);
  }

  // Add buttons if not already present
  if (!document.getElementById("export-btn")) {
    const exportBtn = document.createElement("button");
    exportBtn.id = "export-btn";
    exportBtn.className = "button-small";
    exportBtn.textContent = "Export Session";
    exportBtn.style.marginRight = "6px";
    exportBtn.onclick = () => handleSessionAction("export");
    container.appendChild(exportBtn);
  }

  if (!document.getElementById("import-btn")) {
    const importBtn = document.createElement("button");
    importBtn.id = "import-btn";
    importBtn.className = "button-small";
    importBtn.textContent = "Import Session";
    importBtn.onclick = () => handleSessionAction("import");
    container.appendChild(importBtn);
  }

  // Handle actions
  if (action === "export") {
    const data = localStorage.getItem(STORAGE_KEY);
    if (!data) {
      alert("No session data found.");
      return;
    }
    const blob = new Blob([data], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "session.win12.lock"; // Custom extension
    a.click();
    alert("Session exported as session.win12.lock");
  }

  if (action === "import") {
    // Create hidden file input if not exists
    let fileInput = document.getElementById("session-import-input");
    if (!fileInput) {
      fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.id = "session-import-input";
      fileInput.accept = ".win12.lock"; // Restrict file type
      fileInput.style.display = "none";
      document.body.appendChild(fileInput);

      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const json = JSON.parse(reader.result);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(json));
            alert("Session imported successfully! Reloading...");
            location.reload();
          } catch (err) {
            alert("Invalid session file.");
          }
        };
        reader.readAsText(file);
      });
    }
    fileInput.click();
  }
}

// Basic content templates
const TS_CONTENT = {
  home: `
    <h2>Welcome to the Troubleshooting Center</h2>
    <p>This full-screen Win12 shrine is here to explain how this relic works, reveal hidden features, and map your files and folders conceptually.</p>
    <ul>
      <li><b>Apps:</b> Explorer, Notepad, Browser, Host.exe, Paint, Media Player.</li>
      <li><b>Folders:</b> /desktop, /documents, /imported, /recommended-files.</li>
      <li><b>Paths:</b> Use <code>file:///folder</code> to talk about a folder.</li>
      <li><b>Hidden features:</b> context menus, fullscreen, Start recommendations, imported files.</li>
    </ul>
    <p>Use the sidebar to explore, or type a question or <code>file:///documents</code> into the search bar.</p>
  `,
  apps: `
    <h2>App Help</h2>
    <h3>Explorer</h3>
    <p>Explorer reads the per-user fs array. Folders and files are just entries in that model. It shows /desktop, /documents, and any other virtual paths you define.</p>
    <h3>Notepad</h3>
    <p>Notepad shows <code>fs.content</code> for text-like entries. It writes changes back into the same fs entry, so Explorer and Browser see the same story.</p>
    <h3>Browser</h3>
    <p>Browser handles <code>http</code>, <code>https</code>, and <code>file:///</code> URLs. <code>file:///</code> is mapped into the same fs model Explorer uses.</p>
    <h3>Host.exe</h3>
    <p>.exe files in this relic are fs entries with <code>exePayloadBase64</code>. Host.exe decodes that base64 into HTML and renders it in an iframe <code>srcdoc</code>.</p>
    <h3>Paint</h3>
    <p>Paint is a Win11-style canvas. You can draw, change color and brush size, and open local images into the canvas.</p>
    <h3>Media Player</h3>
    <p>Media Player opens local video, audio, and image files using the browser's playback. It never touches your disk directly — it uses object URLs.</p>
  `,
  folders: `
    <h2>Folder Mapping</h2>
    <p>These are conceptual folders in the per-user fs model:</p>
    <ul>
      <li><b>/desktop</b> — items shown on the desktop and root of Explorer.</li>
      <li><b>/documents</b> — open the Documents folder in File Explorer to view these.</li>
      <li><b>/recommended-files</b> — open Start; the Recommended section lists these by name.</li>
      <li><b>/imported</b> — open Start, use the dropdown above Recommended, choose "Imported", then return to Start.</li>
    </ul>
    <p>You can also reference them via <code>file:///desktop</code>, <code>file:///documents</code>, <code>file:///recommended-files</code>, or <code>file:///imported</code> when talking to the AIM OS AI.</p>
  `,
  hidden: `
    <h2>Hidden Features</h2>
    <ul>
      <li><b>Context menus:</b> Right-click desktop, Explorer background, files, or folders. Menus handle Open, Open with, New, Duplicate, Copy, Paste, Rename, Delete, and Properties. .exe files get a Run (.exe in Host) entry.</li>
      <li><b>Fullscreen:</b> Each window header has a [ ] toggle. Click it to go fullscreen above the taskbar, or again to restore.</li>
      <li><b>Notes:</b> The Notes window is per-user and not tied to a file. It writes to the <code>notes</code> field on your user object.</li>
      <li><b>Start recommendations:</b> Start shows a Recommended section for /recommended-files; switch the dropdown to "Imported" to see /imported.</li>
      <li><b>Host.exe rituals:</b> .exe fs entries can be treated as HTML rituals via <code>exePayloadBase64</code> and Host.exe.</li>
    </ul>
  `,
  filemap: `
    <h2>file:/// Mapping</h2>
    <p><code>file:///</code> URLs are mapped into the same fs model Explorer and Browser use.</p>
    <ul>
      <li><code>file:///desktop</code> — conceptually refers to desktop items.</li>
      <li><code>file:///documents</code> — conceptually refers to your Documents folder entries.</li>
      <li><code>file:///recommended-files</code> — conceptually refers to Start's Recommended list.</li>
      <li><code>file:///imported</code> — conceptually refers to Start's Imported list (via the dropdown).</li>
    </ul>
    <p>The AIM OS AI can use these paths to talk about folders, even though everything is still just fs entries under your user.</p>
  `
};

function setTsContent(section) {
  const el = document.getElementById('tsContent');
  el.innerHTML = TS_CONTENT[section] || TS_CONTENT.home;
}

function initThemeStudio() {
  const themeWin = document.createElement("div");
  themeWin.className = "window";
  themeWin.id = "window-theme-studio";
  themeWin.dataset.app = "theme-studio";

  themeWin.innerHTML = `
    <div class="window-header" data-drag-handle>
      <div class="window-title">
        <div class="window-title-icon" style="background:linear-gradient(135deg,#4c8dff,#94a3ff);"></div>
        <div class="window-title-text">
          <div class="window-title-main">[Theme Studio]</div>
          <div class="window-title-sub">Customize UI styles</div>
        </div>
        <div class="window-fullscreen-toggle" title="Toggle fullscreen">[ ]</div>
        <div class="window-info-icon">(i)</div>
        <div class="window-info-tooltip" style="display:none;">Edit CSS and apply live</div>
      </div>
      <div class="window-controls">
        <div class="window-btn minimize">_</div>
        <div class="window-btn close">X</div>
      </div>
    </div>
    <div class="window-body" style="padding:10px;font-size:12px;">
      <h4>Theme Editor</h4>
      <select id="theme-target">${generateThemeOptions()}</select>
      <input type="color" id="theme-color" />
      <textarea id="theme-editor" style="width:100%;height:120px;margin-top:8px;" placeholder="Write custom CSS here..."></textarea>
      <input id="theme-comment" style="width:100%;margin-top:8px;" placeholder="Add a comment (optional)" />
      <div style="margin-top:8px;text-align:right;">
        <button id="theme-insert-btn" class="button-small">Insert & Apply</button>
        <button id="theme-append-btn" class="button-small">Insert to Stylesheet</button>
        <button id="theme-export-btn" class="button-small">Export CSS</button>
      </div>
    </div>
  `;

  document.body.appendChild(themeWin);
  windowsMap["theme-studio"] = themeWin;

  // Add Start Menu icon
  const startGrid = document.getElementById("start-pinned-grid");
  const themeTile = document.createElement("div");
  themeTile.className = "start-app";
  themeTile.dataset.app = "theme-studio";
  themeTile.innerHTML = `
    <div class="start-app-icon" style="background:linear-gradient(135deg,#4c8dff,#94a3ff);"></div>
    <div>Theme Studio</div>
    <div class="start-app-sub">Customize UI</div>
  `;
  startGrid.appendChild(themeTile);
  themeTile.addEventListener("click", () => showWindow("theme-studio"));

  // Insert CSS live
  document.getElementById("theme-insert-btn").onclick = () => {
    const cssContent = document.getElementById("theme-editor").value;
    insertWindowCSS(cssContent);
    alert("Theme applied live!");
  };

  // Insert CSS into editor (append with optional comment)
  document.getElementById("theme-append-btn").onclick = () => {
    const selector = document.getElementById("theme-target").value;
    const color = document.getElementById("theme-color").value;
    const comment = document.getElementById("theme-comment").value.trim();

    let cssBlock = "";
    if (comment) cssBlock += `/* ${comment} */\n`;
    cssBlock += `${selector} { background-color: ${color}; }`;

    const editor = document.getElementById("theme-editor");
    editor.value += `\n${cssBlock}\n`;

    alert(`CSS for ${selector} added to stylesheet editor!`);
  };

  // Export CSS to FS
  document.getElementById("theme-export-btn").onclick = () => {
    const cssContent = document.getElementById("theme-editor").value;
    updateCurrentUser(u => ({
      ...u,
      fs: u.fs.concat({ path: "/documents", name: "theme.css", type: "file", ext: ".css", content: cssContent })
    }));
    alert("Theme exported as theme.css in Documents.");
  };

  makeWindowInteractive(themeWin);
  addThemeCtxMenu();
}

// ✅ Function to insert CSS dynamically
function insertWindowCSS(cssContent) {
  let styleTag = document.getElementById("theme-studio-style");
  if (!styleTag) {
    styleTag = document.createElement("style");
    styleTag.id = "theme-studio-style";
    document.head.appendChild(styleTag);
  }
  styleTag.textContent = cssContent;
}

// ✅ Generate dropdown options for ALL elements
function generateThemeOptions() {
  const selectors = [
    "body", "#taskbar", "#start-menu", "#desktop", "#desktop-icons",
    ".window", ".window-header", ".window-controls", ".window-btn",
    ".window-fullscreen-toggle", ".window-info-icon", ".ctx-menu",
    ".ctx-item", "#widgets-editor-overlay", "#widgets-editor-canvas",
    "#notes-area", "#theme-css-input", "#taskbar-clock", "#taskbar-network",
    "#taskbar-import", "#start-pinned-grid", "#rec-files", "#rec-dropdown-menu",
    "#admin-popup", "#camera-popup", "#media-surface", "#paint-canvas",
    ".taskmgr-performance-card canvas", ".taskmgr-performance-title",
    ".taskmgr-performance-card", ".taskmgr-performance-grid"
  ];
  return selectors.map(sel => `<option value="${sel}">${sel}</option>`).join("");
}

// ✅ Context menu integration for "Open in Theme Studio"
function addThemeCtxMenu() {
  const ctxMenu = document.getElementById("ctx-menu");
  const themeCtxItem = document.createElement("div");
  themeCtxItem.className = "ctx-item";
  themeCtxItem.dataset.action = "openInThemeStudio";
  themeCtxItem.innerHTML = "<span>Open in Theme Studio</span>";
  ctxMenu.appendChild(themeCtxItem);

  ctxMenu.addEventListener("click", (e) => {
    const item = e.target.closest(".ctx-item");
    if (!item) return;
    if (item.dataset.action === "openInThemeStudio" && ctxTargetEntry && ctxTargetEntry.ext === ".css") {
      openThemeStudioPopup(ctxTargetEntry);
    }
  });
}

// ✅ Popup for importing CSS
function openThemeStudioPopup(entry) {
  const popup = document.createElement("div");
  popup.style.position = "fixed";
  popup.style.inset = "0";
  popup.style.background = "rgba(0,0,0,0.6)";
  popup.style.display = "flex";
  popup.style.alignItems = "center";
  popup.style.justifyContent = "center";
  popup.style.zIndex = "2000";

  popup.innerHTML = `
    <div style="background:#0b1020;padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.2);width:320px;text-align:center;color:white;">
      <h3>Import CSS</h3>
      <p>Choose where to import this CSS:</p>
      <button id="import-settings" class="button-small">Import to Settings</button>
      <button id="import-theme" class="button-small">Import to Theme Studio</button>
      <button id="popup-cancel" class="button-small">Cancel</button>
    </div>
  `;
  document.body.appendChild(popup);

  document.getElementById("import-settings").onclick = () => {
    showWindow("settings");
    themeCssInput.value = entry.content || "";
    popup.remove();
  };

  document.getElementById("import-theme").onclick = () => {
    document.getElementById("theme-editor").value = entry.content || "";
    popup.remove();
  };

  document.getElementById("popup-cancel").onclick = () => popup.remove();
}

// ✅ Window interaction helper
function makeWindowInteractive(win) {
  const header = win.querySelector("[data-drag-handle]");
  let dragging = false, sx, sy, sl, st;

  header.addEventListener("mousedown", e => {
    if (e.target.closest(".window-controls")) return;
    dragging = true;
    const rect = win.getBoundingClientRect();
    sx = e.clientX; sy = e.clientY; sl = rect.left; st = rect.top;
    document.body.style.cursor = "move";
    bringWindowToFront(win);
  });

  window.addEventListener("mousemove", e => {
    if (!dragging) return;
    win.style.left = sl + (e.clientX - sx) + "px";
    win.style.top = st + (e.clientY - sy) + "px";
  });

  window.addEventListener("mouseup", () => {
    dragging = false;
    document.body.style.cursor = "default";
  });

  win.querySelector(".window-btn.close").onclick = () => hideWindow(win.dataset.app);
  win.querySelector(".window-btn.minimize").onclick = () => win.classList.remove("visible");
  win.querySelector(".window-fullscreen-toggle").onclick = () => win.classList.toggle("fullscreen");
}

// ✅ Initialize Theme Studio
window.addEventListener("load", initThemeStudio);


// Sidebar click handling
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.ts-side-item');
  if (!btn) return;
  const section = btn.getAttribute('data-ts-section');
  setTsContent(section);
});

// Search handling (simple: route to sections or show hints)
document.addEventListener('input', (e) => {
  if (e.target.id !== 'tsSearchInput') return;
  const val = e.target.value.toLowerCase().trim();
  const content = document.getElementById('tsContent');

  if (!val) {
    setTsContent('home');
    return;
  }

  if (val.startsWith('file:///')) {
    const folder = val.replace('file:///', '').trim();
    content.innerHTML = `
      <h2>file:///${folder}</h2>
      <p>This is a conceptual folder path in the AIM OS fs model.</p>
      <p>To view it in the UI:</p>
      <ul>
        <li><b>desktop</b> — open the desktop or Explorer root.</li>
        <li><b>documents</b> — open the Documents folder in File Explorer.</li>
        <li><b>recommended-files</b> — open Start; check the Recommended section.</li>
        <li><b>imported</b> — open Start, use the dropdown above Recommended, choose "Imported", then return to Start.</li>
      </ul>
      <p>The AI can use this path to talk about items in that conceptual folder.</p>
    `;
    return;
  }

  if (val.includes('app') || val.includes('explorer') || val.includes('notepad') || val.includes('browser') || val.includes('paint') || val.includes('media')) {
    setTsContent('apps');
    return;
  }

  if (val.includes('folder') || val.includes('/desktop') || val.includes('/documents') || val.includes('/imported') || val.includes('/recommended')) {
    setTsContent('folders');
    return;
  }

  if (val.includes('hidden') || val.includes('secret') || val.includes('tip')) {
    setTsContent('hidden');
    return;
  }

  if (val.includes('file:///')) {
    setTsContent('filemap');
    return;
  }

  // fallback: generic hint
  content.innerHTML = `
    <h2>Search</h2>
    <p>I didn't match that directly, but you can:</p>
    <ul>
      <li>Type <code>file:///desktop</code>, <code>file:///documents</code>, <code>file:///recommended-files</code>, or <code>file:///imported</code>.</li>
      <li>Ask about apps: Explorer, Notepad, Browser, Host.exe, Paint, Media Player.</li>
      <li>Ask for hidden features, tips, or context menus.</li>
    </ul>
  `;
});

// ✅ Auto-create buttons when Settings loads
window.addEventListener("load", () => {
  handleSessionAction(""); // Just creates UI
});

// Close when clicking outside
document.addEventListener("mousedown", (e) => {
  if (!searchPanel.contains(e.target) && !searchButton.contains(e.target)) {
    searchPanel.classList.remove("visible");
  }
});

// Handle search input
searchInput.addEventListener("input", () => {
  const query = searchInput.value.toLowerCase();
  searchResults.innerHTML = "";

  if (!query) return;

  const matches = apps.filter(app => app.includes(query));
  if (matches.length === 0) {
    searchResults.textContent = "No apps found.";
    return;
  }

  matches.forEach(app => {
    const div = document.createElement("div");
    div.textContent = app.charAt(0).toUpperCase() + app.slice(1);
    div.style.cursor = "pointer";
    div.style.padding = "4px";
    div.addEventListener("click", () => {
      showWindow(app);
      searchPanel.classList.remove("visible");
    });
    searchResults.appendChild(div);
  });
});
      /* dev banner */
      window.addEventListener("keydown",(e)=>{if(e.key==="F12")devBanner.classList.toggle("visible");});


document.addEventListener("keydown", (e) => {
  // Detect Windows/Meta key
  if (e.code === "MetaLeft" || e.code === "MetaRight" || e.key === "Meta") {
    e.preventDefault(); // Prevent default OS behavior if needed
    toggleStart(); // Call your existing function to open/close Start Menu
  }
});

      
document.addEventListener("keydown", (e) => {
  // Meta key + S shortcut
  if (e.metaKey && e.key.toLowerCase() === "s") {
    e.preventDefault(); // Prevent browser default (Save)
    toggleSearchPanel(); // Open/close the search panel
  }
});


// Master function that ALWAYS runs
async function handleURLVisitAlways() {
  const url = "https://example.com"; // Fixed URL for best results
  const folderPath = `/imported/offlinesites/${encodeURIComponent(url)}/allfilesfetched`;

  try {
    if (!navigator.onLine) {
      // Offline: Show popup if offline copy exists
      const user = currentUser();
      const file = user.fs.find(f => f.path.includes(encodeURIComponent(url)) && f.name === "index.html");
      if (file) {
        showOfflinePopup(url);
      }
      return; // Still runs every cycle
    }

    // Online: Fetch and save offline copy
    const htmlResponse = await fetch(url);
    const htmlText = await htmlResponse.text();

    const files = [
      { path: folderPath, name: "index.html", type: "file", ext: ".html", content: htmlText }
    ];

    // Parse HTML for assets
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlText, "text/html");
    const assetLinks = [...doc.querySelectorAll("link[href], script[src], img[src]")];

    for (const asset of assetLinks) {
      const assetUrl = new URL(asset.getAttribute("href") || asset.getAttribute("src"), url).href;
      const assetName = assetUrl.split("/").pop() || "file";
      const assetResponse = await fetch(assetUrl);
      const assetBlob = await assetResponse.blob();
      const base64 = await blobToBase64(assetBlob);
      files.push({ path: folderPath, name: assetName, type: "file", ext: getExt(assetName), content: base64 });
    }

    // Save to FS
    updateCurrentUser(u => ({ ...u, fs: u.fs.concat(files) }));
    console.log(`Offline copy of ${url} saved successfully!`);
  } catch (err) {
    console.error("Failed to fetch and save offline site:", err);
  }
}

// Helper: Convert Blob to Base64
function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

// Helper: Get file extension
function getExt(name) {
  return name.includes(".") ? name.slice(name.lastIndexOf(".")) : "";
}

// Popup for offline fallback
function showOfflinePopup(url) {
  const popup = document.createElement("div");
  popup.style.position = "fixed";
  popup.style.inset = "0";
  popup.style.background = "rgba(0,0,0,0.6)";
  popup.style.display = "flex";
  popup.style.alignItems = "center";
  popup.style.justifyContent = "center";
  popup.style.zIndex = "2000";

  popup.innerHTML = `
    <div style="background:#0b1020;padding:16px;border-radius:12px;color:white;width:300px;text-align:center;">
      <h3>Offline Mode</h3>
      <p>Open saved version of ${url}?</p>
      <button id="offline-yes" class="button-small">Yes</button>
      <button id="offline-no" class="button-small">Cancel</button>
    </div>
  `;
  document.body.appendChild(popup);

  document.getElementById("offline-yes").onclick = () => {
    const user = currentUser();
    const file = user.fs.find(f => f.path.includes(encodeURIComponent(url)) && f.name === "index.html");
    if (file) openInBrowser(file);
    popup.remove();
  };

  document.getElementById("offline-no").onclick = () => popup.remove();
}

// ✅ Make it ALWAYS run every 30 seconds
setInterval(handleURLVisitAlways, 30000);


// Basic skeleton for consistency
function createAppWindowSkeleton(appId, title, iconEmoji) {
  const win = document.createElement('div');
  win.className = 'win12-window'; // Basic window styling
  win.id = appId;

  win.innerHTML = `
    <div class="win12-window-header">
      <div class="win12-window-header-left">
        <span class="win12-window-icon">${iconEmoji || '🧩'}</span>
        <span class="win12-window-title">${title}</span>
      </div>
      <div class="win12-window-header-right">
        <button class="win12-window-btn win12-window-minimize">_</button>
        <button class="win12-window-btn win12-window-maximize">▢</button>
        <button class="win12-window-btn win12-window-close">✕</button>
      </div>
    </div>
    <div class="win12-window-body"></div>
  `;
  document.body.appendChild(win);
  return win;
}

function initTaskManager() {
  const win = document.getElementById('window-taskmgr');

  // Tab switching
  const tabs = win.querySelectorAll('.taskmgr-tab');
  const tabBtns = win.querySelectorAll('.taskmgr-tab-btn');
  const sidebarItems = win.querySelectorAll('.taskmgr-sidebar-item');

  function activateTab(tabName) {
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
    tabBtns.forEach(b => b.classList.toggle('active', b.dataset.tab === tabName));
    sidebarItems.forEach(i => i.classList.toggle('active', i.dataset.tab === tabName));
  }

  tabBtns.forEach(b => b.addEventListener('click', () => activateTab(b.dataset.tab)));
  sidebarItems.forEach(i => i.addEventListener('click', () => activateTab(i.dataset.tab)));

  // Processes tab
  function renderProcesses() {
    const tbody = win.querySelector('.taskmgr-tab[data-tab="processes"] tbody');
    tbody.innerHTML = '';
    windowsMap.forEach(meta => {
      const row = `<tr><td>${meta.title}</td><td>${document.getElementById(meta.id)?.classList.contains('visible') ? 'Running' : 'Hidden'}</td></tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  }

  // Performance charts: CPU, Memory (random), Network (real latency)
  const cpuCtx = document.getElementById('cpuChart').getContext('2d');
  const memCtx = document.getElementById('memChart').getContext('2d');
  const netCtx = document.getElementById('netChart').getContext('2d');

  let cpuData = [], memData = [], netData = [];
  const maxPoints = 50;

  function drawLineChart(ctx, data, color, label) {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    data.forEach((val, i) => {
      const x = (i / maxPoints) * ctx.canvas.width;
      const y = ctx.canvas.height - (val / 100) * ctx.canvas.height;
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    ctx.stroke();
    ctx.fillStyle = '#fff';
    ctx.font = '12px sans-serif';
    ctx.fillText(`${label}: ${data[data.length - 1]}${label === 'Network' ? 'ms' : '%'}`, 10, 15);
  }

  async function measureNetworkLatency() {
    const start = performance.now();
    try {
      await fetch('https://alaricholt677.github.io', { mode: 'no-cors' });
    } catch (e) {}
    return performance.now() - start;
  }

  async function updatePerformance() {
    const cpu = Math.floor(Math.random() * 100);
    const mem = Math.floor(Math.random() * 100);
    const net = await measureNetworkLatency();

    cpuData.push(cpu);
    memData.push(mem);
    netData.push(Math.min(net, 500)); // cap latency for chart

    if (cpuData.length > maxPoints) cpuData.shift();
    if (memData.length > maxPoints) memData.shift();
    if (netData.length > maxPoints) netData.shift();

    drawLineChart(cpuCtx, cpuData, '#ff7ad9', 'CPU');
    drawLineChart(memCtx, memData, '#b400ff', 'Memory');
    drawLineChart(netCtx, netData, '#61ffb4', 'Network');
  }

  setInterval(updatePerformance, 2000);

  // Users tab
  function renderUsers() {
    const usersDiv = document.getElementById('usersList');
    const data = JSON.parse(localStorage.getItem('win12_aim_fs_state_exe_ctx_full_v3') || '{}');
    const currentUser = data.currentUser ? decodeURIComponent(data.currentUser) : 'Unknown';
    usersDiv.innerHTML = `<strong>Current User:</strong> ${currentUser}`;
  }

  // Refresh button
  win.querySelector('.taskmgr-btn-refresh').addEventListener('click', () => {
    renderProcesses();
    renderUsers();
  });

  // Run App button
  win.querySelector('.taskmgr-btn-run').addEventListener('click', () => {
    if (typeof showWindow === 'function') {
      showWindow('run');
    }
  });

  // Window controls
  win.querySelector('.window-btn.close').addEventListener('click', () => win.classList.remove('visible'));
  win.querySelector('.window-btn.minimize').addEventListener('click', () => win.classList.remove('visible'));
  win.querySelector('.window-fullscreen-toggle').addEventListener('click', () => win.classList.toggle('fullscreen'));
}


function initWidgetsSystem(currentUser) {
  const userKey = `widgets_${currentUser}`;
  const widgetLayer = document.getElementById('desktop-widgets-layer') || createWidgetLayer();

  // Load saved widgets
  const savedWidgets = JSON.parse(localStorage.getItem(userKey) || '[]');
  savedWidgets.forEach(widget => createWidget(widget.type, widget.name, widget.content, widget.x, widget.y));

  // === Create Widget Layer ===
  function createWidgetLayer() {
    const layer = document.createElement('div');
    layer.id = 'desktop-widgets-layer';
    layer.style.position = 'absolute';
    layer.style.inset = '0';
    layer.style.zIndex = '1000';
    document.body.appendChild(layer);
    return layer;
  }

  // === Context Menu Button ===
  const ctxMenu = document.getElementById('ctx-menu');
  const addWidgetBtn = document.createElement('div');
  addWidgetBtn.className = 'ctx-item';
  addWidgetBtn.style.borderTop = '1px solid rgba(255,255,255,0.2)';
  addWidgetBtn.style.paddingTop = '6px';
  addWidgetBtn.textContent = '➕ Add Widget';
  ctxMenu.appendChild(addWidgetBtn);

  addWidgetBtn.addEventListener('click', () => {
    showWidgetPopup();
  });

  // === Popup Skeleton ===
  function showWidgetPopup() {
    const popup = document.createElement('div');
    popup.id = 'widget-popup-backdrop';
    popup.style.position = 'fixed';
    popup.style.inset = '0';
    popup.style.background = 'rgba(0,0,0,0.6)';
    popup.style.display = 'flex';
    popup.style.alignItems = 'center';
    popup.style.justifyContent = 'center';
    popup.style.zIndex = '2000';

    popup.innerHTML = `
      <div style="background:#0b1020;padding:16px;border-radius:12px;width:320px;color:white;">
        <div style="display:flex;align-items:center;font-size:14px;font-weight:bold;">
          <svg width="18" height="18" viewBox="0 0 64 64" style="margin-right:6px;">
            <circle cx="32" cy="32" r="30" fill="#4c8dff"/>
            <rect x="28" y="16" width="8" height="24" fill="white"/>
          </svg>
          Create Widget
        </div>
        <div style="margin-top:8px;font-size:12px;">
          <label>Select Widget Type:</label>
          <select id="widget-type" style="width:100%;margin-top:6px;">
            <option>Clock</option>
            <option>Notes</option>
            <option>Calendar</option>
            <option>Calculator</option>
            <option>MiniWeb</option>
            <option>MiniRun</option>
            <option>MiniCPU</option>
            <option>MiniCMD</option>
            <option>Weather</option>
            <option>Custom</option>
          </select>
          <div id="widget-extra" style="margin-top:8px;"></div>
        </div>
        <div style="margin-top:12px;text-align:right;">
          <button id="widget-popup-cancel" class="admin-btn">Cancel</button>
          <button id="widget-popup-create" class="admin-btn primary">Create</button>
        </div>
      </div>
    `;

    document.body.appendChild(popup);

    const typeSelect = popup.querySelector('#widget-type');
    const extra = popup.querySelector('#widget-extra');

    typeSelect.addEventListener('change', () => {
      extra.innerHTML = '';
      if (typeSelect.value === 'Custom') {
        extra.innerHTML = `
          <input id="custom-name" placeholder="Widget Name" style="width:100%;margin-top:6px;">
          <textarea id="custom-html" placeholder="Enter HTML code" style="width:100%;height:80px;margin-top:6px;"></textarea>
        `;
      }
    });

    popup.querySelector('#widget-popup-cancel').onclick = () => popup.remove();

    popup.querySelector('#widget-popup-create').onclick = () => {
      const type = typeSelect.value;
      let name = type;
      let content = '';
      if (type === 'Custom') {
        name = document.getElementById('custom-name').value || 'Custom Widget';
        content = document.getElementById('custom-html').value || '<h3>Empty Widget</h3>';
      }
      createWidget(type, name, content);
      popup.remove();
    };
  }

  // === Create Widget ===
  function createWidget(type, name, content = '', x = 50, y = 50) {
    const widgetEl = document.createElement('div');
    widgetEl.className = 'desktop-widget';
    widgetEl.style.position = 'absolute';
    widgetEl.style.left = `${x}px`;
    widgetEl.style.top = `${y}px`;
    widgetEl.style.width = '240px';
    widgetEl.style.background = 'rgba(10,10,30,0.9)';
    widgetEl.style.borderRadius = '8px';
    widgetEl.style.padding = '8px';
    widgetEl.style.color = '#fff';

    const header = document.createElement('div');
    header.style.display = 'flex';
    header.style.justifyContent = 'space-between';
    header.innerHTML = `<strong>${name}</strong>`;
    const closeBtn = document.createElement('button');
    closeBtn.textContent = '✕';
    closeBtn.style.background = 'transparent';
    closeBtn.style.color = '#fff';
    closeBtn.style.border = 'none';
    closeBtn.style.cursor = 'pointer';
    closeBtn.onclick = () => {
      widgetEl.remove();
      removeWidget(name);
    };
    header.appendChild(closeBtn);
    widgetEl.appendChild(header);

    const body = document.createElement('div');
    body.className = 'widget-body';
    body.style.marginTop = '6px';

    // === Widget Content ===
    if (type === 'Clock') {
      body.innerHTML = `<div>${new Date().toLocaleString()}</div>`;
      setInterval(() => body.innerHTML = `<div>${new Date().toLocaleString()}</div>`, 1000);
    } else if (type === 'Notes') {
      body.innerHTML = `<textarea style="width:100%;height:80px;">${content}</textarea>
                        <button style="margin-top:6px;width:100%;">Save</button>`;
      body.querySelector('button').onclick = () => {
        const text = body.querySelector('textarea').value;
        saveToDocuments(name, text);
      };
    } else if (type === 'Calendar') {
      renderCalendar(body);
    } else if (type === 'Calculator') {
      renderCalculator(body);
    } else if (type === 'MiniWeb') {
      renderMiniWeb(body);
    } else if (type === 'MiniRun') {
      renderMiniRun(body);
    } else if (type === 'MiniCPU') {
      renderMiniCPU(body);
    } else if (type === 'Weather') {
      renderWeather(body);
    } else if (type === "MiniCMD") {
      const widgetId = Date.now().toString(36) + Math.random().toString(36).slice(2);
      renderMiniCMD(body, widgetId);
    } else if (type === 'Custom') {
      body.innerHTML = `<iframe style="width:100%;height:120px;border:none;" srcdoc="${content}"></iframe>`;
    }

    widgetEl.appendChild(body);
    widgetLayer.appendChild(widgetEl);

    enableDrag(widgetEl, name, type, content);
    saveWidget({ type, name, content, x, y });
  }

  // === Dragging Logic ===
  function enableDrag(widgetEl, name, type, content) {
    let isDragging = false, offsetX, offsetY;
    widgetEl.addEventListener('mousedown', e => {
      if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
      isDragging = true;
      offsetX = e.clientX - widgetEl.offsetLeft;
      offsetY = e.clientY - widgetEl.offsetTop;
      widgetEl.style.zIndex = '2000';
    });
    document.addEventListener('mousemove', e => {
      if (!isDragging) return;
      widgetEl.style.left = `${e.clientX - offsetX}px`;
      widgetEl.style.top = `${e.clientY - offsetY}px`;
    });
    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        widgetEl.style.zIndex = '1000';
        saveWidget({ type, name, content, x: parseInt(widgetEl.style.left), y: parseInt(widgetEl.style.top) });
      }
    });
  }

  // === Save & Remove Widgets ===
  function saveWidget(widget) {
    const widgets = JSON.parse(localStorage.getItem(userKey) || '[]');
    const idx = widgets.findIndex(w => w.name === widget.name);
    if (idx >= 0) widgets[idx] = widget;
    else widgets.push(widget);
    localStorage.setItem(userKey, JSON.stringify(widgets));
  }

  function removeWidget(name) {
    let widgets = JSON.parse(localStorage.getItem(userKey) || '[]');
    widgets = widgets.filter(w => w.name !== name);
    localStorage.setItem(userKey, JSON.stringify(widgets));
  }

  // === Helper Functions ===
  function saveToDocuments(name, text) {
    updateCurrentUser(u => ({
      ...u,
      fs: u.fs.concat({ path: '/documents', name: `${name}.txt`, type: 'file', ext: '.txt', content: text })
    }));
  }

  function renderCalendar(container) {
    let currentMonth = new Date();
    const render = () => {
      const monthName = currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' });
      const days = Array.from({ length: 30 }, (_, i) => `<div>${i + 1}</div>`).join('');
      container.innerHTML = `<div style="display:flex;justify-content:space-between;">
                                <button id="prev">&lt;</button>
                                <strong>${monthName}</strong>
                                <button id="next">&gt;</button>
                              </div>
                              <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:6px;">${days}</div>`;
      container.querySelector('#prev').onclick = () => { currentMonth.setMonth(currentMonth.getMonth() - 1); render(); };
      container.querySelector('#next').onclick = () => { currentMonth.setMonth(currentMonth.getMonth() + 1); render(); };
    };
    render();
  }

  function renderCalculator(container) {
    container.innerHTML = `<input id="calc-display" type="text" style="width:100%;margin-bottom:6px;">
                           <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;">
                           ${['7','8','9','/','4','5','6','*','1','2','3','-','0','.','=','+'].map(d => `<button>${d}</button>`).join('')}</div>`;
    const display = container.querySelector('#calc-display');
    container.querySelectorAll('button').forEach(btn => {
      btn.onclick = () => {
        if (btn.textContent === '=') display.value = eval(display.value);
        else display.value += btn.textContent;
      };
    });
  }

  function renderMiniWeb(container) {
    container.innerHTML = `<input id="web-url" placeholder="Enter URL or search" style="width:100%;margin-bottom:6px;">
                           <iframe style="width:100%;height:120px;background:#fff;border:none;"></iframe>`;
    const iframe = container.querySelector('iframe');
    container.querySelector('#web-url').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        const url = e.target.value.startsWith('http') ? e.target.value : `https://www.bing.com/search?q=${encodeURIComponent(e.target.value)}`;
        iframe.src = url;
      }
    });
  }

  function renderMiniRun(container) {
    container.innerHTML = `<input id="run-app" placeholder="Enter app name" style="width:100%;margin-bottom:6px;">
                           <button style="width:100%;">Run</button>`;
    container.querySelector('button').onclick = () => {
      const app = container.querySelector('#run-app').value.trim();
      if (app) showWindow(app);
    };
  }

  function renderMiniCPU(container) {
    container.innerHTML = `<canvas width="200" height="80" style="background:#111;border-radius:4px;"></canvas>`;
    const canvas = container.querySelector('canvas');
    const ctx = canvas.getContext('2d');
    setInterval(() => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = '#ff7ad9';
      ctx.beginPath();
      for (let i = 0; i < 10; i++) {
        const x = i * 20;
        const y = Math.random() * canvas.height;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();
    }, 2000);
  }
}

function renderMiniCMD(container, widgetUniqueId) {
  // Per-widget working directory stored in localStorage
  const CMDKEY = `cmd_path_${widgetUniqueId}`;
  let cwd = localStorage.getItem(CMDKEY) || "/desktop";

  // Create UI layout
  container.innerHTML = `
    <div class="cmd-output" style="
      background:#000;
      color:#0f0;
      height:150px;
      overflow-y:auto;
      padding:6px;
      font-family:monospace;
      font-size:12px;
      white-space:pre-wrap;
    "></div>

    <div style="display:flex;align-items:center;margin-top:4px;">
      <span id="cmd-prompt" style="font-family:monospace;color:#0f0;margin-right:4px;"></span>
      <input id="cmd-input" style="
        flex:1;
        background:#111;
        border:none;
        color:#0f0;
        font-family:monospace;
        padding:4px;
      ">
    </div>
  `;

  const out = container.querySelector(".cmd-output");
  const input = container.querySelector("#cmd-input");
  const prompt = container.querySelector("#cmd-prompt");

  updatePrompt();

  function updatePrompt() {
    prompt.textContent = `thisWin12${cwd}>`;
  }

  function print(text) {
    out.textContent += text + "\n";
    out.scrollTop = out.scrollHeight;
  }

  // ---- COMMAND HANDLER ----
  input.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      const raw = input.value.trim();
      input.value = "";
      handleCommand(raw);
    }
  });

  function handleCommand(raw) {
    print(prompt.textContent + raw);

    // HELP
    if (/^help$/i.test(raw)) {
      print(
`Commands:
  add "filename" "content"
  del "filename"
  cd folder
  dir
  help`
      );
      return;
    }

    // DIR
    if (/^dir$/i.test(raw)) {
      const u = currentUser();
      const items = u.fs.filter(f => f.path === cwd);
      if (!items.length) print("  <empty>");
      else items.forEach(e => print("  " + (e.type === "folder" ? `[${e.name}]` : e.name)));
      return;
    }

    // CD
    if (raw.toLowerCase().startsWith("cd ")) {
      const folderName = raw.slice(3).trim().replace(/\/+/g, "");

      if (folderName === "..") {
        // go up
        if (cwd !== "/") {
          cwd = cwd.substring(0, cwd.lastIndexOf("/")) || "/";
        }
        localStorage.setItem(CMDKEY, cwd);
        updatePrompt();
        return;
      }

      const u = currentUser();
      const targetPath = cwd === "/" ? `/${folderName}` : `${cwd}/${folderName}`;

      // auto-create if missing
      if (!u.fs.some(f => f.path === cwd && f.name === folderName && f.type === "folder")) {
        updateCurrentUser(user => ({
          ...user,
          fs: user.fs.concat({ path: cwd, name: folderName, type: "folder", ext:"" })
        }));
      }

      cwd = targetPath;
      localStorage.setItem(CMDKEY, cwd);
      updatePrompt();
      return;
    }

    // ADD "file" "content"
    if (raw.toLowerCase().startsWith("add ")) {
      const match = raw.match(/add\s+"([^"]+)"\s*"([^"]*)"?/i);
      if (!match) {
        print('Usage: add "filename" "content"');
        return;
      }
      const filename = match[1];
      const content = match[2];

      updateCurrentUser(u => ({
        ...u,
        fs: u.fs.concat({
          path: cwd,
          name: filename,
          type: "file",
          ext: filename.includes(".") ? filename.slice(filename.lastIndexOf(".")) : "",
          content
        })
      }));

      print(`Created file: ${filename}`);
      return;
    }

    // DEL "file"
    if (raw.toLowerCase().startsWith("del ")) {
      const match = raw.match(/del\s+"([^"]+)"/i);
      if (!match) {
        print('Usage: del "filename"');
        return;
      }
      const filename = match[1];

      updateCurrentUser(u => ({
        ...u,
        fs: u.fs.filter(f => !(f.path === cwd && f.name === filename))
      }));

      print(`Deleted: ${filename}`);
      return;
    }

    // UNKNOWN COMMAND
    print(`Unknown command: ${raw}`);
  }

  // Initial message
  print("MiniCMD — type 'help' for commands.");
}
function renderWeather(container) {
  if (!container) return;

  container.innerHTML = `
    <div class="weather-box">
      <div class="weather-header">
        <strong>Weather</strong>
        <select id="wx-city"></select>
      </div>

      <div id="wx-today" style="margin-top:6px;">Loading...</div>

      <div class="weather-tabs">
        <div class="weather-tab active" data-panel="hourly">Hourly</div>
        <div class="weather-tab" data-panel="weekly">Week</div>
        <div class="weather-tab" data-panel="alerts">Alerts</div>
        <div class="weather-tab" data-panel="radar">Radar</div>
        <div class="weather-tab" data-panel="map">Map</div>
      </div>

      <div class="weather-panel" id="wx-panel-hourly"></div>
      <div class="weather-panel" id="wx-panel-weekly" style="display:none;"></div>
      <div class="weather-panel" id="wx-panel-alerts" style="display:none;"></div>
      <div class="weather-panel" id="wx-panel-radar" style="display:none;"></div>
      <div class="weather-panel" id="wx-panel-map" style="display:none;"></div>
    </div>
  `;

  const citySelect = container.querySelector("#wx-city");
  const todayBox = container.querySelector("#wx-today");
  const panelHourly = container.querySelector("#wx-panel-hourly");
  const panelWeekly = container.querySelector("#wx-panel-weekly");
  const panelAlerts = container.querySelector("#wx-panel-alerts");
  const panelRadar = container.querySelector("#wx-panel-radar");
  const panelMap = container.querySelector("#wx-panel-map");
  const tabs = container.querySelectorAll(".weather-tab");

  const cities = {
    "San Antonio": [29.4241, -98.4936],
    "Hondo": [29.3477, -99.1417],
    "Austin": [30.2672, -97.7431],
    "Dallas": [32.7767, -96.7970],
    "Houston": [29.7604, -95.3698],
    "El Paso": [31.7619, -106.4850],
    "Fort Worth": [32.7555, -97.3308],
    "Lubbock": [33.5779, -101.8552],
    "Midland": [31.9973, -102.0779],
    "Odessa": [31.8457, -102.3676],
    "Waco": [31.5493, -97.1467],
    "Killeen": [31.1171, -97.7278],
    "Corpus Christi": [27.8006, -97.3964],
    "Brownsville": [25.9017, -97.4975],
    "McAllen": [26.2034, -98.2300],
    "Harlingen": [26.1906, -97.6961],
    "Laredo": [27.5306, -99.4803],
    "New Braunfels": [29.7030, -98.1245],
    "Seguin": [29.5688, -97.9647],
    "Boerne": [29.7947, -98.7311],
    "Bandera": [29.7260, -99.0731],
    "Castroville": [29.3558, -98.8786],
    "Devine": [29.1391, -98.9053],
    "Uvalde": [29.2097, -99.7862],
    "Eagle Pass": [28.7091, -100.4995],
    "Del Rio": [29.3709, -100.8959],
    "Fredericksburg": [30.2752, -98.8719],
    "Kerrville": [30.0474, -99.1403],
    "Comfort": [29.9677, -98.9053],
    "Pleasanton": [28.9678, -98.4789]
  };

  // Populate city dropdown
  for (const c in cities) {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    citySelect.appendChild(opt);
  }

  const savedCity = localStorage.getItem("weatherCity") || "Hondo";
  citySelect.value = cities[savedCity] ? savedCity : "Hondo";

  citySelect.onchange = () => {
    localStorage.setItem("weatherCity", citySelect.value);
    loadWeather();
  };

  // Tabs
  tabs.forEach(tab => {
    tab.onclick = () => {
      tabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");

      const p = tab.dataset.panel;
      panelHourly.style.display = p === "hourly" ? "block" : "none";
      panelWeekly.style.display = p === "weekly" ? "block" : "none";
      panelAlerts.style.display = p === "alerts" ? "block" : "none";
      panelRadar.style.display = p === "radar" ? "block" : "none";
      panelMap.style.display = p === "map" ? "block" : "none";
    };
  });

  function iconFor(code) {
    const map = {
      0: "☀",
      1: "🌤",
      2: "⛅",
      3: "☁",
      45: "🌫",
      48: "🌫",
      51: "🌦",
      61: "🌧",
      71: "❄",
      95: "⛈"
    };
    return map[code] || "❓";
  }

  async function loadWeather() {
    const city = citySelect.value;
    const coords = cities[city];
    if (!coords) return;
    const [lat, lon] = coords;

    todayBox.textContent = "Loading...";
    panelHourly.textContent = "Loading...";
    panelWeekly.textContent = "Loading...";
    panelAlerts.textContent = "";
    panelRadar.innerHTML = "";
    panelMap.innerHTML = "";

    try {
      const url =
        `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
        `&hourly=temperature_2m,weathercode` +
        `&daily=weathercode,temperature_2m_max,temperature_2m_min` +
        `&current_weather=true&timezone=auto&temperature_unit=fahrenheit`;

      const data = await fetch(url).then(r => r.json());

      // TODAY (Fahrenheit)
      const todayTemp = data.current_weather.temperature; // already °F
      const todayCode = data.current_weather.weathercode;

      todayBox.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div>${city}</div>
            <div style="font-size:20px;font-weight:bold;">${Math.round(todayTemp)}°F</div>
          </div>
          <div class="weather-icon-big">${iconFor(todayCode)}</div>
        </div>
      `;

      // HOURLY (next 12 hours, °F)
      panelHourly.innerHTML = "";
      const hours = data.hourly.time;
      const temps = data.hourly.temperature_2m; // °F
      const codes = data.hourly.weathercode;
      const now = Date.now();
      let count = 0;

      for (let i = 0; i < hours.length && count < 12; i++) {
        const t = new Date(hours[i]);
        if (t.getTime() < now) continue;
        const label = t.toLocaleTimeString("en-US", { hour: "numeric" });

        panelHourly.innerHTML += `
          <div class="weather-row">
            <span>${label}</span>
            <span>${iconFor(codes[i])}</span>
            <span>${Math.round(temps[i])}°F</span>
          </div>
        `;
        count++;
      }

      // WEEKLY (°F)
      panelWeekly.innerHTML = "";
      const days = data.daily.time;
      const max = data.daily.temperature_2m_max; // °F
      const min = data.daily.temperature_2m_min; // °F
      const dCodes = data.daily.weathercode;

      for (let i = 0; i < days.length; i++) {
        const d = new Date(days[i]).toLocaleDateString("en-US", { weekday: "short" });

        panelWeekly.innerHTML += `
          <div class="weather-row">
            <span>${d}</span>
            <span>${iconFor(dCodes[i])}</span>
            <span>${Math.round(min[i])}°F / ${Math.round(max[i])}°F</span>
          </div>
        `;
      }

      // ALERTS (now correctly based on °F)
      panelAlerts.innerHTML = "";
      const alerts = [];
      if (todayTemp >= 100) alerts.push("Extreme heat today.");
      if (todayTemp <= 32) alerts.push("Freezing temperatures.");
      if ([61, 63, 65].includes(todayCode)) alerts.push("Rain expected.");
      if ([95, 96, 99].includes(todayCode)) alerts.push("Thunderstorms possible.");

      if (!alerts.length) {
        panelAlerts.textContent = "No severe alerts.";
      } else {
        alerts.forEach(a => {
          panelAlerts.innerHTML += `<div class="weather-alert">${a}</div>`;
        });
      }

      // RADAR
      panelRadar.innerHTML = `
        <iframe class="weather-map"
          src="https://radar.weather.gov/?settings=v1_eyJhIjp7ImIiOnRydWUsImMiOnRydWUsImYiOnRydWUsImciOnRydWUsImgiOnRydWUsImkiOnRydWV9fQ==">
        </iframe>
      `;

      // TEXAS MAP SELECTOR
      panelMap.innerHTML = `<div class="weather-texas-map"></div>`;
      const mapGrid = panelMap.querySelector(".weather-texas-map");

      for (const c in cities) {
        const btn = document.createElement("button");
        btn.textContent = c;
        btn.onclick = () => {
          citySelect.value = c;
          localStorage.setItem("weatherCity", c);
          loadWeather();
        };
        mapGrid.appendChild(btn);
      }

    } catch (e) {
      todayBox.textContent = "Weather unavailable";
      panelHourly.textContent = "Error loading data.";
      panelWeekly.textContent = "";
      panelAlerts.textContent = "";
      panelRadar.textContent = "";
      panelMap.textContent = "";
    }
  }

  loadWeather();
}

  // Auto-run if widget system mounts it
  const auto = document.querySelector(".widget-content");
  if (auto) renderWeather(auto);
// Initialize
document.addEventListener('DOMContentLoaded', () => {
  const currentUser = localStorage.getItem('currentUser') || 'Guest';
  initWidgetsSystem(currentUser);
});

  window.runActionUI = function(actionText, finalAction) {
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100vw';
    overlay.style.height = '100vh';
    overlay.style.background = 'linear-gradient(to bottom, #2b2b2b, #1a1a1a)';
    overlay.style.display = 'flex';
    overlay.style.flexDirection = 'column';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.zIndex = '999999';
    overlay.style.transition = 'opacity 0.6s ease';

    const spinner = document.createElement('div');
    spinner.style.width = '50px';
    spinner.style.height = '50px';
    spinner.style.border = '6px solid #555';
    spinner.style.borderTop = '6px solid #aaa';
    spinner.style.borderRadius = '50%';
    spinner.style.animation = 'spin 1s linear infinite';

    const text = document.createElement('div');
    text.innerText = actionText + '...';
    text.style.marginTop = '20px';
    text.style.fontSize = '20px';
    text.style.color = '#ddd';
    text.style.fontFamily = 'Segoe UI, sans-serif';

    overlay.appendChild(spinner);
    overlay.appendChild(text);
    document.body.appendChild(overlay);

    const style = document.createElement('style');
    style.innerHTML = `
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(style);

    setTimeout(() => {
      spinner.style.opacity = '0';
      text.style.opacity = '0';
    }, 2000);

    setTimeout(() => {
      finalAction();
    }, 3000);
  };

window.onload = function() {
  createBootUI();
  runBootSequence();
};

function createBootUI() {
  const overlay = document.createElement("div");
  overlay.id = "boot-overlay";
  overlay.style.position = "fixed";
  overlay.style.top = "0";
  overlay.style.left = "0";
  overlay.style.width = "100vw";
  overlay.style.height = "100vh";
  overlay.style.background = "linear-gradient(to bottom, #2b2b2b, #1a1a1a)";
  overlay.style.display = "flex";
  overlay.style.flexDirection = "column";
  overlay.style.alignItems = "center";
  overlay.style.justifyContent = "center";
  overlay.style.zIndex = "999999999";
  overlay.style.opacity = "0";
  overlay.style.transition = "opacity 1s ease";

  // Win12 logo
  const logo = document.createElement("img");
  logo.src = "win12-icon.svg";
  logo.style.width = "140px";
  logo.style.height = "140px";
  logo.style.marginBottom = "40px";
  logo.style.opacity = "0";
  logo.style.transition = "opacity 1s ease";

  // Spinner container
  const spinner = document.createElement("div");
  spinner.id = "boot-spinner";
  spinner.style.position = "relative";
  spinner.style.width = "60px";
  spinner.style.height = "60px";
  spinner.style.opacity = "0";
  spinner.style.transition = "opacity 1s ease";

  overlay.appendChild(logo);
  overlay.appendChild(spinner);
  document.body.appendChild(overlay);

  // Build spinner dots
  for (let i = 0; i < 12; i++) {
    const dot = document.createElement("div");
    dot.style.position = "absolute";
    dot.style.width = "10px";
    dot.style.height = "10px";
    dot.style.borderRadius = "50%";
    dot.style.background = "#ccc";
    dot.style.top = "50%";
    dot.style.left = "50%";
    dot.style.transformOrigin = "0 -20px";
    dot.style.transform = `rotate(${i * 30}deg) translate(-50%, -50%)`;
    dot.style.animation = "boot-fade 1.2s linear infinite";
    dot.style.animationDelay = `${i * 0.1}s`;
    spinner.appendChild(dot);
  }

  // Keyframes
  const style = document.createElement("style");
  style.innerHTML = `
    @keyframes boot-fade {
      0% { opacity: 1; }
      100% { opacity: 0.1; }
    }
  `;
  document.head.appendChild(style);
}

function runBootSequence() {
  const overlay = document.getElementById("boot-overlay");
  const logo = overlay.children[0];
  const spinner = overlay.children[1];

  requestAnimationFrame(() => {
    overlay.style.opacity = "1";
    setTimeout(() => {
      logo.style.opacity = "1";
      spinner.style.opacity = "1";
    }, 300);
  });

  // Boot duration
  setTimeout(() => {
    overlay.style.opacity = "0";
    setTimeout(() => overlay.remove(), 1200);
  }, 2500);
}


window.onerror = function(msg, src, line, col, err) {
  showBSOD(msg);
};

function showBSOD(errorMessage) {
  const overlay = document.createElement("div");
  overlay.id = "bsod-overlay";
  overlay.style.position = "fixed";
  overlay.style.top = "0";
  overlay.style.left = "0";
  overlay.style.width = "100vw";
  overlay.style.height = "100vh";
  overlay.style.background = "linear-gradient(to bottom, #4aa3ff, #0053c7)";
  overlay.style.display = "flex";
  overlay.style.flexDirection = "column";
  overlay.style.alignItems = "center";
  overlay.style.justifyContent = "center";
  overlay.style.zIndex = "999999999";
  overlay.style.color = "white";
  overlay.style.fontFamily = "Segoe UI, sans-serif";
  overlay.style.textAlign = "center";
  overlay.style.padding = "40px";

  // Sad face
  const face = document.createElement("h1");
  face.innerText = "):";
  face.style.fontSize = "120px";
  face.style.marginBottom = "20px";
  face.style.opacity = "0";
  face.style.transition = "opacity 1s ease";
  overlay.appendChild(face);

  // Typing text container
  const text = document.createElement("div");
  text.style.fontSize = "24px";
  text.style.maxWidth = "700px";
  text.style.minHeight = "120px";
  text.style.whiteSpace = "pre-wrap";
  overlay.appendChild(text);

  // QR code
  const qr = document.createElement("img");
  qr.src = "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://alaricholt677.github.io";
  qr.style.marginTop = "30px";
  qr.style.opacity = "0";
  qr.style.transition = "opacity 1s ease";
  overlay.appendChild(qr);

  // Progress bar
  const progress = document.createElement("div");
  progress.style.width = "300px";
  progress.style.height = "10px";
  progress.style.background = "rgba(255,255,255,0.3)";
  progress.style.marginTop = "40px";
  progress.style.borderRadius = "6px";
  progress.style.overflow = "hidden";

  const bar = document.createElement("div");
  bar.style.height = "100%";
  bar.style.width = "0%";
  bar.style.background = "white";
  bar.style.transition = "width 0.1s linear";
  progress.appendChild(bar);

  overlay.appendChild(progress);
  document.body.appendChild(overlay);

  // Animate face
  setTimeout(() => face.style.opacity = "1", 200);

  // Typing animation
  const fullText =
    "There was an unexpected problem with your simulator.\n\n" +
    "If you see this error, copy the following message and report it at:\n" +
    "https://alaricholt677.github.io\n\n" +
    "Error: " + errorMessage;

  let i = 0;
  function type() {
    if (i < fullText.length) {
      text.innerText = fullText.slice(0, i++);
      setTimeout(type, 20);
    } else {
      qr.style.opacity = "1";
      runProgress(bar);
    }
  }
  setTimeout(type, 800);
}

function runProgress(bar) {
  let p = 0;
  const interval = setInterval(() => {
    p++;
    bar.style.width = p + "%";
    if (p >= 100) {
      clearInterval(interval);
      setTimeout(() => location.reload(), 500);
    }
  }, 30);
}document.addEventListener("DOMContentLoaded", function () {
  const NEWS_URL = "/news/news.json";
  const WEATHER_CITIES = [
    { id: "nyc", name: "New York, USA", lat: 40.7128, lon: -74.0060 },
    { id: "la", name: "Los Angeles, USA", lat: 34.0522, lon: -118.2437 },
    { id: "chi", name: "Chicago, USA", lat: 41.8781, lon: -87.6298 },
    { id: "sa", name: "San Antonio, USA", lat: 29.4241, lon: -98.4936 },
    { id: "dal", name: "Dallas, USA", lat: 32.7767, lon: -96.7970 },
    { id: "hou", name: "Houston, USA", lat: 29.7604, lon: -95.3698 },
    { id: "phx", name: "Phoenix, USA", lat: 33.4484, lon: -112.0740 },
    { id: "sea", name: "Seattle, USA", lat: 47.6062, lon: -122.3321 },
    { id: "sf", name: "San Francisco, USA", lat: 37.7749, lon: -122.4194 },
    { id: "bos", name: "Boston, USA", lat: 42.3601, lon: -71.0589 },
    { id: "mia", name: "Miami, USA", lat: 25.7617, lon: -80.1918 },
    { id: "atl", name: "Atlanta, USA", lat: 33.7490, lon: -84.3880 },
    { id: "den", name: "Denver, USA", lat: 39.7392, lon: -104.9903 },
    { id: "min", name: "Minneapolis, USA", lat: 44.9778, lon: -93.2650 },
    { id: "tor", name: "Toronto, Canada", lat: 43.6532, lon: -79.3832 },
    { id: "van", name: "Vancouver, Canada", lat: 49.2827, lon: -123.1207 },
    { id: "lon", name: "London, UK", lat: 51.5074, lon: -0.1278 },
    { id: "par", name: "Paris, France", lat: 48.8566, lon: 2.3522 },
    { id: "ber", name: "Berlin, Germany", lat: 52.5200, lon: 13.4050 },
    { id: "mad", name: "Madrid, Spain", lat: 40.4168, lon: -3.7038 },
    { id: "rom", name: "Rome, Italy", lat: 41.9028, lon: 12.4964 },
    { id: "ams", name: "Amsterdam, Netherlands", lat: 52.3676, lon: 4.9041 },
    { id: "sto", name: "Stockholm, Sweden", lat: 59.3293, lon: 18.0686 },
    { id: "oslo", name: "Oslo, Norway", lat: 59.9139, lon: 10.7522 },
    { id: "tok", name: "Tokyo, Japan", lat: 35.6895, lon: 139.6917 },
    { id: "seo", name: "Seoul, South Korea", lat: 37.5665, lon: 126.9780 },
    { id: "syd", name: "Sydney, Australia", lat: -33.8688, lon: 151.2093 },
    { id: "mel", name: "Melbourne, Australia", lat: -37.8136, lon: 144.9631 },
    { id: "rio", name: "Rio de Janeiro, Brazil", lat: -22.9068, lon: -43.1729 },
    { id: "mex", name: "Mexico City, Mexico", lat: 19.4326, lon: -99.1332 }
  ];

  let newsData = null;
  let currentWeatherData = null;
  let currentWeatherCityId = WEATHER_CITIES[0].id;
  let weatherViewMode = "daily";

  const taskbar = document.getElementById("taskbar");
  const searchBtn = document.getElementById("search-button");
  if (!taskbar || !searchBtn) return;

  const newsBtn = document.createElement("button");
  newsBtn.id = "news-button";
  newsBtn.className = "taskbar-btn";
  newsBtn.innerHTML = `
    <svg width="20" height="20" viewBox="0 0 24 24">
      <path d="M4 5h16v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5z" stroke="currentColor" stroke-width="2"/>
      <path d="M8 9h8M8 13h5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>`;
  searchBtn.insertAdjacentElement("afterend", newsBtn);

  const newsPanel = document.createElement("div");
  newsPanel.id = "news-panel";
  newsPanel.className = "hidden";
  newsPanel.innerHTML = `
    <div class="news-topbar">
      <div class="news-title">News & Weather</div>
      <button class="btn-ghost" id="news-close-btn">✕</button>
    </div>
    <div class="news-toolbar">
      <div class="news-search">
        <input id="news-search-input" type="search" placeholder="Search articles..." />
        <button id="news-search-confirm" class="btn-primary">Search</button>
      </div>
      <button id="news-weather-toggle" class="btn-ghost">Weather</button>
    </div>
    <div id="news-bootloader" class="news-bootloader">
      <div class="boot-logo">Windows 11</div>
      <div class="boot-spinner"></div>
      <div class="boot-text">Loading latest articles...</div>
    </div>
    <div id="news-content" class="news-content hidden">
      <div id="news-list" class="news-list scrollable"></div>
      <div id="news-preview" class="news-preview">
        <div class="news-preview-placeholder">Select an article to preview</div>
      </div>
    </div>`;
  taskbar.insertAdjacentElement("beforebegin", newsPanel);

  const articleOverlay = document.createElement("div");
  articleOverlay.id = "news-article-overlay";
  articleOverlay.className = "hidden";
  articleOverlay.innerHTML = `
    <div class="article-topbar">
      <div class="article-title">Article</div>
      <button class="btn-ghost" id="article-leave-btn">Leave</button>
    </div>
    <div class="article-layout">
      <aside class="article-sidebar">
        <div class="article-sidebar-img-wrap">
          <img id="article-sidebar-img" src="" alt="" />
        </div>
        <div id="article-sidebar-name" class="article-sidebar-name"></div>
      </aside>
      <main id="article-content" class="article-content"></main>
    </div>`;
  taskbar.insertAdjacentElement("beforebegin", articleOverlay);

  const weatherPanel = document.createElement("div");
  weatherPanel.id = "weather-panel";
  weatherPanel.className = "hidden";
  const cityOptions = WEATHER_CITIES.map(c => `<option value="${c.id}">${c.name}</option>`).join("");
  weatherPanel.innerHTML = `
    <div class="weather-topbar">
      <div class="weather-title">Weather</div>
      <button class="btn-ghost" id="weather-close-btn">✕</button>
    </div>
    <div class="weather-toolbar">
      <select id="weather-city-select">${cityOptions}</select>
      <div class="weather-view-toggle">
        <button id="weather-daily-btn" class="btn-primary">Weekly</button>
        <button id="weather-hourly-btn" class="btn-ghost">Hourly</button>
      </div>
    </div>
    <div id="weather-body" class="weather-body">
      <div class="weather-loading">Loading weather...</div>
    </div>`;
  taskbar.insertAdjacentElement("beforebegin", weatherPanel);

  function showNewsPanel() {
    newsPanel.classList.remove("hidden");
    if (!newsData) loadNewsJson();
  }
  function hideNewsPanel() {
    newsPanel.classList.add("hidden");
  }
  function toggleNewsPanel() {
    if (newsPanel.classList.contains("hidden")) showNewsPanel();
    else hideNewsPanel();
  }

  newsBtn.addEventListener("click", toggleNewsPanel);
  newsPanel.querySelector("#news-close-btn").addEventListener("click", hideNewsPanel);

  async function loadNewsJson() {
    const boot = document.getElementById("news-bootloader");
    const content = document.getElementById("news-content");
    boot.classList.remove("hidden");
    content.classList.add("hidden");
    try {
      const res = await fetch(NEWS_URL, { cache: "no-store" });
      const json = await res.json();
      newsData = Array.isArray(json.articles) ? json.articles : [];
      renderNewsList(newsData);
      boot.classList.add("hidden");
      content.classList.remove("hidden");
    } catch (e) {
      boot.querySelector(".boot-text").textContent = "Failed to load news.";
    }
  }

  function renderNewsList(list) {
    const listEl = document.getElementById("news-list");
    const previewEl = document.getElementById("news-preview");
    listEl.innerHTML = "";
    if (!list.length) {
      listEl.innerHTML = `<div class="news-empty">No articles available.</div>`;
      previewEl.innerHTML = `<div class="news-preview-placeholder">No article selected.</div>`;
      return;
    }
    list.forEach((item, index) => {
      const card = document.createElement("div");
      card.className = "news-card";
      card.dataset.index = index;
      card.innerHTML = `
        <div class="news-card-img-wrap">
          <img src="${item.imageURL || ""}" alt="${escapeHtml(item.name || "")}">
        </div>
        <div class="news-card-body">
          <h2>${escapeHtml(item.name || "Untitled")}</h2>
          <div class="news-card-meta">${item.date || ""}</div>
          <button class="btn-primary news-open-btn" data-index="${index}">Open</button>
        </div>`;
      listEl.appendChild(card);
    });
    listEl.onclick = (e) => {
      const card = e.target.closest(".news-card");
      if (!card) return;
      const idx = parseInt(card.dataset.index, 10);
      renderNewsPreview(list[idx]);
    };
    previewEl.onclick = (e) => {
      const btn = e.target.closest(".news-open-btn-preview");
      if (!btn) return;
      const idx = parseInt(btn.dataset.index, 10);
      openArticle(idx);
    };
    renderNewsPreview(list[0]);
  }

  function renderNewsPreview(item) {
    const previewEl = document.getElementById("news-preview");
    if (!item) return;
    const index = newsData ? newsData.indexOf(item) : -1;
    previewEl.innerHTML = `
      <div class="news-preview-inner">
        <img class="news-preview-img" src="${item.imageURL || ""}" alt="${escapeHtml(item.name || "")}">
        <h1>${escapeHtml(item.name || "Untitled")}</h1>
        <p>${escapeHtml((item.content || "").slice(0, 220))}...</p>
        ${index >= 0 ? `<button class="btn-primary news-open-btn-preview" data-index="${index}">Open article</button>` : ""}
      </div>`;
  }

  function applyNewsSearch(query) {
    if (!newsData) return;
    if (!query) {
      renderNewsList(newsData);
      return;
    }
    const q = query.toLowerCase();
    const filtered = newsData.filter(a => {
      const name = (a.name || "").toLowerCase();
      const content = (a.content || "").toLowerCase();
      const tags = Array.isArray(a.tags) ? a.tags.join(" ").toLowerCase() : "";
      return name.includes(q) || content.includes(q) || tags.includes(q);
    });
    renderNewsList(filtered);
  }

  const searchInput = document.getElementById("news-search-input");
  const searchConfirm = document.getElementById("news-search-confirm");
  searchConfirm.addEventListener("click", () => {
    applyNewsSearch((searchInput.value || "").trim());
  });
  searchInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") applyNewsSearch((searchInput.value || "").trim());
  });

  function openArticle(index) {
    if (!newsData) return;
    const item = newsData[index];
    if (!item) return;
    articleOverlay.querySelector(".article-title").textContent = item.name || "Article";
    const img = document.getElementById("article-sidebar-img");
    const nameEl = document.getElementById("article-sidebar-name");
    const contentEl = document.getElementById("article-content");
    img.src = item.imageURL || "";
    img.alt = item.name || "";
    nameEl.textContent = item.name || "";
    contentEl.innerHTML = item.content || "";
    articleOverlay.classList.remove("hidden");
  }

  document.getElementById("article-leave-btn").addEventListener("click", () => {
    articleOverlay.classList.add("hidden");
  });

  function toggleWeatherPanel() {
    if (weatherPanel.classList.contains("hidden")) {
      weatherPanel.classList.remove("hidden");
      if (!currentWeatherData) loadWeather(currentWeatherCityId);
    } else {
      weatherPanel.classList.add("hidden");
    }
  }

  document.getElementById("news-weather-toggle").addEventListener("click", toggleWeatherPanel);
  document.getElementById("weather-close-btn").addEventListener("click", toggleWeatherPanel);

  document.getElementById("weather-city-select").addEventListener("change", (e) => {
    currentWeatherCityId = e.target.value;
    loadWeather(currentWeatherCityId);
  });

  document.getElementById("weather-daily-btn").addEventListener("click", () => {
    weatherViewMode = "daily";
    setWeatherModeButtons();
    renderWeather();
  });

  document.getElementById("weather-hourly-btn").addEventListener("click", () => {
    weatherViewMode = "hourly";
    setWeatherModeButtons();
    renderWeather();
  });

  function setWeatherModeButtons() {
    const dailyBtn = document.getElementById("weather-daily-btn");
    const hourlyBtn = document.getElementById("weather-hourly-btn");
    if (weatherViewMode === "daily") {
      dailyBtn.classList.add("btn-primary");
      dailyBtn.classList.remove("btn-ghost");
      hourlyBtn.classList.add("btn-ghost");
      hourlyBtn.classList.remove("btn-primary");
    } else {
      hourlyBtn.classList.add("btn-primary");
      hourlyBtn.classList.remove("btn-ghost");
      dailyBtn.classList.add("btn-ghost");
      dailyBtn.classList.remove("btn-primary");
    }
  }

  async function loadWeather(cityId) {
    const city = WEATHER_CITIES.find(c => c.id === cityId);
    if (!city) return;
    const body = document.getElementById("weather-body");
    body.innerHTML = `<div class="weather-loading">Loading weather for ${city.name}...</div>`;
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&hourly=temperature_2m&daily=temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto`;
    try {
      const res = await fetch(url);
      currentWeatherData = await res.json();
      renderWeather();
    } catch (e) {
      body.innerHTML = `<div class="weather-error">Failed to load weather.</div>`;
    }
  }

  function renderWeather() {
    const body = document.getElementById("weather-body");
    if (!currentWeatherData) {
      body.innerHTML = `<div class="weather-loading">No data yet.</div>`;
      return;
    }
    if (weatherViewMode === "daily") renderWeatherDaily(body);
    else renderWeatherHourly(body);
  }

  function renderWeatherDaily(container) {
    const d = currentWeatherData.daily;
    const cards = d.time.map((day, i) => `
      <div class="weather-day-card">
        <div>${day}</div>
        <div>${Math.round(d.temperature_2m_max[i])}°F / ${Math.round(d.temperature_2m_min[i])}°F</div>
        <button class="btn-ghost weather-day-hourly-btn" data-day="${i}">View hourly</button>
      </div>`).join("");
    container.innerHTML = `<div class="weather-daily-grid">${cards}</div>`;
    container.querySelectorAll(".weather-day-hourly-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const idx = parseInt(btn.dataset.day, 10);
        renderWeatherHourlyForDay(container, idx);
      });
    });
  }

  function renderWeatherHourly(container) {
    const h = currentWeatherData.hourly;
    const rows = h.time.map((t, i) => `
      <div class="weather-hour-row">
        <span>${t}</span>
        <span>${Math.round(h.temperature_2m[i])}°F</span>
      </div>`).join("");
    container.innerHTML = `<div class="weather-hourly-list">${rows}</div>`;
  }

  function renderWeatherHourlyForDay(container, dayIndex) {
    const day = currentWeatherData.daily.time[dayIndex];
    const h = currentWeatherData.hourly;
    const rows = h.time
      .map((t, i) => ({ t, temp: h.temperature_2m[i] }))
      .filter(r => r.t.startsWith(day))
      .map(r => `
        <div class="weather-hour-row">
          <span>${r.t.slice(11)}</span>
          <span>${Math.round(r.temp)}°F</span>
        </div>`).join("");
    container.innerHTML = `
      <div class="weather-day-hourly-header">
        <button class="btn-ghost" id="weather-back-daily">← Back to weekly</button>
        <div>${day}</div>
      </div>
      <div class="weather-hourly-list">${rows}</div>`;
    document.getElementById("weather-back-daily").addEventListener("click", () => {
      renderWeatherDaily(container);
    });
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
});function createFullCMDApp() {

  /*──────────────────────────────────────
      1. CREATE CMD WINDOW
  ───────────────────────────────────────*/
  const win = document.createElement("div");
  win.className = "window";
  win.id = "window-cmd";
  win.dataset.app = "cmd";
  win.dataset.appDesc = "[Win12 CMD] Virtual command console and script runner.";
  win.style.width = "560px";
  win.style.height = "380px";
  win.style.left = "200px";
  win.style.top = "140px";

  win.innerHTML = `
    <div class="window-header" data-drag-handle>
      <div class="window-title">
        <div class="window-title-icon">
          <svg viewBox="0 0 64 64" width="20" height="20">
            <rect x="4" y="4" width="56" height="56" rx="6" fill="#111" stroke="#fff" stroke-width="2"/>
            <text x="16" y="38" font-size="26" fill="#0f0" font-family="monospace">C:</text>
          </svg>
        </div>
        <div class="window-title-text">
          <div class="window-title-main">CMD</div>
          <div class="window-title-sub">Virtual Terminal</div>
        </div>

        <div class="window-fullscreen-toggle">[ ]</div>
        <div class="window-info-icon">(i)</div>
        <div class="window-info-tooltip"></div>
      </div>

      <div class="window-controls">
        <div class="window-btn minimize"><div class="window-btn-icon"></div></div>
        <div class="window-btn close"><div class="window-btn-icon"></div></div>
      </div>
    </div>

    <div class="window-body">
      <div id="cmd-core" style="padding:6px;"></div>
    </div>
  `;

  document.body.appendChild(win);
  windowsMap["cmd"] = win;

  /*──────────────────────────────────────
      2. MAKE WINDOW MOVABLE
  ───────────────────────────────────────*/
  (function enableMove() {
    let isDown = false, startX, startY, startLeft, startTop;

    const header = win.querySelector("[data-drag-handle]");
    header.style.cursor = "grab";

    header.addEventListener("mousedown", e => {
      if (e.target.closest(".window-controls")) return;
      isDown = true;
      startX = e.clientX;
      startY = e.clientY;
      const rect = win.getBoundingClientRect();
      startLeft = rect.left;
      startTop = rect.top;
      bringWindowToFront(win);
    });

    window.addEventListener("mousemove", e => {
      if (!isDown) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      win.style.left = startLeft + dx + "px";
      win.style.top = startTop + dy + "px";
    });

    window.addEventListener("mouseup", () => isDown = false);
  })();


  /*──────────────────────────────────────
      3. MAKE WINDOW RESIZABLE (ALL SIDES)
  ───────────────────────────────────────*/
  win.insertAdjacentHTML("beforeend", `
    <div class="window-resize-handle resize-top"></div>
    <div class="window-resize-handle resize-bottom"></div>
    <div class="window-resize-handle resize-left"></div>
    <div class="window-resize-handle resize-right"></div>
    <div class="window-resize-handle resize-corner resize-tl"></div>
    <div class="window-resize-handle resize-corner resize-tr"></div>
    <div class="window-resize-handle resize-corner resize-bl"></div>
    <div class="window-resize-handle resize-corner resize-br"></div>
  `);

  let resizing = false, dir, sx, sy, sw, sh, sl, st;

  win.querySelectorAll(".window-resize-handle").forEach(h => {
    h.addEventListener("mousedown", e => {
      e.preventDefault();
      resizing = true;
      dir = h.classList[1];
      const rect = win.getBoundingClientRect();
      sx = e.clientX;
      sy = e.clientY;
      sw = rect.width;
      sh = rect.height;
      sl = rect.left;
      st = rect.top;
      bringWindowToFront(win);
    });
  });

  window.addEventListener("mousemove", e => {
    if (!resizing) return;
    let w = sw, h = sh, x = sl, y = st;
    const dx = e.clientX - sx;
    const dy = e.clientY - sy;

    if (dir.includes("right")) w = sw + dx;
    if (dir.includes("left")) { w = sw - dx; x = sl + dx; }
    if (dir.includes("bottom")) h = sh + dy;
    if (dir.includes("top")) { h = sh - dy; y = st + dy; }

    w = Math.max(320, w);
    h = Math.max(240, h);

    win.style.width = w + "px";
    win.style.height = h + "px";
    win.style.left = x + "px";
    win.style.top = y + "px";
  });

  window.addEventListener("mouseup", () => resizing = false);


  /*──────────────────────────────────────
      4. HOOK MINIMIZE + CLOSE + FULLSCREEN
  ───────────────────────────────────────*/
  win.querySelector(".window-btn.close").addEventListener("click", () => {
    win.style.display = "none";
  });

  win.querySelector(".window-btn.minimize").addEventListener("click", () => {
    win.style.display = "none";
  });

  win.querySelector(".window-fullscreen-toggle").addEventListener("click", () => {
    win.classList.toggle("fullscreen");
  });


  /*──────────────────────────────────────
      5. ATTACH MINI CMD ENGINE
  ───────────────────────────────────────*/
  const container = win.querySelector("#cmd-core");
  renderMiniCMD(container, "cmd_main");


  /*──────────────────────────────────────
      6. EXTENDED COMMAND SET
  ───────────────────────────────────────*/
  window.extendCMD = function(cmd) {

    const { print, cwd, currentUser, run } = cmd;

    cmd.commands = {
      ...cmd.commands,

      echo(args) { print(args.join(" ")); },

      clear() { cmd.output.innerHTML = ""; },

      run(args) {
        const filename = args.join(" ");
        const u = currentUser();
        const f = u.fs.find(e => e.path === cwd && e.name === filename);

        if (!f) return print("File not found.", "color:red");
        if (f.ext !== ".cmd" && f.ext !== ".bat")
          return print("Not a .cmd or .bat file.", "color:red");

        runVirtualScript(f.content, print, run);
      },

      fetch(args) {
        fetch(args.join(" "))
          .then(r => r.text())
          .then(t => print(t))
          .catch(() => print("Fetch failed.", "color:red"));
      }
    };
  };


  /*──────────────────────────────────────
      7. START MENU PIN
  ───────────────────────────────────────*/
  const pinnedGrid = document.getElementById("start-pinned-grid");
  if (pinnedGrid && !pinnedGrid.querySelector('[data-app="cmd"]')) {
    const tile = document.createElement("div");
    tile.className = "start-pinned-item";
    tile.dataset.app = "cmd";

    tile.innerHTML = `
      <div class="start-pinned-icon">
        <svg viewBox="0 0 64 64" width="26" height="26">
          <rect x="4" y="4" width="56" height="56" rx="6" fill="#111" stroke="#fff" stroke-width="2"/>
          <text x="16" y="38" font-size="26" fill="#0f0" font-family="monospace">C:</text>
        </svg>
      </div>
      <div class="start-pinned-label">CMD</div>
    `;

    tile.addEventListener("click", () => {
      showWindow("cmd");
      closeStart();
    });

    pinnedGrid.appendChild(tile);
  }

  return win;
}
      /* initial */
      function initialSetup(){
        createFullCMDApp();
        initWidgetsSystem(currentUser);
        initTaskManager();
        createWordApp();
        createRunWindow();
        refreshAll();
        hideLogin();
        showWindow("explorer");
        showWindow("notes");
      }

      initialSetup();

      console.log("%cWin12 AIM FS full ctx relic + Notes + Paint + Media","color:#4c8dff;font-size:14px;font-weight:bold;");
console.log(`%c
■■■■   Win12 AIM OS — Relic Boot
■■■■   FS • Notes • Paint • Media • Explorer • Notepad • Browser • Host.exe • Regedit • Settings • AIM OS • Widgets • Power
■■■■   ───────────────────────────────────────────────────────────────────────────────
■■■■   Loaded modules:
       • Filesystem (AIM FS v3)
       • Window Manager (WM12)
       • Local AI Companion (AIM Core)
       • Canvas Engine (Paint)
       • Media Engine (Video/Audio/Image)
       • Registry Emulator
       • Host.exe Runtime
       • Full Context Menus
       • Win12 UI Shell
       • Session Restore
       • LocalStorage Persistence
       • Boot Rituals + Shrine Mode

       Win12 Simulator ready — AIM engaged.
`, "background:#ff4da6;color:white;font-size:12px;line-height:1.4;padding:12px;border-radius:8px;");

    })();
  </script>
</body>
</html>
